vulnerability_id: VCID-j8zy-6395-aaaq
aliases:
  - CVE-2023-52737
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: lock the inode in shared mode before starting fiemap

  Currently fiemap does not take the inode's lock (VFS lock), it only locks
  a file range in the inode's io tree. This however can lead to a deadlock
  if we have a concurrent fsync on the file and fiemap code triggers a fault
  when accessing the user space buffer with fiemap_fill_next_extent(). The
  deadlock happens on the inode's i_mmap_lock semaphore, which is taken both
  by fsync and btrfs_page_mkwrite(). This deadlock was recently reported by
  syzbot and triggers a trace like the following:

     task:syz-executor361 state:D stack:20264 pid:5668  ppid:5119   flags:0x00004004
     Call Trace:
      <TASK>
      context_switch kernel/sched/core.c:5293 [inline]
      __schedule+0x995/0xe20 kernel/sched/core.c:6606
      schedule+0xcb/0x190 kernel/sched/core.c:6682
      wait_on_state fs/btrfs/extent-io-tree.c:707 [inline]
      wait_extent_bit+0x577/0x6f0 fs/btrfs/extent-io-tree.c:751
      lock_extent+0x1c2/0x280 fs/btrfs/extent-io-tree.c:1742
      find_lock_delalloc_range+0x4e6/0x9c0 fs/btrfs/extent_io.c:488
      writepage_delalloc+0x1ef/0x540 fs/btrfs/extent_io.c:1863
      __extent_writepage+0x736/0x14e0 fs/btrfs/extent_io.c:2174
      extent_write_cache_pages+0x983/0x1220 fs/btrfs/extent_io.c:3091
      extent_writepages+0x219/0x540 fs/btrfs/extent_io.c:3211
      do_writepages+0x3c3/0x680 mm/page-writeback.c:2581
      filemap_fdatawrite_wbc+0x11e/0x170 mm/filemap.c:388
      __filemap_fdatawrite_range mm/filemap.c:421 [inline]
      filemap_fdatawrite_range+0x175/0x200 mm/filemap.c:439
      btrfs_fdatawrite_range fs/btrfs/file.c:3850 [inline]
      start_ordered_ops fs/btrfs/file.c:1737 [inline]
      btrfs_sync_file+0x4ff/0x1190 fs/btrfs/file.c:1839
      generic_write_sync include/linux/fs.h:2885 [inline]
      btrfs_do_write_iter+0xcd3/0x1280 fs/btrfs/file.c:1684
      call_write_iter include/linux/fs.h:2189 [inline]
      new_sync_write fs/read_write.c:491 [inline]
      vfs_write+0x7dc/0xc50 fs/read_write.c:584
      ksys_write+0x177/0x2a0 fs/read_write.c:637
      do_syscall_x64 arch/x86/entry/common.c:50 [inline]
      do_syscall_64+0x3d/0xb0 arch/x86/entry/common.c:80
      entry_SYSCALL_64_after_hwframe+0x63/0xcd
     RIP: 0033:0x7f7d4054e9b9
     RSP: 002b:00007f7d404fa2f8 EFLAGS: 00000246 ORIG_RAX: 0000000000000001
     RAX: ffffffffffffffda RBX: 00007f7d405d87a0 RCX: 00007f7d4054e9b9
     RDX: 0000000000000090 RSI: 0000000020000000 RDI: 0000000000000006
     RBP: 00007f7d405a51d0 R08: 0000000000000000 R09: 0000000000000000
     R10: 0000000000000000 R11: 0000000000000246 R12: 61635f65646f6e69
     R13: 65646f7475616f6e R14: 7261637369646f6e R15: 00007f7d405d87a8
      </TASK>
     INFO: task syz-executor361:5697 blocked for more than 145 seconds.
           Not tainted 6.2.0-rc3-syzkaller-00376-g7c6984405241 #0
     "echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.
     task:syz-executor361 state:D stack:21216 pid:5697  ppid:5119   flags:0x00004004
     Call Trace:
      <TASK>
      context_switch kernel/sched/core.c:5293 [inline]
      __schedule+0x995/0xe20 kernel/sched/core.c:6606
      schedule+0xcb/0x190 kernel/sched/core.c:6682
      rwsem_down_read_slowpath+0x5f9/0x930 kernel/locking/rwsem.c:1095
      __down_read_common+0x54/0x2a0 kernel/locking/rwsem.c:1260
      btrfs_page_mkwrite+0x417/0xc80 fs/btrfs/inode.c:8526
      do_page_mkwrite+0x19e/0x5e0 mm/memory.c:2947
      wp_page_shared+0x15e/0x380 mm/memory.c:3295
      handle_pte_fault mm/memory.c:4949 [inline]
      __handle_mm_fault mm/memory.c:5073 [inline]
      handle_mm_fault+0x1b79/0x26b0 mm/memory.c:5219
      do_user_addr_fault+0x69b/0xcb0 arch/x86/mm/fault.c:1428
      handle_page_fault arch/x86/mm/fault.c:1519 [inline]
      exc_page_fault+0x7a/0x110 arch/x86/mm/fault.c:1575
      asm_exc_page_fault+0x22/0x30 arch/x86/include/asm/idtentry.h:570
     RIP: 0010:copy_user_short_string+0xd/0x40 arch/x86/lib/copy_user_64.S:233
     Code: 74 0a 89 (...)
     RSP: 0018:ffffc9000570f330 EFLAGS: 000502
  ---truncated---
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2023-52737.json
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11227'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11219'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.1122'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11212'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11209'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11217'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11232'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11272'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11291'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11285'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.1121'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11104'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.1105'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10932'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.11287'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10484'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.09902'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10184'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10278'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10302'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10364'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10366'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10377'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10429'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10788'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10843'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10939'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10859'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10875'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12739'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12726'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12684'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12621'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12715'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12699'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12686'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12697'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.1272'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12681'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12643'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12638'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12472'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12497'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '0.00219'
    scoring_system: epss
    scoring_elements: '0.30224'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2023-52737
weaknesses:
  - CWE-667
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2023-52737.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2023-52737
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-52737
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/519b7e13b5ae8dd38da1e52275705343be6bb508
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/d8c594da79bc0244e610a70594e824a401802be1
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2282713
    reference_type:
    reference_id: 2282713
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc6:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc6:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc7:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc7:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-52737
    reference_type:
    reference_id: CVE-2023-52737
