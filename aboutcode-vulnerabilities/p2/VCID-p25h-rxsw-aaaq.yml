vulnerability_id: VCID-p25h-rxsw-aaaq
aliases:
  - CVE-2024-26905
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: fix data races when accessing the reserved amount of block reserves

  At space_info.c we have several places where we access the ->reserved
  field of a block reserve without taking the block reserve's spinlock
  first, which makes KCSAN warn about a data race since that field is
  always updated while holding the spinlock.

  The reports from KCSAN are like the following:

    [117.193526] BUG: KCSAN: data-race in btrfs_block_rsv_release [btrfs] / need_preemptive_reclaim [btrfs]

    [117.195148] read to 0x000000017f587190 of 8 bytes by task 6303 on cpu 3:
    [117.195172]  need_preemptive_reclaim+0x222/0x2f0 [btrfs]
    [117.195992]  __reserve_bytes+0xbb0/0xdc8 [btrfs]
    [117.196807]  btrfs_reserve_metadata_bytes+0x4c/0x120 [btrfs]
    [117.197620]  btrfs_block_rsv_add+0x78/0xa8 [btrfs]
    [117.198434]  btrfs_delayed_update_inode+0x154/0x368 [btrfs]
    [117.199300]  btrfs_update_inode+0x108/0x1c8 [btrfs]
    [117.200122]  btrfs_dirty_inode+0xb4/0x140 [btrfs]
    [117.200937]  btrfs_update_time+0x8c/0xb0 [btrfs]
    [117.201754]  touch_atime+0x16c/0x1e0
    [117.201789]  filemap_read+0x674/0x728
    [117.201823]  btrfs_file_read_iter+0xf8/0x410 [btrfs]
    [117.202653]  vfs_read+0x2b6/0x498
    [117.203454]  ksys_read+0xa2/0x150
    [117.203473]  __s390x_sys_read+0x68/0x88
    [117.203495]  do_syscall+0x1c6/0x210
    [117.203517]  __do_syscall+0xc8/0xf0
    [117.203539]  system_call+0x70/0x98

    [117.203579] write to 0x000000017f587190 of 8 bytes by task 11 on cpu 0:
    [117.203604]  btrfs_block_rsv_release+0x2e8/0x578 [btrfs]
    [117.204432]  btrfs_delayed_inode_release_metadata+0x7c/0x1d0 [btrfs]
    [117.205259]  __btrfs_update_delayed_inode+0x37c/0x5e0 [btrfs]
    [117.206093]  btrfs_async_run_delayed_root+0x356/0x498 [btrfs]
    [117.206917]  btrfs_work_helper+0x160/0x7a0 [btrfs]
    [117.207738]  process_one_work+0x3b6/0x838
    [117.207768]  worker_thread+0x75e/0xb10
    [117.207797]  kthread+0x21a/0x230
    [117.207830]  __ret_from_fork+0x6c/0xb8
    [117.207861]  ret_from_fork+0xa/0x30

  So add a helper to get the reserved amount of a block reserve while
  holding the lock. The value may be not be up to date anymore when used by
  need_preemptive_reclaim() and btrfs_preempt_reclaim_metadata_space(), but
  that's ok since the worst it can do is cause more reclaim work do be done
  sooner rather than later. Reading the field while holding the lock instead
  of using the data_race() annotation is used in order to prevent load
  tearing.
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-26905.json
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.09902'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10184'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10278'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10302'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10364'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10366'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10377'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10429'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10484'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10788'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10843'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10939'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10859'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10875'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10932'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.11287'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
weaknesses:
  - CWE-362
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-26905.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-26905
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-26905
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/82220b1835baaebf4ae2e490f56353a341a09bd2
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/995e91c9556c8fc6028b474145a36e947d1eb6b6
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c44542093525699a30c307dae1ea5a1b03b3302f
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/e06cc89475eddc1f3a7a4d471524256152c68166
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2275637
    reference_type:
    reference_id: 2275637
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-26905
    reference_type:
    reference_id: CVE-2024-26905
