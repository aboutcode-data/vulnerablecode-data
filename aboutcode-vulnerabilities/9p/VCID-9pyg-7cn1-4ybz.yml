vulnerability_id: VCID-9pyg-7cn1-4ybz
aliases:
  - CVE-2024-52294
  - GHSA-hq4h-w933-jm6c
summary: "khoj has an IDOR in subscription management allows unauthorized subscription modifications\n\
  ### Summary\nAn Insecure Direct Object Reference (IDOR) vulnerability in the update_subscription\
  \ endpoint allows any authenticated user to manipulate other users' Stripe subscriptions by\
  \ simply modifying the email parameter in the request.\n\n### Details\nThe vulnerability exists\
  \ in the subscription endpoint at `/api/subscription`. The endpoint uses an email parameter\
  \ as a direct reference to user subscriptions without verifying object ownership. While authentication\
  \ is required, there is no authorization check to verify if the authenticated user owns the\
  \ referenced subscription.\n\nVulnerable code in `/api/subscription`:\n```python\n@subscription_router.patch(\"\
  \")\n@requires([\"authenticated\"])\nasync def update_subscription(request: Request, email:\
  \ str, operation: str):\n    # IDOR: email parameter directly references user subscriptions\
  \ without ownership verification\n    customers = stripe.Customer.list(email=email).auto_paging_iter()\n\
  \    customer = next(customers, None)\n    \n    if operation == \"cancel\":\n        # Any\
  \ authenticated user can modify any subscription referenced by email\n        customer_id\
  \ = customer.id\n        for subscription in stripe.Subscription.list(customer=customer_id):\n\
  \            stripe.Subscription.modify(subscription.id, cancel_at_period_end=True)\n```\n\
  \n### PoC\n1. Create a customer account in stripe:\n   - Customer A: `adventure8812@zeropath.com`\
  \ (attacker)\n\n2. Log in as any user.\n\n3. Send this request:\n```http\nPATCH /api/subscription?email=adventure8812@zeropath.com&operation=cancel\
  \ HTTP/1.1\n```\n\n4. The subscription for Customer A is successfully set to cancel.\n\n###\
  \ Impact\nHigh:\nRevenue loss via mass cancellation of subscriptions.\nLoss of customer trust\
  \ by re-enabling subscriptions they had set to cancel.\n\n### Resolution\n\nThis was fixed\
  \ in the following commit which limited subscription update operations to the authenticated\
  \ user: https://github.com/khoj-ai/khoj/commit/47d3c8c23597900af708bdc60aced3ae5d2064c1. Support\
  \ for arbitrarily presenting an email for update has been deprecated."
severities:
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.06519'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.11287'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.21559'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18101'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.21391'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.21456'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.21504'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.21562'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.21551'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.21534'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.21525'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.2152'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.21535'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.2154'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.2156'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17992'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17957'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18105'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18125'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18151'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18167'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18141'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18128'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18134'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.1815'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18186'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18184'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18156'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.1813'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
  - score: MODERATE
    scoring_system: cvssv3.1_qr
    scoring_elements:
    published_at: None
    url: https://github.com/advisories/GHSA-hq4h-w933-jm6c
  - score: '4.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N
    published_at: None
    url: https://github.com/khoj-ai/khoj
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/khoj-ai/khoj
  - score: '4.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N
    published_at: None
    url: https://github.com/khoj-ai/khoj/commit/47d3c8c23597900af708bdc60aced3ae5d2064c1
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/khoj-ai/khoj/commit/47d3c8c23597900af708bdc60aced3ae5d2064c1
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:P/A:N/T:P/P:M/B:A/M:M/D:T/2024-12-30T16:52:16Z/
    published_at: None
    url: https://github.com/khoj-ai/khoj/commit/47d3c8c23597900af708bdc60aced3ae5d2064c1
  - score: '4.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N
    published_at: None
    url: https://github.com/khoj-ai/khoj/security/advisories/GHSA-hq4h-w933-jm6c
  - score: MODERATE
    scoring_system: cvssv3.1_qr
    scoring_elements:
    published_at: None
    url: https://github.com/khoj-ai/khoj/security/advisories/GHSA-hq4h-w933-jm6c
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/khoj-ai/khoj/security/advisories/GHSA-hq4h-w933-jm6c
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:P/A:N/T:P/P:M/B:A/M:M/D:T/2024-12-30T16:52:16Z/
    published_at: None
    url: https://github.com/khoj-ai/khoj/security/advisories/GHSA-hq4h-w933-jm6c
  - score: '4.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-52294
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-52294
weaknesses:
  - CWE-937
  - CWE-1035
  - CWE-639
references:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-52294
    reference_type:
    reference_id:
  - url: https://github.com/khoj-ai/khoj
    reference_type:
    reference_id:
  - url: https://github.com/khoj-ai/khoj/commit/47d3c8c23597900af708bdc60aced3ae5d2064c1
    reference_type:
    reference_id:
  - url: https://github.com/khoj-ai/khoj/security/advisories/GHSA-hq4h-w933-jm6c
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-52294
    reference_type:
    reference_id:
  - url: https://github.com/advisories/GHSA-hq4h-w933-jm6c
    reference_type:
    reference_id: GHSA-hq4h-w933-jm6c
