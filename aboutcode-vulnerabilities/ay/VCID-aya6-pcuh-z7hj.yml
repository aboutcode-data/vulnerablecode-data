vulnerability_id: VCID-aya6-pcuh-z7hj
aliases:
  - CVE-2024-43891
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  tracing: Have format file honor EVENT_FILE_FL_FREED

  When eventfs was introduced, special care had to be done to coordinate the
  freeing of the file meta data with the files that are exposed to user
  space. The file meta data would have a ref count that is set when the file
  is created and would be decremented and freed after the last user that
  opened the file closed it. When the file meta data was to be freed, it
  would set a flag (EVENT_FILE_FL_FREED) to denote that the file is freed,
  and any new references made (like new opens or reads) would fail as it is
  marked freed. This allowed other meta data to be freed after this flag was
  set (under the event_mutex).

  All the files that were dynamically created in the events directory had a
  pointer to the file meta data and would call event_release() when the last
  reference to the user space file was closed. This would be the time that it
  is safe to free the file meta data.

  A shortcut was made for the "format" file. It's i_private would point to
  the "call" entry directly and not point to the file's meta data. This is
  because all format files are the same for the same "call", so it was
  thought there was no reason to differentiate them.  The other files
  maintain state (like the "enable", "trigger", etc). But this meant if the
  file were to disappear, the "format" file would be unaware of it.

  This caused a race that could be trigger via the user_events test (that
  would create dynamic events and free them), and running a loop that would
  read the user_events format files:

  In one console run:

   # cd tools/testing/selftests/user_events
   # while true; do ./ftrace_test; done

  And in another console run:

   # cd /sys/kernel/tracing/
   # while true; do cat events/user_events/__test_event/format; done 2>/dev/null

  With KASAN memory checking, it would trigger a use-after-free bug report
  (which was a real bug). This was because the format file was not checking
  the file's meta data flag "EVENT_FILE_FL_FREED", so it would access the
  event that the file meta data pointed to after the event was freed.

  After inspection, there are other locations that were found to not check
  the EVENT_FILE_FL_FREED flag when accessing the trace_event_file. Add a
  new helper function: event_file_file() that will make sure that the
  event_mutex is held, and will return NULL if the trace_event_file has the
  EVENT_FILE_FL_FREED flag set. Have the first reference of the struct file
  pointer use event_file_file() and check for NULL. Later uses can still use
  the event_file_data() helper function if the event_mutex is still held and
  was not released since the event_file_file() call.
severities:
  - score: '4.1'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-43891.json
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.09181'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.09251'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.09245'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.09235'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.09242'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.09295'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.09312'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.09371'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.0939'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.09409'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.09343'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.09236'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00036'
    scoring_system: epss
    scoring_elements: '0.09189'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05091'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05128'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05124'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05115'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05119'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05108'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05105'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05100'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05073'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05065'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05058'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17983'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18018'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18017'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17991'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.1796'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17929'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17964'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17962'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17973'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.18001'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17984'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17954'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17932'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17785'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00068'
    scoring_system: epss
    scoring_elements: '0.17822'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '0.00286'
    scoring_system: epss
    scoring_elements: '0.35869'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
  - score: '6.4'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '4.7'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-43891
  - score: '4.7'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-43891
weaknesses:
  - CWE-416
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-43891.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-43891
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/4ed03758ddf0b19d69eed69386d65a92d0091e0c
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/531dc6780d94245af037c25c2371c8caf652f0f9
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b1560408692cd0ab0370cfbe9deb03ce97ab3f6d
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2307864
    reference_type:
    reference_id: 2307864
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.11:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.11:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.11:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.11:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-43891
    reference_type:
    reference_id: CVE-2024-43891
  - url: https://usn.ubuntu.com/7154-1/
    reference_type:
    reference_id: USN-7154-1
  - url: https://usn.ubuntu.com/7154-2/
    reference_type:
    reference_id: USN-7154-2
  - url: https://usn.ubuntu.com/7155-1/
    reference_type:
    reference_id: USN-7155-1
  - url: https://usn.ubuntu.com/7156-1/
    reference_type:
    reference_id: USN-7156-1
  - url: https://usn.ubuntu.com/7196-1/
    reference_type:
    reference_id: USN-7196-1
