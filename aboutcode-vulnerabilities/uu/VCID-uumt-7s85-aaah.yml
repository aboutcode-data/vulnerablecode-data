vulnerability_id: VCID-uumt-7s85-aaah
aliases:
  - CVE-2021-47038
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  Bluetooth: avoid deadlock between hci_dev->lock and socket lock

  Commit eab2404ba798 ("Bluetooth: Add BT_PHY socket option") added a
  dependency between socket lock and hci_dev->lock that could lead to
  deadlock.

  It turns out that hci_conn_get_phy() is not in any way relying on hdev
  being immutable during the runtime of this function, neither does it even
  look at any of the members of hdev, and as such there is no need to hold
  that lock.

  This fixes the lockdep splat below:

   ======================================================
   WARNING: possible circular locking dependency detected
   5.12.0-rc1-00026-g73d464503354 #10 Not tainted
   ------------------------------------------------------
   bluetoothd/1118 is trying to acquire lock:
   ffff8f078383c078 (&hdev->lock){+.+.}-{3:3}, at: hci_conn_get_phy+0x1c/0x150 [bluetooth]

   but task is already holding lock:
   ffff8f07e831d920 (sk_lock-AF_BLUETOOTH-BTPROTO_L2CAP){+.+.}-{0:0}, at: l2cap_sock_getsockopt+0x8b/0x610

   which lock already depends on the new lock.

   the existing dependency chain (in reverse order) is:

   -> #3 (sk_lock-AF_BLUETOOTH-BTPROTO_L2CAP){+.+.}-{0:0}:
          lock_sock_nested+0x72/0xa0
          l2cap_sock_ready_cb+0x18/0x70 [bluetooth]
          l2cap_config_rsp+0x27a/0x520 [bluetooth]
          l2cap_sig_channel+0x658/0x1330 [bluetooth]
          l2cap_recv_frame+0x1ba/0x310 [bluetooth]
          hci_rx_work+0x1cc/0x640 [bluetooth]
          process_one_work+0x244/0x5f0
          worker_thread+0x3c/0x380
          kthread+0x13e/0x160
          ret_from_fork+0x22/0x30

   -> #2 (&chan->lock#2/1){+.+.}-{3:3}:
          __mutex_lock+0xa3/0xa10
          l2cap_chan_connect+0x33a/0x940 [bluetooth]
          l2cap_sock_connect+0x141/0x2a0 [bluetooth]
          __sys_connect+0x9b/0xc0
          __x64_sys_connect+0x16/0x20
          do_syscall_64+0x33/0x80
          entry_SYSCALL_64_after_hwframe+0x44/0xae

   -> #1 (&conn->chan_lock){+.+.}-{3:3}:
          __mutex_lock+0xa3/0xa10
          l2cap_chan_connect+0x322/0x940 [bluetooth]
          l2cap_sock_connect+0x141/0x2a0 [bluetooth]
          __sys_connect+0x9b/0xc0
          __x64_sys_connect+0x16/0x20
          do_syscall_64+0x33/0x80
          entry_SYSCALL_64_after_hwframe+0x44/0xae

   -> #0 (&hdev->lock){+.+.}-{3:3}:
          __lock_acquire+0x147a/0x1a50
          lock_acquire+0x277/0x3d0
          __mutex_lock+0xa3/0xa10
          hci_conn_get_phy+0x1c/0x150 [bluetooth]
          l2cap_sock_getsockopt+0x5a9/0x610 [bluetooth]
          __sys_getsockopt+0xcc/0x200
          __x64_sys_getsockopt+0x20/0x30
          do_syscall_64+0x33/0x80
          entry_SYSCALL_64_after_hwframe+0x44/0xae

   other info that might help us debug this:

   Chain exists of:
     &hdev->lock --> &chan->lock#2/1 --> sk_lock-AF_BLUETOOTH-BTPROTO_L2CAP

    Possible unsafe locking scenario:

          CPU0                    CPU1
          ----                    ----
     lock(sk_lock-AF_BLUETOOTH-BTPROTO_L2CAP);
                                  lock(&chan->lock#2/1);
                                  lock(sk_lock-AF_BLUETOOTH-BTPROTO_L2CAP);
     lock(&hdev->lock);

    *** DEADLOCK ***

   1 lock held by bluetoothd/1118:
    #0: ffff8f07e831d920 (sk_lock-AF_BLUETOOTH-BTPROTO_L2CAP){+.+.}-{0:0}, at: l2cap_sock_getsockopt+0x8b/0x610 [bluetooth]

   stack backtrace:
   CPU: 3 PID: 1118 Comm: bluetoothd Not tainted 5.12.0-rc1-00026-g73d464503354 #10
   Hardware name: LENOVO 20K5S22R00/20K5S22R00, BIOS R0IET38W (1.16 ) 05/31/2017
   Call Trace:
    dump_stack+0x7f/0xa1
    check_noncircular+0x105/0x120
    ? __lock_acquire+0x147a/0x1a50
    __lock_acquire+0x147a/0x1a50
    lock_acquire+0x277/0x3d0
    ? hci_conn_get_phy+0x1c/0x150 [bluetooth]
    ? __lock_acquire+0x2e1/0x1a50
    ? lock_is_held_type+0xb4/0x120
    ? hci_conn_get_phy+0x1c/0x150 [bluetooth]
    __mutex_lock+0xa3/0xa10
    ? hci_conn_get_phy+0x1c/0x150 [bluetooth]
    ? lock_acquire+0x277/0x3d0
    ? mark_held_locks+0x49/0x70
    ? mark_held_locks+0x49/0x70
    ? hci_conn_get_phy+0x1c/0x150 [bluetooth]
    hci_conn_get_phy+0x
  ---truncated---
severities:
  - score: '5.7'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:A/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2021-47038.json
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.01051'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.01055'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.0104'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.01038'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.01046'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.0105'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.01062'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.01057'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.01061'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.01065'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.01053'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.00773'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.00771'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.00783'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.0078'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.00776'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.01044'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00012'
    scoring_system: epss
    scoring_elements: '0.00775'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.08123'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.07986'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.07964'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.08139'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.08151'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.0818'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.08181'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16666'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17147'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17069'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17041'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16947'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17830'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17732'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17645'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17329'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17226'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17164'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17142'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '0.00158'
    scoring_system: epss
    scoring_elements: '0.23748'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
  - score: '5.7'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:A/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-47038
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-47038
weaknesses:
  - CWE-667
  - CWE-833
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2021-47038.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2021-47038
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-47038
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/17486960d79b900c45e0bb8fbcac0262848582ba
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/332e69eb3bd90370f2d9f2c2ca7974ff523dea17
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/7cc0ba67883c6c8d3bddb283f56c167fc837a555
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/fee71f480bc1dec5f6ae3b0b185ff12a62bceabc
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2266998
    reference_type:
    reference_id: 2266998
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-47038
    reference_type:
    reference_id: CVE-2021-47038
