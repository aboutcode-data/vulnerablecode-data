vulnerability_id: VCID-1f1q-e9dz-4ubb
aliases:
  - CVE-2022-49007
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  nilfs2: fix NULL pointer dereference in nilfs_palloc_commit_free_entry()

  Syzbot reported a null-ptr-deref bug:

   NILFS (loop0): segctord starting. Construction interval = 5 seconds, CP
   frequency < 30 seconds
   general protection fault, probably for non-canonical address
   0xdffffc0000000002: 0000 [#1] PREEMPT SMP KASAN
   KASAN: null-ptr-deref in range [0x0000000000000010-0x0000000000000017]
   CPU: 1 PID: 3603 Comm: segctord Not tainted
   6.1.0-rc2-syzkaller-00105-gb229b6ca5abb #0
   Hardware name: Google Compute Engine/Google Compute Engine, BIOS Google
   10/11/2022
   RIP: 0010:nilfs_palloc_commit_free_entry+0xe5/0x6b0
   fs/nilfs2/alloc.c:608
   Code: 00 00 00 00 fc ff df 80 3c 02 00 0f 85 cd 05 00 00 48 b8 00 00 00
   00 00 fc ff df 4c 8b 73 08 49 8d 7e 10 48 89 fa 48 c1 ea 03 <80> 3c 02
   00 0f 85 26 05 00 00 49 8b 46 10 be a6 00 00 00 48 c7 c7
   RSP: 0018:ffffc90003dff830 EFLAGS: 00010212
   RAX: dffffc0000000000 RBX: ffff88802594e218 RCX: 000000000000000d
   RDX: 0000000000000002 RSI: 0000000000002000 RDI: 0000000000000010
   RBP: ffff888071880222 R08: 0000000000000005 R09: 000000000000003f
   R10: 000000000000000d R11: 0000000000000000 R12: ffff888071880158
   R13: ffff88802594e220 R14: 0000000000000000 R15: 0000000000000004
   FS:  0000000000000000(0000) GS:ffff8880b9b00000(0000)
   knlGS:0000000000000000
   CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
   CR2: 00007fb1c08316a8 CR3: 0000000018560000 CR4: 0000000000350ee0
   Call Trace:
    <TASK>
    nilfs_dat_commit_free fs/nilfs2/dat.c:114 [inline]
    nilfs_dat_commit_end+0x464/0x5f0 fs/nilfs2/dat.c:193
    nilfs_dat_commit_update+0x26/0x40 fs/nilfs2/dat.c:236
    nilfs_btree_commit_update_v+0x87/0x4a0 fs/nilfs2/btree.c:1940
    nilfs_btree_commit_propagate_v fs/nilfs2/btree.c:2016 [inline]
    nilfs_btree_propagate_v fs/nilfs2/btree.c:2046 [inline]
    nilfs_btree_propagate+0xa00/0xd60 fs/nilfs2/btree.c:2088
    nilfs_bmap_propagate+0x73/0x170 fs/nilfs2/bmap.c:337
    nilfs_collect_file_data+0x45/0xd0 fs/nilfs2/segment.c:568
    nilfs_segctor_apply_buffers+0x14a/0x470 fs/nilfs2/segment.c:1018
    nilfs_segctor_scan_file+0x3f4/0x6f0 fs/nilfs2/segment.c:1067
    nilfs_segctor_collect_blocks fs/nilfs2/segment.c:1197 [inline]
    nilfs_segctor_collect fs/nilfs2/segment.c:1503 [inline]
    nilfs_segctor_do_construct+0x12fc/0x6af0 fs/nilfs2/segment.c:2045
    nilfs_segctor_construct+0x8e3/0xb30 fs/nilfs2/segment.c:2379
    nilfs_segctor_thread_construct fs/nilfs2/segment.c:2487 [inline]
    nilfs_segctor_thread+0x3c3/0xf30 fs/nilfs2/segment.c:2570
    kthread+0x2e4/0x3a0 kernel/kthread.c:376
    ret_from_fork+0x1f/0x30 arch/x86/entry/entry_64.S:306
    </TASK>
   ...

  If DAT metadata file is corrupted on disk, there is a case where
  req->pr_desc_bh is NULL and blocknr is 0 at nilfs_dat_commit_end() during
  a b-tree operation that cascadingly updates ancestor nodes of the b-tree,
  because nilfs_dat_commit_alloc() for a lower level block can initialize
  the blocknr on the same DAT entry between nilfs_dat_prepare_end() and
  nilfs_dat_commit_end().

  If this happens, nilfs_dat_commit_end() calls nilfs_dat_commit_free()
  without valid buffer heads in req->pr_desc_bh and req->pr_bitmap_bh, and
  causes the NULL pointer dereference above in
  nilfs_palloc_commit_free_entry() function, which leads to a crash.

  Fix this by adding a NULL check on req->pr_desc_bh and req->pr_bitmap_bh
  before nilfs_palloc_commit_free_entry() in nilfs_dat_commit_free().

  This also calls nilfs_error() in that case to notify that there is a fatal
  flaw in the filesystem metadata and prevent further operations.
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2022-49007.json
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.05833'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.10989'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.08639'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.08616'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.08599'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.08566'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.1086'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.10907'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11009'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11084'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11093'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11077'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11043'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.1103'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11021'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11018'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11027'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.11034'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.1101'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.08491'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.08473'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.08612'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.08634'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.08605'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.08633'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.08627'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.0863'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.08649'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00039'
    scoring_system: epss
    scoring_elements: '0.0867'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05124'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05115'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05119'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05108'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05105'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05100'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05091'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05073'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05065'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05058'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05128'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2022-49007
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2022-49007
weaknesses:
  - CWE-476
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2022-49007.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2022-49007
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-49007
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/165c7a3b27a3857ebf57f626b9f38b48b6792e68
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/2f2c59506ae39496588ceb8b88bdbdbaed895d63
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/33021419fd81efd3d729a7f19341ba4b98fe66ce
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/381b84f60e549ea98cec4666c6c728b1b3318756
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/9a130b72e6bd1fb07fc3cde839dc6fb53da76f07
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/bc3fd3293887b4cf84a9109700faeb82de533c89
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/e858917ab785afe83c14f5ac141301216ccda847
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2320740
    reference_type:
    reference_id: 2320740
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.1:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.1:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.1:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.1:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.1:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.1:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.1:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.1:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.1:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.1:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.1:rc6:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.1:rc6:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.1:rc7:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.1:rc7:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-49007
    reference_type:
    reference_id: CVE-2022-49007
