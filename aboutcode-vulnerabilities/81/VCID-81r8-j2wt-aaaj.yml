vulnerability_id: VCID-81r8-j2wt-aaaj
aliases:
  - CVE-2022-48802
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  fs/proc: task_mmu.c: don't read mapcount for migration entry

  The syzbot reported the below BUG:

    kernel BUG at include/linux/page-flags.h:785!
    invalid opcode: 0000 [#1] PREEMPT SMP KASAN
    CPU: 1 PID: 4392 Comm: syz-executor560 Not tainted 5.16.0-rc6-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    RIP: 0010:PageDoubleMap include/linux/page-flags.h:785 [inline]
    RIP: 0010:__page_mapcount+0x2d2/0x350 mm/util.c:744
    Call Trace:
      page_mapcount include/linux/mm.h:837 [inline]
      smaps_account+0x470/0xb10 fs/proc/task_mmu.c:466
      smaps_pte_entry fs/proc/task_mmu.c:538 [inline]
      smaps_pte_range+0x611/0x1250 fs/proc/task_mmu.c:601
      walk_pmd_range mm/pagewalk.c:128 [inline]
      walk_pud_range mm/pagewalk.c:205 [inline]
      walk_p4d_range mm/pagewalk.c:240 [inline]
      walk_pgd_range mm/pagewalk.c:277 [inline]
      __walk_page_range+0xe23/0x1ea0 mm/pagewalk.c:379
      walk_page_vma+0x277/0x350 mm/pagewalk.c:530
      smap_gather_stats.part.0+0x148/0x260 fs/proc/task_mmu.c:768
      smap_gather_stats fs/proc/task_mmu.c:741 [inline]
      show_smap+0xc6/0x440 fs/proc/task_mmu.c:822
      seq_read_iter+0xbb0/0x1240 fs/seq_file.c:272
      seq_read+0x3e0/0x5b0 fs/seq_file.c:162
      vfs_read+0x1b5/0x600 fs/read_write.c:479
      ksys_read+0x12d/0x250 fs/read_write.c:619
      do_syscall_x64 arch/x86/entry/common.c:50 [inline]
      do_syscall_64+0x35/0xb0 arch/x86/entry/common.c:80
      entry_SYSCALL_64_after_hwframe+0x44/0xae

  The reproducer was trying to read /proc/$PID/smaps when calling
  MADV_FREE at the mean time.  MADV_FREE may split THPs if it is called
  for partial THP.  It may trigger the below race:

             CPU A                         CPU B
             -----                         -----
    smaps walk:                      MADV_FREE:
    page_mapcount()
      PageCompound()
                                     split_huge_page()
      page = compound_head(page)
      PageDoubleMap(page)

  When calling PageDoubleMap() this page is not a tail page of THP anymore
  so the BUG is triggered.

  This could be fixed by elevated refcount of the page before calling
  mapcount, but that would prevent it from counting migration entries, and
  it seems overkilling because the race just could happen when PMD is
  split so all PTE entries of tail pages are actually migration entries,
  and smaps_account() does treat migration entries as mapcount == 1 as
  Kirill pointed out.

  Add a new parameter for smaps_account() to tell this entry is migration
  entry then skip calling page_mapcount().  Don't skip getting mapcount
  for device private entries since they do track references with mapcount.

  Pagemap also has the similar issue although it was not reported.  Fixed
  it as well.

  [shy828301@gmail.com: v4]
    Link: https://lkml.kernel.org/r/20220203182641.824731-1-shy828301@gmail.com
  [nathan@kernel.org: avoid unused variable warning in pagemap_pmd_range()]
    Link: https://lkml.kernel.org/r/20220207171049.1102239-1-nathan@kernel.org
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2022-48802.json
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16666'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16947'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17041'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17069'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17147'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17142'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17164'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17226'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17329'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17645'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17732'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17830'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17350'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17315'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17624'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17338'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.15229'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.15187'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00062'
    scoring_system: epss
    scoring_elements: '0.16475'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00062'
    scoring_system: epss
    scoring_elements: '0.16455'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00062'
    scoring_system: epss
    scoring_elements: '0.16473'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00062'
    scoring_system: epss
    scoring_elements: '0.16498'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00062'
    scoring_system: epss
    scoring_elements: '0.16523'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00062'
    scoring_system: epss
    scoring_elements: '0.16492'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00062'
    scoring_system: epss
    scoring_elements: '0.1648'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00062'
    scoring_system: epss
    scoring_elements: '0.16458'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00062'
    scoring_system: epss
    scoring_elements: '0.16509'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.21826'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.21821'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.18422'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.18394'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.18369'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.18336'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.21662'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.21727'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.21771'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.21828'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.21809'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.21831'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.21819'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.21801'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.21792'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00069'
    scoring_system: epss
    scoring_elements: '0.21787'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '0.00247'
    scoring_system: epss
    scoring_elements: '0.32567'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
weaknesses: []
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2022-48802.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2022-48802
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-48802
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/05d3f8045efa59457b323caf00bdb9273b7962fa
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/24d7275ce2791829953ed4e72f68277ceb2571c6
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a8dd0cfa37792863b6c4bf9542975212a6715d49
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/db3f3636e4aed2cba3e4e7897a053323f7a62249
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2298138
    reference_type:
    reference_id: 2298138
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-48802
    reference_type:
    reference_id: CVE-2022-48802
