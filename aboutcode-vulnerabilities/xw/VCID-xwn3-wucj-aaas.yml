vulnerability_id: VCID-xwn3-wucj-aaas
aliases:
  - CVE-2024-26792
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: fix double free of anonymous device after snapshot creation failure

  When creating a snapshot we may do a double free of an anonymous device
  in case there's an error committing the transaction. The second free may
  result in freeing an anonymous device number that was allocated by some
  other subsystem in the kernel or another btrfs filesystem.

  The steps that lead to this:

  1) At ioctl.c:create_snapshot() we allocate an anonymous device number
     and assign it to pending_snapshot->anon_dev;

  2) Then we call btrfs_commit_transaction() and end up at
     transaction.c:create_pending_snapshot();

  3) There we call btrfs_get_new_fs_root() and pass it the anonymous device
     number stored in pending_snapshot->anon_dev;

  4) btrfs_get_new_fs_root() frees that anonymous device number because
     btrfs_lookup_fs_root() returned a root - someone else did a lookup
     of the new root already, which could some task doing backref walking;

  5) After that some error happens in the transaction commit path, and at
     ioctl.c:create_snapshot() we jump to the 'fail' label, and after
     that we free again the same anonymous device number, which in the
     meanwhile may have been reallocated somewhere else, because
     pending_snapshot->anon_dev still has the same value as in step 1.

  Recently syzbot ran into this and reported the following trace:

    ------------[ cut here ]------------
    ida_free called for id=51 which is not allocated.
    WARNING: CPU: 1 PID: 31038 at lib/idr.c:525 ida_free+0x370/0x420 lib/idr.c:525
    Modules linked in:
    CPU: 1 PID: 31038 Comm: syz-executor.2 Not tainted 6.8.0-rc4-syzkaller-00410-gc02197fc9076 #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/25/2024
    RIP: 0010:ida_free+0x370/0x420 lib/idr.c:525
    Code: 10 42 80 3c 28 (...)
    RSP: 0018:ffffc90015a67300 EFLAGS: 00010246
    RAX: be5130472f5dd000 RBX: 0000000000000033 RCX: 0000000000040000
    RDX: ffffc90009a7a000 RSI: 000000000003ffff RDI: 0000000000040000
    RBP: ffffc90015a673f0 R08: ffffffff81577992 R09: 1ffff92002b4cdb4
    R10: dffffc0000000000 R11: fffff52002b4cdb5 R12: 0000000000000246
    R13: dffffc0000000000 R14: ffffffff8e256b80 R15: 0000000000000246
    FS:  00007fca3f4b46c0(0000) GS:ffff8880b9500000(0000) knlGS:0000000000000000
    CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    CR2: 00007f167a17b978 CR3: 000000001ed26000 CR4: 0000000000350ef0
    Call Trace:
     <TASK>
     btrfs_get_root_ref+0xa48/0xaf0 fs/btrfs/disk-io.c:1346
     create_pending_snapshot+0xff2/0x2bc0 fs/btrfs/transaction.c:1837
     create_pending_snapshots+0x195/0x1d0 fs/btrfs/transaction.c:1931
     btrfs_commit_transaction+0xf1c/0x3740 fs/btrfs/transaction.c:2404
     create_snapshot+0x507/0x880 fs/btrfs/ioctl.c:848
     btrfs_mksubvol+0x5d0/0x750 fs/btrfs/ioctl.c:998
     btrfs_mksnapshot+0xb5/0xf0 fs/btrfs/ioctl.c:1044
     __btrfs_ioctl_snap_create+0x387/0x4b0 fs/btrfs/ioctl.c:1306
     btrfs_ioctl_snap_create_v2+0x1ca/0x400 fs/btrfs/ioctl.c:1393
     btrfs_ioctl+0xa74/0xd40
     vfs_ioctl fs/ioctl.c:51 [inline]
     __do_sys_ioctl fs/ioctl.c:871 [inline]
     __se_sys_ioctl+0xfe/0x170 fs/ioctl.c:857
     do_syscall_64+0xfb/0x240
     entry_SYSCALL_64_after_hwframe+0x6f/0x77
    RIP: 0033:0x7fca3e67dda9
    Code: 28 00 00 00 (...)
    RSP: 002b:00007fca3f4b40c8 EFLAGS: 00000246 ORIG_RAX: 0000000000000010
    RAX: ffffffffffffffda RBX: 00007fca3e7abf80 RCX: 00007fca3e67dda9
    RDX: 00000000200005c0 RSI: 0000000050009417 RDI: 0000000000000003
    RBP: 00007fca3e6ca47a R08: 0000000000000000 R09: 0000000000000000
    R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
    R13: 000000000000000b R14: 00007fca3e7abf80 R15: 00007fff6bf95658
     </TASK>

  Where we get an explicit message where we attempt to free an anonymous
  device number that is not currently allocated. It happens in a different
  code path from the example below, at btrfs_get_root_ref(), so this change
  may not fix the case triggered by sy
  ---truncated---
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-26792.json
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16947'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17041'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17069'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17147'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17142'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17164'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17226'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17329'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17645'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17732'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17830'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17350'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17315'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16666'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15567'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15365'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15433'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15527'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15604'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15608'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15585'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15562'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15551'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15557'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15571'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15591'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15595'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.23962'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.24023'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.2401'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.23967'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.23951'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.23923'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.24026'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.23979'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.23945'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.23989'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.23901'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.23837'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.23988'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.24013'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00094'
    scoring_system: epss
    scoring_elements: '0.2402'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '0.00398'
    scoring_system: epss
    scoring_elements: '0.43714'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '7.8'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-26792
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-26792
weaknesses:
  - CWE-415
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-26792.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-26792
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-26792
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c34adc20b91a8e55e048b18d63f4f4ae003ecf8f
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/e2b54eaf28df0c978626c9736b94f003b523b451
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/eb3441093aad251418921246fc3b224fd1575701
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2273446
    reference_type:
    reference_id: 2273446
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-26792
    reference_type:
    reference_id: CVE-2024-26792
  - url: https://usn.ubuntu.com/6820-1/
    reference_type:
    reference_id: USN-6820-1
  - url: https://usn.ubuntu.com/6820-2/
    reference_type:
    reference_id: USN-6820-2
  - url: https://usn.ubuntu.com/6821-1/
    reference_type:
    reference_id: USN-6821-1
  - url: https://usn.ubuntu.com/6821-2/
    reference_type:
    reference_id: USN-6821-2
  - url: https://usn.ubuntu.com/6821-3/
    reference_type:
    reference_id: USN-6821-3
  - url: https://usn.ubuntu.com/6821-4/
    reference_type:
    reference_id: USN-6821-4
  - url: https://usn.ubuntu.com/6828-1/
    reference_type:
    reference_id: USN-6828-1
  - url: https://usn.ubuntu.com/6871-1/
    reference_type:
    reference_id: USN-6871-1
  - url: https://usn.ubuntu.com/6892-1/
    reference_type:
    reference_id: USN-6892-1
  - url: https://usn.ubuntu.com/6895-1/
    reference_type:
    reference_id: USN-6895-1
  - url: https://usn.ubuntu.com/6895-2/
    reference_type:
    reference_id: USN-6895-2
  - url: https://usn.ubuntu.com/6895-3/
    reference_type:
    reference_id: USN-6895-3
  - url: https://usn.ubuntu.com/6895-4/
    reference_type:
    reference_id: USN-6895-4
  - url: https://usn.ubuntu.com/6900-1/
    reference_type:
    reference_id: USN-6900-1
  - url: https://usn.ubuntu.com/6919-1/
    reference_type:
    reference_id: USN-6919-1
