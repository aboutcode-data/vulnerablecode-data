vulnerability_id: VCID-6hc8-xq3b-uqfc
aliases:
  - CVE-2025-38358
summary: "In the Linux kernel, the following vulnerability has been resolved:\n\nbtrfs: fix\
  \ race between async reclaim worker and close_ctree()\n\nSyzbot reported an assertion failure\
  \ due to an attempt to add a delayed\niput after we have set BTRFS_FS_STATE_NO_DELAYED_IPUT\
  \ in the fs_info\nstate:\n\n  WARNING: CPU: 0 PID: 65 at fs/btrfs/inode.c:3420 btrfs_add_delayed_iput+0x2f8/0x370\
  \ fs/btrfs/inode.c:3420\n  Modules linked in:\n  CPU: 0 UID: 0 PID: 65 Comm: kworker/u8:4\
  \ Not tainted 6.15.0-next-20250530-syzkaller #0 PREEMPT(full)\n  Hardware name: Google Google\
  \ Compute Engine/Google Compute Engine, BIOS Google 05/07/2025\n  Workqueue: btrfs-endio-write\
  \ btrfs_work_helper\n  RIP: 0010:btrfs_add_delayed_iput+0x2f8/0x370 fs/btrfs/inode.c:3420\n\
  \  Code: 4e ad 5d (...)\n  RSP: 0018:ffffc9000213f780 EFLAGS: 00010293\n  RAX: ffffffff83c635b7\
  \ RBX: ffff888058920000 RCX: ffff88801c769e00\n  RDX: 0000000000000000 RSI: 0000000000000100\
  \ RDI: 0000000000000000\n  RBP: 0000000000000001 R08: ffff888058921b67 R09: 1ffff1100b12436c\n\
  \  R10: dffffc0000000000 R11: ffffed100b12436d R12: 0000000000000001\n  R13: dffffc0000000000\
  \ R14: ffff88807d748000 R15: 0000000000000100\n  FS:  0000000000000000(0000) GS:ffff888125c53000(0000)\
  \ knlGS:0000000000000000\n  CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n  CR2: 00002000000bd038\
  \ CR3: 000000006a142000 CR4: 00000000003526f0\n  DR0: 0000000000000000 DR1: 0000000000000000\
  \ DR2: 0000000000000000\n  DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400\n\
  \  Call Trace:\n   <TASK>\n   btrfs_put_ordered_extent+0x19f/0x470 fs/btrfs/ordered-data.c:635\n\
  \   btrfs_finish_one_ordered+0x11d8/0x1b10 fs/btrfs/inode.c:3312\n   btrfs_work_helper+0x399/0xc20\
  \ fs/btrfs/async-thread.c:312\n   process_one_work kernel/workqueue.c:3238 [inline]\n   process_scheduled_works+0xae1/0x17b0\
  \ kernel/workqueue.c:3321\n   worker_thread+0x8a0/0xda0 kernel/workqueue.c:3402\n   kthread+0x70e/0x8a0\
  \ kernel/kthread.c:464\n   ret_from_fork+0x3fc/0x770 arch/x86/kernel/process.c:148\n   ret_from_fork_asm+0x1a/0x30\
  \ arch/x86/entry/entry_64.S:245\n   </TASK>\n\nThis can happen due to a race with the async\
  \ reclaim worker like this:\n\n1) The async metadata reclaim worker enters shrink_delalloc(),\
  \ which calls\n   btrfs_start_delalloc_roots() with an nr_pages argument that has a value\n\
  \   less than LONG_MAX, and that in turn enters start_delalloc_inodes(),\n   which sets the\
  \ local variable 'full_flush' to false because\n   wbc->nr_to_write is less than LONG_MAX;\n\
  \n2) There it finds inode X in a root's delalloc list, grabs a reference for\n   inode X (with\
  \ igrab()), and triggers writeback for it with\n   filemap_fdatawrite_wbc(), which creates\
  \ an ordered extent for inode X;\n\n3) The unmount sequence starts from another task, we enter\
  \ close_ctree()\n   and we flush the workqueue fs_info->endio_write_workers, which waits\n\
  \   for the ordered extent for inode X to complete and when dropping the\n   last reference\
  \ of the ordered extent, with btrfs_put_ordered_extent(),\n   when we call btrfs_add_delayed_iput()\
  \ we don't add the inode to the\n   list of delayed iputs because it has a refcount of 2,\
  \ so we decrement\n   it to 1 and return;\n\n4) Shortly after at close_ctree() we call btrfs_run_delayed_iputs()\
  \ which\n   runs all delayed iputs, and then we set BTRFS_FS_STATE_NO_DELAYED_IPUT\n   in\
  \ the fs_info state;\n\n5) The async reclaim worker, after calling filemap_fdatawrite_wbc(),\
  \ now\n   calls btrfs_add_delayed_iput() for inode X and there we trigger an\n   assertion\
  \ failure since the fs_info state has the flag\n   BTRFS_FS_STATE_NO_DELAYED_IPUT set.\n\n\
  Fix this by setting BTRFS_FS_STATE_NO_DELAYED_IPUT only after we wait for\nthe async reclaim\
  \ workers to finish, after we call cancel_work_sync() for\nthem at close_ctree(), and by running\
  \ delayed iputs after wait for the\nreclaim workers to finish and before setting the bit.\n\
  \nThis race was recently introduced by commit 19e60b2a95f5 (\"btrfs: add\nextra warning if\
  \ delayed iput is added when it's not allowed\"). Without\nthe new validation at btrfs_add_delayed_iput(),\
  \ \n---truncated---"
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2025-38358.json
  - score: '0.00011'
    scoring_system: epss
    scoring_elements: '0.01003'
    published_at: '2026-01-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00011'
    scoring_system: epss
    scoring_elements: '0.01022'
    published_at: '2026-01-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.04718'
    published_at: '2025-08-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.04724'
    published_at: '2025-08-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.04754'
    published_at: '2025-08-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.04788'
    published_at: '2025-08-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.04671'
    published_at: '2025-08-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.04701'
    published_at: '2025-08-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.04708'
    published_at: '2025-08-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05661'
    published_at: '2025-09-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05642'
    published_at: '2025-09-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05733'
    published_at: '2025-09-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05755'
    published_at: '2025-09-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05798'
    published_at: '2025-09-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05687'
    published_at: '2025-09-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05632'
    published_at: '2025-09-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.0565'
    published_at: '2025-09-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05748'
    published_at: '2025-09-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.0575'
    published_at: '2025-09-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05625'
    published_at: '2025-09-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05752'
    published_at: '2025-09-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05682'
    published_at: '2025-09-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06374'
    published_at: '2025-10-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.0636'
    published_at: '2025-10-01 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06342'
    published_at: '2025-10-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06379'
    published_at: '2025-10-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06345'
    published_at: '2025-10-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06328'
    published_at: '2025-10-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06366'
    published_at: '2025-10-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06435'
    published_at: '2025-10-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06469'
    published_at: '2025-10-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06486'
    published_at: '2025-10-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06481'
    published_at: '2025-10-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06414'
    published_at: '2025-10-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06396'
    published_at: '2025-10-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.0639'
    published_at: '2025-10-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06407'
    published_at: '2025-10-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06389'
    published_at: '2025-10-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06384'
    published_at: '2025-10-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06372'
    published_at: '2025-10-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06383'
    published_at: '2025-10-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06485'
    published_at: '2025-11-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.06458'
    published_at: '2025-11-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
  - score: '2.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:L
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
weaknesses: []
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2025-38358.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2025-38358
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/4693cda2c06039c875f2eef0123b22340c34bfa0
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a26bf338cdad3643a6e7c3d78a172baadba15c1a
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2383444
    reference_type:
    reference_id: 2383444
  - url: https://nvd.nist.gov/vuln/detail/CVE-2025-38358
    reference_type:
    reference_id: CVE-2025-38358
