vulnerability_id: VCID-tzpc-bngz-dqaq
aliases:
  - CVE-2024-43834
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  xdp: fix invalid wait context of page_pool_destroy()

  If the driver uses a page pool, it creates a page pool with
  page_pool_create().
  The reference count of page pool is 1 as default.
  A page pool will be destroyed only when a reference count reaches 0.
  page_pool_destroy() is used to destroy page pool, it decreases a
  reference count.
  When a page pool is destroyed, ->disconnect() is called, which is
  mem_allocator_disconnect().
  This function internally acquires mutex_lock().

  If the driver uses XDP, it registers a memory model with
  xdp_rxq_info_reg_mem_model().
  The xdp_rxq_info_reg_mem_model() internally increases a page pool
  reference count if a memory model is a page pool.
  Now the reference count is 2.

  To destroy a page pool, the driver should call both page_pool_destroy()
  and xdp_unreg_mem_model().
  The xdp_unreg_mem_model() internally calls page_pool_destroy().
  Only page_pool_destroy() decreases a reference count.

  If a driver calls page_pool_destroy() then xdp_unreg_mem_model(), we
  will face an invalid wait context warning.
  Because xdp_unreg_mem_model() calls page_pool_destroy() with
  rcu_read_lock().
  The page_pool_destroy() internally acquires mutex_lock().

  Splat looks like:
  =============================
  [ BUG: Invalid wait context ]
  6.10.0-rc6+ #4 Tainted: G W
  -----------------------------
  ethtool/1806 is trying to lock:
  ffffffff90387b90 (mem_id_lock){+.+.}-{4:4}, at: mem_allocator_disconnect+0x73/0x150
  other info that might help us debug this:
  context-{5:5}
  3 locks held by ethtool/1806:
  stack backtrace:
  CPU: 0 PID: 1806 Comm: ethtool Tainted: G W 6.10.0-rc6+ #4 f916f41f172891c800f2fed
  Hardware name: ASUS System Product Name/PRIME Z690-P D4, BIOS 0603 11/01/2021
  Call Trace:
  <TASK>
  dump_stack_lvl+0x7e/0xc0
  __lock_acquire+0x1681/0x4de0
  ? _printk+0x64/0xe0
  ? __pfx_mark_lock.part.0+0x10/0x10
  ? __pfx___lock_acquire+0x10/0x10
  lock_acquire+0x1b3/0x580
  ? mem_allocator_disconnect+0x73/0x150
  ? __wake_up_klogd.part.0+0x16/0xc0
  ? __pfx_lock_acquire+0x10/0x10
  ? dump_stack_lvl+0x91/0xc0
  __mutex_lock+0x15c/0x1690
  ? mem_allocator_disconnect+0x73/0x150
  ? __pfx_prb_read_valid+0x10/0x10
  ? mem_allocator_disconnect+0x73/0x150
  ? __pfx_llist_add_batch+0x10/0x10
  ? console_unlock+0x193/0x1b0
  ? lockdep_hardirqs_on+0xbe/0x140
  ? __pfx___mutex_lock+0x10/0x10
  ? tick_nohz_tick_stopped+0x16/0x90
  ? __irq_work_queue_local+0x1e5/0x330
  ? irq_work_queue+0x39/0x50
  ? __wake_up_klogd.part.0+0x79/0xc0
  ? mem_allocator_disconnect+0x73/0x150
  mem_allocator_disconnect+0x73/0x150
  ? __pfx_mem_allocator_disconnect+0x10/0x10
  ? mark_held_locks+0xa5/0xf0
  ? rcu_is_watching+0x11/0xb0
  page_pool_release+0x36e/0x6d0
  page_pool_destroy+0xd7/0x440
  xdp_unreg_mem_model+0x1a7/0x2a0
  ? __pfx_xdp_unreg_mem_model+0x10/0x10
  ? kfree+0x125/0x370
  ? bnxt_free_ring.isra.0+0x2eb/0x500
  ? bnxt_free_mem+0x5ac/0x2500
  xdp_rxq_info_unreg+0x4a/0xd0
  bnxt_free_mem+0x1356/0x2500
  bnxt_close_nic+0xf0/0x3b0
  ? __pfx_bnxt_close_nic+0x10/0x10
  ? ethnl_parse_bit+0x2c6/0x6d0
  ? __pfx___nla_validate_parse+0x10/0x10
  ? __pfx_ethnl_parse_bit+0x10/0x10
  bnxt_set_features+0x2a8/0x3e0
  __netdev_update_features+0x4dc/0x1370
  ? ethnl_parse_bitset+0x4ff/0x750
  ? __pfx_ethnl_parse_bitset+0x10/0x10
  ? __pfx___netdev_update_features+0x10/0x10
  ? mark_held_locks+0xa5/0xf0
  ? _raw_spin_unlock_irqrestore+0x42/0x70
  ? __pm_runtime_resume+0x7d/0x110
  ethnl_set_features+0x32d/0xa20

  To fix this problem, it uses rhashtable_lookup_fast() instead of
  rhashtable_lookup() with rcu_read_lock().
  Using xa without rcu_read_lock() here is safe.
  xa is freed by __xdp_mem_allocator_rcu_free() and this is called by
  call_rcu() of mem_xa_remove().
  The mem_xa_remove() is called by page_pool_destroy() if a reference
  count reaches 0.
  The xa is already protected by the reference count mechanism well in the
  control plane.
  So removing rcu_read_lock() for page_pool_destroy() is safe.
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-43834.json
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05128'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05124'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05115'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05119'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05108'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05105'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05100'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05091'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05073'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05065'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05058'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.18846'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.18926'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.18947'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.18953'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.18962'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.189'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.18773'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00061'
    scoring_system: epss
    scoring_elements: '0.19386'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00061'
    scoring_system: epss
    scoring_elements: '0.19333'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00061'
    scoring_system: epss
    scoring_elements: '0.19347'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00061'
    scoring_system: epss
    scoring_elements: '0.19358'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00061'
    scoring_system: epss
    scoring_elements: '0.19376'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00061'
    scoring_system: epss
    scoring_elements: '0.19385'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18931'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18964'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18953'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.1892'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18895'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18862'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18924'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18908'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18752'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18945'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18907'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18896'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18912'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.1879'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.00071'
    scoring_system: epss
    scoring_elements: '0.18937'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '0.003'
    scoring_system: epss
    scoring_elements: '0.37004'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-43834
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-43834
weaknesses:
  - CWE-764
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-43834.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-43834
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-43834
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/12144069209eec7f2090ce9afa15acdcc2c2a537
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/3fc1be360b99baeea15cdee3cf94252cd3a72d26
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/59a931c5b732ca5fc2ca727f5a72aeabaafa85ec
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/6c390ef198aa69795427a5cb5fd7cb4bc7e6cd7a
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/be9d08ff102df3ac4f66e826ea935cf3af63a4bd
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/bf0ce5aa5f2525ed1b921ba36de96e458e77f482
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2305492
    reference_type:
    reference_id: 2305492
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-43834
    reference_type:
    reference_id: CVE-2024-43834
  - url: https://usn.ubuntu.com/7100-1/
    reference_type:
    reference_id: USN-7100-1
  - url: https://usn.ubuntu.com/7100-2/
    reference_type:
    reference_id: USN-7100-2
  - url: https://usn.ubuntu.com/7123-1/
    reference_type:
    reference_id: USN-7123-1
  - url: https://usn.ubuntu.com/7144-1/
    reference_type:
    reference_id: USN-7144-1
  - url: https://usn.ubuntu.com/7154-1/
    reference_type:
    reference_id: USN-7154-1
  - url: https://usn.ubuntu.com/7154-2/
    reference_type:
    reference_id: USN-7154-2
  - url: https://usn.ubuntu.com/7155-1/
    reference_type:
    reference_id: USN-7155-1
  - url: https://usn.ubuntu.com/7156-1/
    reference_type:
    reference_id: USN-7156-1
  - url: https://usn.ubuntu.com/7194-1/
    reference_type:
    reference_id: USN-7194-1
  - url: https://usn.ubuntu.com/7196-1/
    reference_type:
    reference_id: USN-7196-1
