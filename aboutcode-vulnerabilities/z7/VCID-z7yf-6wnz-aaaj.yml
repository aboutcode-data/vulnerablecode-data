vulnerability_id: VCID-z7yf-6wnz-aaaj
aliases:
  - CVE-2021-47465
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  KVM: PPC: Book3S HV: Fix stack handling in idle_kvm_start_guest()

  In commit 10d91611f426 ("powerpc/64s: Reimplement book3s idle code in
  C") kvm_start_guest() became idle_kvm_start_guest(). The old code
  allocated a stack frame on the emergency stack, but didn't use the
  frame to store anything, and also didn't store anything in its caller's
  frame.

  idle_kvm_start_guest() on the other hand is written more like a normal C
  function, it creates a frame on entry, and also stores CR/LR into its
  callers frame (per the ABI). The problem is that there is no caller
  frame on the emergency stack.

  The emergency stack for a given CPU is allocated with:

    paca_ptrs[i]->emergency_sp = alloc_stack(limit, i) + THREAD_SIZE;

  So emergency_sp actually points to the first address above the emergency
  stack allocation for a given CPU, we must not store above it without
  first decrementing it to create a frame. This is different to the
  regular kernel stack, paca->kstack, which is initialised to point at an
  initial frame that is ready to use.

  idle_kvm_start_guest() stores the backchain, CR and LR all of which
  write outside the allocation for the emergency stack. It then creates a
  stack frame and saves the non-volatile registers. Unfortunately the
  frame it creates is not large enough to fit the non-volatiles, and so
  the saving of the non-volatile registers also writes outside the
  emergency stack allocation.

  The end result is that we corrupt whatever is at 0-24 bytes, and 112-248
  bytes above the emergency stack allocation.

  In practice this has gone unnoticed because the memory immediately above
  the emergency stack happens to be used for other stack allocations,
  either another CPUs mc_emergency_sp or an IRQ stack. See the order of
  calls to irqstack_early_init() and emergency_stack_init().

  The low addresses of another stack are the top of that stack, and so are
  only used if that stack is under extreme pressue, which essentially
  never happens in practice - and if it did there's a high likelyhood we'd
  crash due to that stack overflowing.

  Still, we shouldn't be corrupting someone else's stack, and it is purely
  luck that we aren't corrupting something else.

  To fix it we save CR/LR into the caller's frame using the existing r1 on
  entry, we then create a SWITCH_FRAME_SIZE frame (which has space for
  pt_regs) on the emergency stack with the backchain pointing to the
  existing stack, and then finally we switch to the new frame on the
  emergency stack.
severities:
  - score: '4.4'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2021-47465.json
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16666'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16947'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17624'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17338'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17315'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17350'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17830'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17732'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17645'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17329'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17041'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17069'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17147'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17142'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17226'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17164'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15426'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15379'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15458'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.1546'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15435'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15409'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15397'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15401'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15413'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15432'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15436'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12383'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12356'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12522'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12528'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12563'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12601'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12579'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12569'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12583'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12599'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12626'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12613'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12584'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12568'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12508'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15219'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15284'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '0.0021'
    scoring_system: epss
    scoring_elements: '0.29181'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
  - score: '7.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '7.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:H
    published_at: None
    url: https://git.kernel.org/stable/c/6d077c37c4643394b1bae9682da48164fc147ea8
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-05-29T18:41:27Z/
    published_at: None
    url: https://git.kernel.org/stable/c/6d077c37c4643394b1bae9682da48164fc147ea8
  - score: '7.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:H
    published_at: None
    url: https://git.kernel.org/stable/c/80bbb0bc3a0288442f7fe6fc514f4ee1cb06ccb7
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-05-29T18:41:27Z/
    published_at: None
    url: https://git.kernel.org/stable/c/80bbb0bc3a0288442f7fe6fc514f4ee1cb06ccb7
  - score: '7.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:H
    published_at: None
    url: https://git.kernel.org/stable/c/9b4416c5095c20e110c82ae602c254099b83b72f
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-05-29T18:41:27Z/
    published_at: None
    url: https://git.kernel.org/stable/c/9b4416c5095c20e110c82ae602c254099b83b72f
  - score: '7.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:H
    published_at: None
    url: https://git.kernel.org/stable/c/fbd724c49bead048ae9fc1a5b7bff2fb3e54f855
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-05-29T18:41:27Z/
    published_at: None
    url: https://git.kernel.org/stable/c/fbd724c49bead048ae9fc1a5b7bff2fb3e54f855
weaknesses:
  - CWE-121
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2021-47465.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2021-47465
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-47465
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/6d077c37c4643394b1bae9682da48164fc147ea8
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/80bbb0bc3a0288442f7fe6fc514f4ee1cb06ccb7
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/9b4416c5095c20e110c82ae602c254099b83b72f
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/fbd724c49bead048ae9fc1a5b7bff2fb3e54f855
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2282891
    reference_type:
    reference_id: 2282891
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-47465
    reference_type:
    reference_id: CVE-2021-47465
