vulnerability_id: VCID-8cs1-26uk-aaad
aliases:
  - CVE-2024-41058
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  cachefiles: fix slab-use-after-free in fscache_withdraw_volume()

  We got the following issue in our fault injection stress test:

  ==================================================================
  BUG: KASAN: slab-use-after-free in fscache_withdraw_volume+0x2e1/0x370
  Read of size 4 at addr ffff88810680be08 by task ondemand-04-dae/5798

  CPU: 0 PID: 5798 Comm: ondemand-04-dae Not tainted 6.8.0-dirty #565
  Call Trace:
   kasan_check_range+0xf6/0x1b0
   fscache_withdraw_volume+0x2e1/0x370
   cachefiles_withdraw_volume+0x31/0x50
   cachefiles_withdraw_cache+0x3ad/0x900
   cachefiles_put_unbind_pincount+0x1f6/0x250
   cachefiles_daemon_release+0x13b/0x290
   __fput+0x204/0xa00
   task_work_run+0x139/0x230

  Allocated by task 5820:
   __kmalloc+0x1df/0x4b0
   fscache_alloc_volume+0x70/0x600
   __fscache_acquire_volume+0x1c/0x610
   erofs_fscache_register_volume+0x96/0x1a0
   erofs_fscache_register_fs+0x49a/0x690
   erofs_fc_fill_super+0x6c0/0xcc0
   vfs_get_super+0xa9/0x140
   vfs_get_tree+0x8e/0x300
   do_new_mount+0x28c/0x580
   [...]

  Freed by task 5820:
   kfree+0xf1/0x2c0
   fscache_put_volume.part.0+0x5cb/0x9e0
   erofs_fscache_unregister_fs+0x157/0x1b0
   erofs_kill_sb+0xd9/0x1c0
   deactivate_locked_super+0xa3/0x100
   vfs_get_super+0x105/0x140
   vfs_get_tree+0x8e/0x300
   do_new_mount+0x28c/0x580
   [...]
  ==================================================================

  Following is the process that triggers the issue:

          mount failed         |         daemon exit
  ------------------------------------------------------------
   deactivate_locked_super        cachefiles_daemon_release
    erofs_kill_sb
     erofs_fscache_unregister_fs
      fscache_relinquish_volume
       __fscache_relinquish_volume
        fscache_put_volume(fscache_volume, fscache_volume_put_relinquish)
         zero = __refcount_dec_and_test(&fscache_volume->ref, &ref);
                                   cachefiles_put_unbind_pincount
                                    cachefiles_daemon_unbind
                                     cachefiles_withdraw_cache
                                      cachefiles_withdraw_volumes
                                       list_del_init(&volume->cache_link)
         fscache_free_volume(fscache_volume)
          cache->ops->free_volume
           cachefiles_free_volume
            list_del_init(&cachefiles_volume->cache_link);
          kfree(fscache_volume)
                                       cachefiles_withdraw_volume
                                        fscache_withdraw_volume
                                         fscache_volume->n_accesses
                                         // fscache_volume UAF !!!

  The fscache_volume in cache->volumes must not have been freed yet, but its
  reference count may be 0. So use the new fscache_try_get_volume() helper
  function try to get its reference count.

  If the reference count of fscache_volume is 0, fscache_put_volume() is
  freeing it, so wait for it to be removed from cache->volumes.

  If its reference count is not 0, call cachefiles_withdraw_volume() with
  reference count protection to avoid the above issue.
severities:
  - score: '7.0'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-41058.json
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05128'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05124'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05115'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05119'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05108'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05105'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05100'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05091'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05073'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05065'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05058'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12596'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.1237'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12426'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12523'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12599'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12572'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12532'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.1252'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12501'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14596'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14622'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14614'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14593'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14626'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00074'
    scoring_system: epss
    scoring_elements: '0.19504'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00074'
    scoring_system: epss
    scoring_elements: '0.19458'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00074'
    scoring_system: epss
    scoring_elements: '0.19619'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00075'
    scoring_system: epss
    scoring_elements: '0.19991'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00075'
    scoring_system: epss
    scoring_elements: '0.1994'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00075'
    scoring_system: epss
    scoring_elements: '0.19918'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00075'
    scoring_system: epss
    scoring_elements: '0.19936'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00075'
    scoring_system: epss
    scoring_elements: '0.19951'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00075'
    scoring_system: epss
    scoring_elements: '0.19989'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00075'
    scoring_system: epss
    scoring_elements: '0.19983'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00075'
    scoring_system: epss
    scoring_elements: '0.19952'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00075'
    scoring_system: epss
    scoring_elements: '0.19974'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00075'
    scoring_system: epss
    scoring_elements: '0.19988'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.2085'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '0.00313'
    scoring_system: epss
    scoring_elements: '0.38001'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
  - score: '6.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '7.8'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-41058
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-41058
weaknesses:
  - CWE-416
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-41058.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-41058
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-41058
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/38b88d544216f806d93a273a62ff8ebe82254003
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/522018a0de6b6fcce60c04f86dfc5f0e4b6a1b36
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/90f17e47f1e209c6a3c92a1d038a0a80c95c460e
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/9dd7f5663899ea13a6a73216106d9c13c37453e3
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2300432
    reference_type:
    reference_id: 2300432
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-41058
    reference_type:
    reference_id: CVE-2024-41058
  - url: https://access.redhat.com/errata/RHSA-2024:9315
    reference_type:
    reference_id: RHSA-2024:9315
  - url: https://usn.ubuntu.com/7089-1/
    reference_type:
    reference_id: USN-7089-1
  - url: https://usn.ubuntu.com/7089-2/
    reference_type:
    reference_id: USN-7089-2
  - url: https://usn.ubuntu.com/7089-3/
    reference_type:
    reference_id: USN-7089-3
  - url: https://usn.ubuntu.com/7089-4/
    reference_type:
    reference_id: USN-7089-4
  - url: https://usn.ubuntu.com/7089-5/
    reference_type:
    reference_id: USN-7089-5
  - url: https://usn.ubuntu.com/7089-6/
    reference_type:
    reference_id: USN-7089-6
  - url: https://usn.ubuntu.com/7089-7/
    reference_type:
    reference_id: USN-7089-7
  - url: https://usn.ubuntu.com/7090-1/
    reference_type:
    reference_id: USN-7090-1
  - url: https://usn.ubuntu.com/7095-1/
    reference_type:
    reference_id: USN-7095-1
  - url: https://usn.ubuntu.com/7156-1/
    reference_type:
    reference_id: USN-7156-1
