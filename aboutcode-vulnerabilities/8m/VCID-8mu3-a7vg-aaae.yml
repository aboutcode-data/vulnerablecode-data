vulnerability_id: VCID-8mu3-a7vg-aaae
aliases:
  - CVE-2024-35949
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: make sure that WRITTEN is set on all metadata blocks

  We previously would call btrfs_check_leaf() if we had the check
  integrity code enabled, which meant that we could only run the extended
  leaf checks if we had WRITTEN set on the header flags.

  This leaves a gap in our checking, because we could end up with
  corruption on disk where WRITTEN isn't set on the leaf, and then the
  extended leaf checks don't get run which we rely on to validate all of
  the item pointers to make sure we don't access memory outside of the
  extent buffer.

  However, since 732fab95abe2 ("btrfs: check-integrity: remove
  CONFIG_BTRFS_FS_CHECK_INTEGRITY option") we no longer call
  btrfs_check_leaf() from btrfs_mark_buffer_dirty(), which means we only
  ever call it on blocks that are being written out, and thus have WRITTEN
  set, or that are being read in, which should have WRITTEN set.

  Add checks to make sure we have WRITTEN set appropriately, and then make
  sure __btrfs_check_leaf() always does the item checking.  This will
  protect us from file systems that have been corrupted and no longer have
  WRITTEN set on some of the blocks.

  This was hit on a crafted image tweaking the WRITTEN bit and reported by
  KASAN as out-of-bound access in the eb accessors. The example is a dir
  item at the end of an eb.

    [2.042] BTRFS warning (device loop1): bad eb member start: ptr 0x3fff start 30572544 member offset 16410 size 2
    [2.040] general protection fault, probably for non-canonical address 0xe0009d1000000003: 0000 [#1] PREEMPT SMP KASAN NOPTI
    [2.537] KASAN: maybe wild-memory-access in range [0x0005088000000018-0x000508800000001f]
    [2.729] CPU: 0 PID: 2587 Comm: mount Not tainted 6.8.2 #1
    [2.729] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
    [2.621] RIP: 0010:btrfs_get_16+0x34b/0x6d0
    [2.621] RSP: 0018:ffff88810871fab8 EFLAGS: 00000206
    [2.621] RAX: 0000a11000000003 RBX: ffff888104ff8720 RCX: ffff88811b2288c0
    [2.621] RDX: dffffc0000000000 RSI: ffffffff81dd8aca RDI: ffff88810871f748
    [2.621] RBP: 000000000000401a R08: 0000000000000001 R09: ffffed10210e3ee9
    [2.621] R10: ffff88810871f74f R11: 205d323430333737 R12: 000000000000001a
    [2.621] R13: 000508800000001a R14: 1ffff110210e3f5d R15: ffffffff850011e8
    [2.621] FS:  00007f56ea275840(0000) GS:ffff88811b200000(0000) knlGS:0000000000000000
    [2.621] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    [2.621] CR2: 00007febd13b75c0 CR3: 000000010bb50000 CR4: 00000000000006f0
    [2.621] Call Trace:
    [2.621]  <TASK>
    [2.621]  ? show_regs+0x74/0x80
    [2.621]  ? die_addr+0x46/0xc0
    [2.621]  ? exc_general_protection+0x161/0x2a0
    [2.621]  ? asm_exc_general_protection+0x26/0x30
    [2.621]  ? btrfs_get_16+0x33a/0x6d0
    [2.621]  ? btrfs_get_16+0x34b/0x6d0
    [2.621]  ? btrfs_get_16+0x33a/0x6d0
    [2.621]  ? __pfx_btrfs_get_16+0x10/0x10
    [2.621]  ? __pfx_mutex_unlock+0x10/0x10
    [2.621]  btrfs_match_dir_item_name+0x101/0x1a0
    [2.621]  btrfs_lookup_dir_item+0x1f3/0x280
    [2.621]  ? __pfx_btrfs_lookup_dir_item+0x10/0x10
    [2.621]  btrfs_get_tree+0xd25/0x1910

  [ copy more details from report ]
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-35949.json
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10932'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10875'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10184'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10278'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10302'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10364'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10366'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10377'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10429'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10484'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10788'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10843'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10939'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10859'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.11287'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16666'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.34037'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.33998'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.34065'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.34131'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.3417'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.34175'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.34091'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.34076'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.34078'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.3408'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.34097'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.34089'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00131'
    scoring_system: epss
    scoring_elements: '0.34062'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.0016'
    scoring_system: epss
    scoring_elements: '0.33626'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.36846'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.36876'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.3688'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.3681'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.36787'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.36805'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.36849'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.36848'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.36869'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.36836'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.36822'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.3672'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00181'
    scoring_system: epss
    scoring_elements: '0.36839'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: '0.00483'
    scoring_system: epss
    scoring_elements: '0.4814'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
  - score: 7
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-06-17T17:38:20Z/
    published_at: None
    url: https://git.kernel.org/stable/c/9dff3e36ea89e8003516841c27c45af562b6ef44
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-06-17T17:38:20Z/
    published_at: None
    url: https://git.kernel.org/stable/c/e03418abde871314e1a3a550f4c8afb7b89cb273
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-06-17T17:38:20Z/
    published_at: None
    url: https://git.kernel.org/stable/c/ef3ba8ce8cf7075b716aa4afcefc3034215878ee
weaknesses:
  - CWE-125
  - CWE-787
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-35949.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-35949
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-35949
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/e03418abde871314e1a3a550f4c8afb7b89cb273
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/ef3ba8ce8cf7075b716aa4afcefc3034215878ee
    reference_type:
    reference_id:
  - url: https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/OTB4HWU2PTVW5NEYHHLOCXDKG3PYA534/
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2281945
    reference_type:
    reference_id: 2281945
  - url: https://git.kernel.org/stable/c/9dff3e36ea89e8003516841c27c45af562b6ef44
    reference_type:
    reference_id: 9dff3e36ea89e8003516841c27c45af562b6ef44
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-35949
    reference_type:
    reference_id: CVE-2024-35949
  - url: https://usn.ubuntu.com/6949-1/
    reference_type:
    reference_id: USN-6949-1
  - url: https://usn.ubuntu.com/6949-2/
    reference_type:
    reference_id: USN-6949-2
  - url: https://usn.ubuntu.com/6952-1/
    reference_type:
    reference_id: USN-6952-1
  - url: https://usn.ubuntu.com/6952-2/
    reference_type:
    reference_id: USN-6952-2
  - url: https://usn.ubuntu.com/6955-1/
    reference_type:
    reference_id: USN-6955-1
