vulnerability_id: VCID-m759-xez8-aaak
aliases:
  - CVE-2022-48664
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: fix hang during unmount when stopping a space reclaim worker

  Often when running generic/562 from fstests we can hang during unmount,
  resulting in a trace like this:

    Sep 07 11:52:00 debian9 unknown: run fstests generic/562 at 2022-09-07 11:52:00
    Sep 07 11:55:32 debian9 kernel: INFO: task umount:49438 blocked for more than 120 seconds.
    Sep 07 11:55:32 debian9 kernel:       Not tainted 6.0.0-rc2-btrfs-next-122 #1
    Sep 07 11:55:32 debian9 kernel: "echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.
    Sep 07 11:55:32 debian9 kernel: task:umount          state:D stack:    0 pid:49438 ppid: 25683 flags:0x00004000
    Sep 07 11:55:32 debian9 kernel: Call Trace:
    Sep 07 11:55:32 debian9 kernel:  <TASK>
    Sep 07 11:55:32 debian9 kernel:  __schedule+0x3c8/0xec0
    Sep 07 11:55:32 debian9 kernel:  ? rcu_read_lock_sched_held+0x12/0x70
    Sep 07 11:55:32 debian9 kernel:  schedule+0x5d/0xf0
    Sep 07 11:55:32 debian9 kernel:  schedule_timeout+0xf1/0x130
    Sep 07 11:55:32 debian9 kernel:  ? lock_release+0x224/0x4a0
    Sep 07 11:55:32 debian9 kernel:  ? lock_acquired+0x1a0/0x420
    Sep 07 11:55:32 debian9 kernel:  ? trace_hardirqs_on+0x2c/0xd0
    Sep 07 11:55:32 debian9 kernel:  __wait_for_common+0xac/0x200
    Sep 07 11:55:32 debian9 kernel:  ? usleep_range_state+0xb0/0xb0
    Sep 07 11:55:32 debian9 kernel:  __flush_work+0x26d/0x530
    Sep 07 11:55:32 debian9 kernel:  ? flush_workqueue_prep_pwqs+0x140/0x140
    Sep 07 11:55:32 debian9 kernel:  ? trace_clock_local+0xc/0x30
    Sep 07 11:55:32 debian9 kernel:  __cancel_work_timer+0x11f/0x1b0
    Sep 07 11:55:32 debian9 kernel:  ? close_ctree+0x12b/0x5b3 [btrfs]
    Sep 07 11:55:32 debian9 kernel:  ? __trace_bputs+0x10b/0x170
    Sep 07 11:55:32 debian9 kernel:  close_ctree+0x152/0x5b3 [btrfs]
    Sep 07 11:55:32 debian9 kernel:  ? evict_inodes+0x166/0x1c0
    Sep 07 11:55:32 debian9 kernel:  generic_shutdown_super+0x71/0x120
    Sep 07 11:55:32 debian9 kernel:  kill_anon_super+0x14/0x30
    Sep 07 11:55:32 debian9 kernel:  btrfs_kill_super+0x12/0x20 [btrfs]
    Sep 07 11:55:32 debian9 kernel:  deactivate_locked_super+0x2e/0xa0
    Sep 07 11:55:32 debian9 kernel:  cleanup_mnt+0x100/0x160
    Sep 07 11:55:32 debian9 kernel:  task_work_run+0x59/0xa0
    Sep 07 11:55:32 debian9 kernel:  exit_to_user_mode_prepare+0x1a6/0x1b0
    Sep 07 11:55:32 debian9 kernel:  syscall_exit_to_user_mode+0x16/0x40
    Sep 07 11:55:32 debian9 kernel:  do_syscall_64+0x48/0x90
    Sep 07 11:55:32 debian9 kernel:  entry_SYSCALL_64_after_hwframe+0x63/0xcd
    Sep 07 11:55:32 debian9 kernel: RIP: 0033:0x7fcde59a57a7
    Sep 07 11:55:32 debian9 kernel: RSP: 002b:00007ffe914217c8 EFLAGS: 00000246 ORIG_RAX: 00000000000000a6
    Sep 07 11:55:32 debian9 kernel: RAX: 0000000000000000 RBX: 00007fcde5ae8264 RCX: 00007fcde59a57a7
    Sep 07 11:55:32 debian9 kernel: RDX: 0000000000000000 RSI: 0000000000000000 RDI: 000055b57556cdd0
    Sep 07 11:55:32 debian9 kernel: RBP: 000055b57556cba0 R08: 0000000000000000 R09: 00007ffe91420570
    Sep 07 11:55:32 debian9 kernel: R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
    Sep 07 11:55:32 debian9 kernel: R13: 000055b57556cdd0 R14: 000055b57556ccb8 R15: 0000000000000000
    Sep 07 11:55:32 debian9 kernel:  </TASK>

  What happens is the following:

  1) The cleaner kthread tries to start a transaction to delete an unused
     block group, but the metadata reservation can not be satisfied right
     away, so a reservation ticket is created and it starts the async
     metadata reclaim task (fs_info->async_reclaim_work);

  2) Writeback for all the filler inodes with an i_size of 2K starts
     (generic/562 creates a lot of 2K files with the goal of filling
     metadata space). We try to create an inline extent for them, but we
     fail when trying to insert the inline extent with -ENOSPC (at
     cow_file_range_inline()) - since this is not critical, we fallback
     to non-inline mode (back to cow_file_range()), reserve extents
  ---truncated---
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2022-48664.json
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16666'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16947'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17041'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17069'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17147'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17142'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17164'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17226'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17329'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17645'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17732'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17830'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17350'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17315'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17624'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17338'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.41595'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38099'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.41654'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.41632'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38063'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38182'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38195'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38198'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38223'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38196'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38169'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38183'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38208'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38239'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38236'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38211'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.38175'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.3814'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.41605'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.41669'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.41735'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.41769'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.4177'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.41663'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.41649'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.41656'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00192'
    scoring_system: epss
    scoring_elements: '0.4165'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '0.00757'
    scoring_system: epss
    scoring_elements: '0.57926'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
weaknesses:
  - CWE-833
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2022-48664.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2022-48664
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-48664
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a362bb864b8db4861977d00bd2c3222503ccc34b
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c338bea1fec5504290dc0acf026c9e7dba25004b
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/d8a76a2e514fbbb315a6dfff2d342de2de833994
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2277795
    reference_type:
    reference_id: 2277795
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-48664
    reference_type:
    reference_id: CVE-2022-48664
