vulnerability_id: VCID-z324-mb6f-ukcd
aliases:
  - CVE-2024-50118
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: reject ro->rw reconfiguration if there are hard ro requirements

  [BUG]
  Syzbot reports the following crash:

    BTRFS info (device loop0 state MCS): disabling free space tree
    BTRFS info (device loop0 state MCS): clearing compat-ro feature flag for FREE_SPACE_TREE (0x1)
    BTRFS info (device loop0 state MCS): clearing compat-ro feature flag for FREE_SPACE_TREE_VALID (0x2)
    Oops: general protection fault, probably for non-canonical address 0xdffffc0000000003: 0000 [#1] PREEMPT SMP KASAN NOPTI
    KASAN: null-ptr-deref in range [0x0000000000000018-0x000000000000001f]
    Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
    RIP: 0010:backup_super_roots fs/btrfs/disk-io.c:1691 [inline]
    RIP: 0010:write_all_supers+0x97a/0x40f0 fs/btrfs/disk-io.c:4041
    Call Trace:
     <TASK>
     btrfs_commit_transaction+0x1eae/0x3740 fs/btrfs/transaction.c:2530
     btrfs_delete_free_space_tree+0x383/0x730 fs/btrfs/free-space-tree.c:1312
     btrfs_start_pre_rw_mount+0xf28/0x1300 fs/btrfs/disk-io.c:3012
     btrfs_remount_rw fs/btrfs/super.c:1309 [inline]
     btrfs_reconfigure+0xae6/0x2d40 fs/btrfs/super.c:1534
     btrfs_reconfigure_for_mount fs/btrfs/super.c:2020 [inline]
     btrfs_get_tree_subvol fs/btrfs/super.c:2079 [inline]
     btrfs_get_tree+0x918/0x1920 fs/btrfs/super.c:2115
     vfs_get_tree+0x90/0x2b0 fs/super.c:1800
     do_new_mount+0x2be/0xb40 fs/namespace.c:3472
     do_mount fs/namespace.c:3812 [inline]
     __do_sys_mount fs/namespace.c:4020 [inline]
     __se_sys_mount+0x2d6/0x3c0 fs/namespace.c:3997
     do_syscall_x64 arch/x86/entry/common.c:52 [inline]
     do_syscall_64+0xf3/0x230 arch/x86/entry/common.c:83
     entry_SYSCALL_64_after_hwframe+0x77/0x7f

  [CAUSE]
  To support mounting different subvolume with different RO/RW flags for
  the new mount APIs, btrfs introduced two workaround to support this feature:

  - Skip mount option/feature checks if we are mounting a different
    subvolume

  - Reconfigure the fs to RW if the initial mount is RO

  Combining these two, we can have the following sequence:

  - Mount the fs ro,rescue=all,clear_cache,space_cache=v1
    rescue=all will mark the fs as hard read-only, so no v2 cache clearing
    will happen.

  - Mount a subvolume rw of the same fs.
    We go into btrfs_get_tree_subvol(), but fc_mount() returns EBUSY
    because our new fc is RW, different from the original fs.

    Now we enter btrfs_reconfigure_for_mount(), which switches the RO flag
    first so that we can grab the existing fs_info.
    Then we reconfigure the fs to RW.

  - During reconfiguration, option/features check is skipped
    This means we will restart the v2 cache clearing, and convert back to
    v1 cache.
    This will trigger fs writes, and since the original fs has "rescue=all"
    option, it skips the csum tree read.

    And eventually causing NULL pointer dereference in super block
    writeback.

  [FIX]
  For reconfiguration caused by different subvolume RO/RW flags, ensure we
  always run btrfs_check_options() to ensure we have proper hard RO
  requirements met.

  In fact the function btrfs_check_options() doesn't really do many
  complex checks, but hard RO requirement and some feature dependency
  checks, thus there is no special reason not to do the check for mount
  reconfiguration.
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-50118.json
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.08567'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.08646'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.08649'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.08634'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.08644'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.08694'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.0871'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.08777'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.08802'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.08818'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.08752'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.08641'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.08585'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.06452'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.0645'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.06324'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.06351'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00034'
    scoring_system: epss
    scoring_elements: '0.05026'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.08205'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.08163'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.08192'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.0819'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.08193'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.0821'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.08177'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.0815'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.08139'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00038'
    scoring_system: epss
    scoring_elements: '0.081'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10364'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10302'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10278'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10429'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10377'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10366'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10184'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10859'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10939'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10843'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10788'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.11287'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10932'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10875'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10484'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-50118
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-50118
weaknesses:
  - CWE-476
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-50118.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-50118
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/23724398b55d9570f6ae79dd2ea026fff8896bf1
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/3c36a72c1d27de6618c1c480c793d9924640f5bb
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2323936
    reference_type:
    reference_id: 2323936
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-50118
    reference_type:
    reference_id: CVE-2024-50118
  - url: https://usn.ubuntu.com/7276-1/
    reference_type:
    reference_id: USN-7276-1
  - url: https://usn.ubuntu.com/7277-1/
    reference_type:
    reference_id: USN-7277-1
  - url: https://usn.ubuntu.com/7310-1/
    reference_type:
    reference_id: USN-7310-1
  - url: https://usn.ubuntu.com/7449-1/
    reference_type:
    reference_id: USN-7449-1
  - url: https://usn.ubuntu.com/7449-2/
    reference_type:
    reference_id: USN-7449-2
  - url: https://usn.ubuntu.com/7450-1/
    reference_type:
    reference_id: USN-7450-1
  - url: https://usn.ubuntu.com/7451-1/
    reference_type:
    reference_id: USN-7451-1
  - url: https://usn.ubuntu.com/7452-1/
    reference_type:
    reference_id: USN-7452-1
  - url: https://usn.ubuntu.com/7453-1/
    reference_type:
    reference_id: USN-7453-1
  - url: https://usn.ubuntu.com/7468-1/
    reference_type:
    reference_id: USN-7468-1
