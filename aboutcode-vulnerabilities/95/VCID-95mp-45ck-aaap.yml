vulnerability_id: VCID-95mp-45ck-aaap
aliases:
  - CVE-2024-41945
  - GHSA-3jcg-vx7f-j6qf
summary: "The fuels-ts typescript SDK has no awareness of to-be-spent transactions\n# Brief/Intro\n\
  \nThe typescript SDK has no awareness of to-be-spent transactions causing some transactions\
  \ to fail or silently get pruned as they are funded with already used UTXOs.\n\nThe `Typescript\
  \ SDK` provides the `fund` function which retrieves `UTXOs`, which belong to the owner and\
  \ can be used to fund the request in question, from fuel's graphql api. These then get added\
  \ to the request making it possible to send it to the network as it now has inputs which can\
  \ be spent by its outputs. Now this works when a user only wants to fund one transaction per\
  \ block as in the next block, the spent UTXO will not exist anymore. However if a user wants\
  \ to fund multiple transactions within one block, the following can happen:\n\nIt is important\
  \ to note, that the graphql API will return a random UTXO which has enough value to fund the\
  \ transaction in question.\n\n- user has 2 spendable `UTXOs` in their wallet which can cover\
  \ all expenses\n- user funds transaction `tA` with an input gotten from the API `iA`\n- user\
  \ submits `tA` to fuel\n- `iA` is still in possession of the user as no new block has been\
  \ produced\n- user funds a transaction `tB` and gets the same input `iA` from the API\n- user\
  \ tries to submit transaction `tB` to fuel but now one of the following can happen:\n  - if\
  \ the recipient and all other parameters are the same as in `tA`, submission will fail as\
  \ `tB` will have the same `txHash` as `tA`\n  - if the parameters are different, there will\
  \ be a collision in the `txpool` and `tA` will be removed from the `txpool`\n\n# Vulnerability\
  \ Details\n\nThe problem occurs, because the `fund` function in `fuels-ts/packages/account/src/account.ts`\
  \ gets the needed ressources statelessly with the function `getResourcesToSpend` without taking\
  \ into consideration already used UTXOs:\n\n```ts\n async fund<T extends TransactionRequest>(request:\
  \ T, params: EstimatedTxParams): Promise<T> {\n\n    // [...]\n\n    let missingQuantities:\
  \ CoinQuantity[] = [];\n    Object.entries(quantitiesDict).forEach(([assetId, { owned, required\
  \ }]) => {\n      if (owned.lt(required)) {\n        missingQuantities.push({\n          assetId,\n\
  \          amount: required.sub(owned),\n        });\n      }\n    });\n\n    let needsToBeFunded\
  \ = missingQuantities.length > 0;\n    let fundingAttempts = 0;\n    while (needsToBeFunded\
  \ && fundingAttempts < MAX_FUNDING_ATTEMPTS) {\n      const resources = await this.getResourcesToSpend(\n\
  \        missingQuantities,\n        cacheRequestInputsResourcesFromOwner(request.inputs,\
  \ this.address)\n      ); // @audit-issue here we do not exclude ids we already got and used\
  \ for another transaction in the current block\n\n      request.addResources(resources);\n\
  \n      // [...]\n    }\n\n    // [...]\n\n    return request;\n  }\n```\n\n# Impact Details\n\
  \nThis issue will lead to unexpected SDK behaviour. Looking at the scenario in `Brief/Intro`,\
  \ it could have the following impacts for users:\n\n1. A transaction does not get included\
  \ in the `txpool` / in a block\n1. A previous transaction silently gets removed from the `txpool`\
  \ and replaced with a new one\n\n# Recommendation\n\nI would recommend adding a buffer to\
  \ the `Account` class, in which retrieved `resources` are saved. These can then be provided\
  \ to `getResourcesToSpend` to be excluded from future queries but need to be removed from\
  \ the buffer if their respective transaction fails to be included, in order to be able to\
  \ use those `resources` again in such cases.\n\n# Proof of Concept\n\nThe following PoC transfers\
  \ 100 coins from `wallet2` to `wallet` after which `wallet2` has two `UTXOs` one with value\
  \ `100` and one with a very high value (this is printed to the console). Afterwards, `wallet`\
  \ will attempt transfering `80` coins back to `wallet2` twice in one block, each in a separate\
  \ transaction. This should work perfectly fine as `wallet` has two `UTXOs` where each can\
  \ cover the cost of each respective transaction. Now when running this one of the following\
  \ will happen:\n\n1. both transfers from `wallet` to `wallet2` get a different `UTXO`. This\
  \ is the case if execution is successful and `wallet2` has `80` coins more than `wallet` in\
  \ the end.\n1. both transfers get the same `UTXO`. In this case the script will fail and throw\
  \ an error as then both transactions will have the same hash\n\nIn order to execute this PoC,\
  \ please deploy a local node with a blocktime of `5secs` as I wrote my PoC for that blocktime.\
  \ Note that with a small change it will also work with other blocktimes. Then add the PoC\
  \ to a file `poc_resources.ts` and compile it with `tsc poc_resources.ts`. Finally execute\
  \ it with `node poc_resources.js`.\n\nSince the choice which `UTXO` is taken as input is random,\
  \ it might take a few tries to trigger the bug!\n\n```ts\nimport { JsonAbi, Script, Provider,\
  \ WalletUnlocked, Account, Predicate, Wallet, CoinQuantityLike, coinQuantityfy, EstimatedTxParams,\
  \ BN, Coin, AbstractAddress, Address, Contract, ScriptTransactionRequest } from 'fuels';\n\
  \nconst abi: JsonAbi = {\n  'encoding': '1',\n  'types': [\n    {\n      'typeId': 0,\n  \
  \    'type': '()',\n      'components': [],\n      'typeParameters': null\n    }\n  ],\n \
  \ 'functions': [\n    {\n      'inputs': [],\n      'name': 'main',\n      'output': {\n \
  \       'name': '',\n        'type': 0,\n        'typeArguments': null\n      },\n      'attributes':\
  \ null\n    }\n  ],\n  'loggedTypes': [],\n  'messagesTypes': [],\n  'configurables': []\n\
  };\n\nconst FUEL_NETWORK_URL = 'http://127.0.0.1:4000/v1/graphql';\n\nasync function executeTransaction()\
  \ {\n\n  const provider = await Provider.create(FUEL_NETWORK_URL);\n  \n  const wallet: WalletUnlocked\
  \ = Wallet.fromPrivateKey('0x37fa81c84ccd547c30c176b118d5cb892bdb113e8e80141f266519422ef9eefd',\
  \ provider);\n  const wallet2: WalletUnlocked = Wallet.fromPrivateKey('0xde97d8624a438121b86a1956544bd72ed68cd69f2c99555b08b1e8c51ffd511c',\
  \ provider);\n  const sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve,\
  \ ms));\n\n\n  console.log(\"Balance wallet before: \", await wallet.getBalance());\n  console.log(\"\
  Balance wallet2 before: \", await wallet2.getBalance());\n\n  wallet2.transfer(wallet.address,\
  \ 100);\n\n  await sleep(5500);\n\n\n  await wallet.transfer(wallet2.address, 80);\n  console.log('wallet\
  \ -> wallet2');\n\n  await wallet.transfer(wallet2.address, 80);\n  console.log('wallet ->\
  \ wallet2');\n\n  console.log(\"Balance wallet after: \", await wallet.getBalance());\n  console.log(\"\
  Balance wallet2 after: \", await wallet2.getBalance());\n};\n\nexecuteTransaction().catch(console.error);\n\
  ```"
severities:
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10429'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10484'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10788'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10843'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10939'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10859'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10875'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10932'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.11287'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.09902'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10184'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10278'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10302'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10364'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10366'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10377'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00099'
    scoring_system: epss
    scoring_elements: '0.28951'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00099'
    scoring_system: epss
    scoring_elements: '0.28909'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00099'
    scoring_system: epss
    scoring_elements: '0.28849'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00099'
    scoring_system: epss
    scoring_elements: '0.28791'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00099'
    scoring_system: epss
    scoring_elements: '0.28831'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00099'
    scoring_system: epss
    scoring_elements: '0.28837'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00099'
    scoring_system: epss
    scoring_elements: '0.28834'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00099'
    scoring_system: epss
    scoring_elements: '0.28872'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00099'
    scoring_system: epss
    scoring_elements: '0.28889'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00099'
    scoring_system: epss
    scoring_elements: '0.28954'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00111'
    scoring_system: epss
    scoring_elements: '0.30782'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00111'
    scoring_system: epss
    scoring_elements: '0.30753'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00111'
    scoring_system: epss
    scoring_elements: '0.30799'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00111'
    scoring_system: epss
    scoring_elements: '0.3074'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00114'
    scoring_system: epss
    scoring_elements: '0.18553'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00136'
    scoring_system: epss
    scoring_elements: '0.30173'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00136'
    scoring_system: epss
    scoring_elements: '0.30218'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00136'
    scoring_system: epss
    scoring_elements: '0.30325'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00136'
    scoring_system: epss
    scoring_elements: '0.3034'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00148'
    scoring_system: epss
    scoring_elements: '0.32118'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00148'
    scoring_system: epss
    scoring_elements: '0.32149'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00148'
    scoring_system: epss
    scoring_elements: '0.32163'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00148'
    scoring_system: epss
    scoring_elements: '0.32133'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00148'
    scoring_system: epss
    scoring_elements: '0.32116'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00148'
    scoring_system: epss
    scoring_elements: '0.32091'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00148'
    scoring_system: epss
    scoring_elements: '0.32082'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00148'
    scoring_system: epss
    scoring_elements: '0.32073'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00148'
    scoring_system: epss
    scoring_elements: '0.32097'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00148'
    scoring_system: epss
    scoring_elements: '0.32137'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: '0.00148'
    scoring_system: epss
    scoring_elements: '0.32113'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
  - score: LOW
    scoring_system: cvssv3.1_qr
    scoring_elements:
    published_at: None
    url: https://github.com/advisories/GHSA-3jcg-vx7f-j6qf
  - score: '3.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:N/I:L/A:N
    published_at: None
    url: https://github.com/FuelLabs/fuels-ts
  - score: LOW
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/FuelLabs/fuels-ts
  - score: '3.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:N/I:L/A:N
    published_at: None
    url: https://github.com/FuelLabs/fuels-ts/commit/16ee1bfe66733551d00f0a76c21e8a09ea33006f
  - score: LOW
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/FuelLabs/fuels-ts/commit/16ee1bfe66733551d00f0a76c21e8a09ea33006f
  - score: '3.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:N/I:L/A:N
    published_at: None
    url: https://github.com/FuelLabs/fuels-ts/security/advisories/GHSA-3jcg-vx7f-j6qf
  - score: LOW
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/FuelLabs/fuels-ts/security/advisories/GHSA-3jcg-vx7f-j6qf
  - score: '3.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:N/I:L/A:N
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-41945
  - score: LOW
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-41945
weaknesses:
  - CWE-20
  - CWE-937
  - CWE-1035
references:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-41945
    reference_type:
    reference_id:
  - url: https://github.com/FuelLabs/fuels-ts
    reference_type:
    reference_id:
  - url: https://github.com/FuelLabs/fuels-ts/commit/16ee1bfe66733551d00f0a76c21e8a09ea33006f
    reference_type:
    reference_id:
  - url: https://github.com/FuelLabs/fuels-ts/security/advisories/GHSA-3jcg-vx7f-j6qf
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-41945
    reference_type:
    reference_id:
  - url: https://github.com/advisories/GHSA-3jcg-vx7f-j6qf
    reference_type:
    reference_id: GHSA-3jcg-vx7f-j6qf
