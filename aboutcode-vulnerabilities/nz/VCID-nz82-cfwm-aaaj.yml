vulnerability_id: VCID-nz82-cfwm-aaaj
aliases:
  - CVE-2021-46925
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  net/smc: fix kernel panic caused by race of smc_sock

  A crash occurs when smc_cdc_tx_handler() tries to access smc_sock
  but smc_release() has already freed it.

  [ 4570.695099] BUG: unable to handle page fault for address: 000000002eae9e88
  [ 4570.696048] #PF: supervisor write access in kernel mode
  [ 4570.696728] #PF: error_code(0x0002) - not-present page
  [ 4570.697401] PGD 0 P4D 0
  [ 4570.697716] Oops: 0002 [#1] PREEMPT SMP NOPTI
  [ 4570.698228] CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.16.0-rc4+ #111
  [ 4570.699013] Hardware name: Alibaba Cloud Alibaba Cloud ECS, BIOS 8c24b4c 04/0
  [ 4570.699933] RIP: 0010:_raw_spin_lock+0x1a/0x30
  <...>
  [ 4570.711446] Call Trace:
  [ 4570.711746]  <IRQ>
  [ 4570.711992]  smc_cdc_tx_handler+0x41/0xc0
  [ 4570.712470]  smc_wr_tx_tasklet_fn+0x213/0x560
  [ 4570.712981]  ? smc_cdc_tx_dismisser+0x10/0x10
  [ 4570.713489]  tasklet_action_common.isra.17+0x66/0x140
  [ 4570.714083]  __do_softirq+0x123/0x2f4
  [ 4570.714521]  irq_exit_rcu+0xc4/0xf0
  [ 4570.714934]  common_interrupt+0xba/0xe0

  Though smc_cdc_tx_handler() checked the existence of smc connection,
  smc_release() may have already dismissed and released the smc socket
  before smc_cdc_tx_handler() further visits it.

  smc_cdc_tx_handler()           |smc_release()
  if (!conn)                     |
                                 |
                                 |smc_cdc_tx_dismiss_slots()
                                 |      smc_cdc_tx_dismisser()
                                 |
                                 |sock_put(&smc->sk) <- last sock_put,
                                 |                      smc_sock freed
  bh_lock_sock(&smc->sk) (panic) |

  To make sure we won't receive any CDC messages after we free the
  smc_sock, add a refcount on the smc_connection for inflight CDC
  message(posted to the QP but haven't received related CQE), and
  don't release the smc_connection until all the inflight CDC messages
  haven been done, for both success or failed ones.

  Using refcount on CDC messages brings another problem: when the link
  is going to be destroyed, smcr_link_clear() will reset the QP, which
  then remove all the pending CQEs related to the QP in the CQ. To make
  sure all the CQEs will always come back so the refcount on the
  smc_connection can always reach 0, smc_ib_modify_qp_reset() was replaced
  by smc_ib_modify_qp_error().
  And remove the timeout in smc_wr_tx_wait_no_pending_sends() since we
  need to wait for all pending WQEs done, or we may encounter use-after-
  free when handling CQEs.

  For IB device removal routine, we need to wait for all the QPs on that
  device been destroyed before we can destroy CQs on the device, or
  the refcount on smc_connection won't reach 0 and smc_sock cannot be
  released.
severities:
  - score: '4.7'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2021-46925.json
  - score: '0.0003'
    scoring_system: epss
    scoring_elements: '0.05441'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.0003'
    scoring_system: epss
    scoring_elements: '0.05472'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.0003'
    scoring_system: epss
    scoring_elements: '0.05453'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.0003'
    scoring_system: epss
    scoring_elements: '0.05446'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.0003'
    scoring_system: epss
    scoring_elements: '0.05418'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05115'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05108'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05105'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05100'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05091'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05073'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05065'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05058'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05119'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05128'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05124'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '0.00128'
    scoring_system: epss
    scoring_elements: '0.20286'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00389'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00391'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00392'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.0039'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00283'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00288'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.0029'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00289'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00287'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00284'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00375'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00377'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00374'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00372'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00369'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: 7e-05
    scoring_system: epss
    scoring_elements: '0.00395'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
  - score: '4.7'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '4.7'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-46925
  - score: '4.7'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-46925
weaknesses:
  - CWE-362
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2021-46925.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2021-46925
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-46925
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/349d43127dac00c15231e8ffbcaabd70f7b0e544
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b85f751d71ae8e2a15e9bda98852ea9af35282eb
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/e8a5988a85c719ce7205cb00dcf0716dcf611332
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2266375
    reference_type:
    reference_id: 2266375
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-46925
    reference_type:
    reference_id: CVE-2021-46925
