vulnerability_id: VCID-xpks-szv4-fqbg
aliases:
  - CVE-2024-22036
  - GHSA-h99m-6755-rgwc
summary: "Rancher Remote Code Execution via Cluster/Node Drivers\n### Impact\nA vulnerability\
  \ has been identified within Rancher where a cluster or node driver can be used to escape\
  \ the `chroot` jail and gain root access to the Rancher container itself. In production environments,\
  \ further privilege escalation is possible based on living off the land within the Rancher\
  \ container itself. For the test and development environments, based on a â€“privileged Docker\
  \ container, it is possible to escape the Docker container and gain execution access on the\
  \ host system. \n\nThis happens because:\n- During startup, Rancher appends the `/opt/drivers/management-state/bin`\
  \ directory to the `PATH` environment variable.\n- In Rancher, the binaries `/usr/bin/rancher-machine`,\
  \ `/usr/bin/helm_v3`, and `/usr/bin/kustomize` are assigned a UID of 1001 and a GID of 127\
  \ instead of being owned by the root user.\n- Rancher employs a jail mechanism to isolate\
  \ the execution of node drivers from the main process. However, the drivers are executed with\
  \ excessive permissions.\n- During the registration of new node drivers, its binary is executed\
  \ with the same user as the parent process, which could enable an attacker to gain elevated\
  \ privileges by registering a malicious driver.\n- Lack of validation on the driver file type,\
  \ which allows symbolic links to be used.\n\n\nPlease consult the associated  [MITRE ATT&CK\
  \ - Technique - Privilege Escalation](https://attack.mitre.org/tactics/TA0004/) and [MITRE\
  \ ATT&CK - Technique - Execution](https://attack.mitre.org/tactics/TA0002/) for further information\
  \ about this category of attack.\n\n**Since they run at a privileged level, it is recommended\
  \ to use trusted drivers only.**\n\n### Patches\nThe fix involves some key areas with the\
  \ following changes:\n\nFixing the `PATH` environment variable:\n- Remove the step that appends\
  \ `/opt/drivers/management-state/bin` to the `PATH` environment variable.\n\nBinaries permissions:\n\
  - Correct the permission of the binaries `/usr/bin/rancher-machine`, `/usr/bin/helm_v3`, and\
  \ `/usr/bin/kustomize` so that they are owned by the root user.\n\nImproving Rancher jail\
  \ security mechanism:\n- A new group `jail-accessors` has been created, and the rancher user\
  \ has been added to this group.\n- The `jail-accessors` group is granted read and execute\
  \ permissions for the directories `/var/lib/rancher`, `/var/lib/cattle`, and `/usr/local/bin`.\n\
  - The jail mechanism has been enhanced to execute commands using the non-root `rancher` user\
  \ and the `jail-accessors` group. Additionally, a new setting, `UnprivilegedJailUser`, has\
  \ been introduced to manage this behavior, allowing users to opt-out if they need to run drivers\
  \ in a more privileged context.\n- Limit the devices copied to the jail directory to a minimal\
  \ set.\n\nFixing node driver registration:\n- The `NewPlugin(driver)` function in the `rancher/machine`\
  \ module has been updated to allow setting the UID and GID for starting the plugin server.\
  \ If the environment variables `MACHINE_PLUGIN_UID` and `MACHINE_PLUGIN_GID` are set, their\
  \ values will be used to configure the user credentials for launching the plugin server. \n\
  - Rancher now sets these environment variables with a non-root UID and GID before invoking\
  \ the `NewPlugin(driver)` function and then unsets them after retrieving the creation flags.\n\
  \nImprovements on driver package:\n- The `driver` package has been revised to verify that\
  \ the downloaded driver binary is a regular file.\n- The `driver` package has been revised\
  \ to verify that the target file in the downloaded tar file is a regular file.\n- The `driver`\
  \ package now executes the downloaded driver binary within a jail, with a default timeout\
  \ of 5 seconds.\n\nOther improvements:\n- The helm package has been updated to ensure appropriate\
  \ permissions are set on the generated kubeconfig file.\n- The `nodeConfig` package has been\
  \ updated to ensure proper permissions are applied when extracting the node configuration.\n\
  \nPatched versions include releases `2.7.16`, `2.8.9` and `2.9.3`.\n\n### Workarounds\nIf\
  \ you can't upgrade to a fixed version, please make sure that:\n1. Drivers are only executed\
  \ from trusted sources.\n2. The use of Admins/Restricted Admins is limited to trusted users.\n\
  \n\n### References\nIf you have any questions or comments about this advisory:\n- Reach out\
  \ to the [SUSE Rancher Security team](https://github.com/rancher/rancher/security/policy)\
  \ for security related inquiries.\n- Open an issue in the [Rancher](https://github.com/rancher/rancher/issues/new/choose)\
  \ repository.\n- Verify with our [support matrix](https://www.suse.com/suse-rancher/support-matrix/all-supported-versions/)\
  \ and [product support lifecycle](https://www.suse.com/lifecycle/)."
severities:
  - score: '0.00041'
    scoring_system: epss
    scoring_elements: '0.11758'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '0.00041'
    scoring_system: epss
    scoring_elements: '0.11937'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '0.00041'
    scoring_system: epss
    scoring_elements: '0.11861'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15568'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15592'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.15615'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.19058'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.19025'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.19038'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.19047'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.19066'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.19074'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '0.0006'
    scoring_system: epss
    scoring_elements: '0.19068'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
  - score: '9.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H
    published_at: None
    url: https://bugzilla.suse.com/show_bug.cgi?id=CVE-2024-22036
  - score: CRITICAL
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://bugzilla.suse.com/show_bug.cgi?id=CVE-2024-22036
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:T/P:M/B:A/M:M/D:T/2025-04-16T14:19:34Z/
    published_at: None
    url: https://bugzilla.suse.com/show_bug.cgi?id=CVE-2024-22036
  - score: '9.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H
    published_at: None
    url: https://github.com/rancher/rancher
  - score: CRITICAL
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/rancher/rancher
  - score: '9.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H
    published_at: None
    url: https://github.com/rancher/rancher/security/advisories/GHSA-h99m-6755-rgwc
  - score: CRITICAL
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/rancher/rancher/security/advisories/GHSA-h99m-6755-rgwc
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:T/P:M/B:A/M:M/D:T/2025-04-16T14:19:34Z/
    published_at: None
    url: https://github.com/rancher/rancher/security/advisories/GHSA-h99m-6755-rgwc
  - score: '9.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-22036
  - score: CRITICAL
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-22036
weaknesses:
  - CWE-269
references:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-22036
    reference_type:
    reference_id:
  - url: https://bugzilla.suse.com/show_bug.cgi?id=CVE-2024-22036
    reference_type:
    reference_id:
  - url: https://github.com/rancher/rancher
    reference_type:
    reference_id:
  - url: https://github.com/rancher/rancher/security/advisories/GHSA-h99m-6755-rgwc
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-22036
    reference_type:
    reference_id:
