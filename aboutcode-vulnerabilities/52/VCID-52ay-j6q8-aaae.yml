vulnerability_id: VCID-52ay-j6q8-aaae
aliases:
  - CVE-2024-26944
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: zoned: fix use-after-free in do_zone_finish()

  Shinichiro reported the following use-after-free triggered by the device
  replace operation in fstests btrfs/070.

   BTRFS info (device nullb1): scrub: finished on devid 1 with status: 0
   ==================================================================
   BUG: KASAN: slab-use-after-free in do_zone_finish+0x91a/0xb90 [btrfs]
   Read of size 8 at addr ffff8881543c8060 by task btrfs-cleaner/3494007

   CPU: 0 PID: 3494007 Comm: btrfs-cleaner Tainted: G        W          6.8.0-rc5-kts #1
   Hardware name: Supermicro Super Server/X11SPi-TF, BIOS 3.3 02/21/2020
   Call Trace:
    <TASK>
    dump_stack_lvl+0x5b/0x90
    print_report+0xcf/0x670
    ? __virt_addr_valid+0x200/0x3e0
    kasan_report+0xd8/0x110
    ? do_zone_finish+0x91a/0xb90 [btrfs]
    ? do_zone_finish+0x91a/0xb90 [btrfs]
    do_zone_finish+0x91a/0xb90 [btrfs]
    btrfs_delete_unused_bgs+0x5e1/0x1750 [btrfs]
    ? __pfx_btrfs_delete_unused_bgs+0x10/0x10 [btrfs]
    ? btrfs_put_root+0x2d/0x220 [btrfs]
    ? btrfs_clean_one_deleted_snapshot+0x299/0x430 [btrfs]
    cleaner_kthread+0x21e/0x380 [btrfs]
    ? __pfx_cleaner_kthread+0x10/0x10 [btrfs]
    kthread+0x2e3/0x3c0
    ? __pfx_kthread+0x10/0x10
    ret_from_fork+0x31/0x70
    ? __pfx_kthread+0x10/0x10
    ret_from_fork_asm+0x1b/0x30
    </TASK>

   Allocated by task 3493983:
    kasan_save_stack+0x33/0x60
    kasan_save_track+0x14/0x30
    __kasan_kmalloc+0xaa/0xb0
    btrfs_alloc_device+0xb3/0x4e0 [btrfs]
    device_list_add.constprop.0+0x993/0x1630 [btrfs]
    btrfs_scan_one_device+0x219/0x3d0 [btrfs]
    btrfs_control_ioctl+0x26e/0x310 [btrfs]
    __x64_sys_ioctl+0x134/0x1b0
    do_syscall_64+0x99/0x190
    entry_SYSCALL_64_after_hwframe+0x6e/0x76

   Freed by task 3494056:
    kasan_save_stack+0x33/0x60
    kasan_save_track+0x14/0x30
    kasan_save_free_info+0x3f/0x60
    poison_slab_object+0x102/0x170
    __kasan_slab_free+0x32/0x70
    kfree+0x11b/0x320
    btrfs_rm_dev_replace_free_srcdev+0xca/0x280 [btrfs]
    btrfs_dev_replace_finishing+0xd7e/0x14f0 [btrfs]
    btrfs_dev_replace_by_ioctl+0x1286/0x25a0 [btrfs]
    btrfs_ioctl+0xb27/0x57d0 [btrfs]
    __x64_sys_ioctl+0x134/0x1b0
    do_syscall_64+0x99/0x190
    entry_SYSCALL_64_after_hwframe+0x6e/0x76

   The buggy address belongs to the object at ffff8881543c8000
    which belongs to the cache kmalloc-1k of size 1024
   The buggy address is located 96 bytes inside of
    freed 1024-byte region [ffff8881543c8000, ffff8881543c8400)

   The buggy address belongs to the physical page:
   page:00000000fe2c1285 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x1543c8
   head:00000000fe2c1285 order:3 entire_mapcount:0 nr_pages_mapped:0 pincount:0
   flags: 0x17ffffc0000840(slab|head|node=0|zone=2|lastcpupid=0x1fffff)
   page_type: 0xffffffff()
   raw: 0017ffffc0000840 ffff888100042dc0 ffffea0019e8f200 dead000000000002
   raw: 0000000000000000 0000000000100010 00000001ffffffff 0000000000000000
   page dumped because: kasan: bad access detected

   Memory state around the buggy address:
    ffff8881543c7f00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    ffff8881543c7f80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   >ffff8881543c8000: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
                                                          ^
    ffff8881543c8080: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    ffff8881543c8100: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb

  This UAF happens because we're accessing stale zone information of a
  already removed btrfs_device in do_zone_finish().

  The sequence of events is as follows:

  btrfs_dev_replace_start
    btrfs_scrub_dev
     btrfs_dev_replace_finishing
      btrfs_dev_replace_update_device_in_mapping_tree <-- devices replaced
      btrfs_rm_dev_replace_free_srcdev
       btrfs_free_device                              <-- device freed

  cleaner_kthread
   btrfs_delete_unused_bgs
    btrfs_zone_finish
     do_zone_finish              <-- refers the freed device

  The reason for this is that we're using a
  ---truncated---
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-26944.json
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.09902'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10184'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10278'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10302'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10364'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10366'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10377'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10429'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10484'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10788'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10843'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10939'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10859'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10875'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.10932'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.11287'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13136'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.18368'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.18214'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.18314'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.18389'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.1838'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.18365'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.18339'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.18332'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.18344'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.1835'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.18371'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.18376'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.00058'
    scoring_system: epss
    scoring_elements: '0.18369'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.2099'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.2095'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20938'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20911'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20849'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.2093'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20948'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20989'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20799'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20952'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.2097'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20986'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20983'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20942'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.2091'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '0.0035'
    scoring_system: epss
    scoring_elements: '0.40637'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
  - score: '6.4'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-26944
weaknesses:
  - CWE-416
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-26944.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-26944
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-26944
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/1ec17ef59168a1a6f1105f5dc517f783839a5302
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/34ca809e055eca5cfe63d9c7efbf80b7c21b4e57
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2278210
    reference_type:
    reference_id: 2278210
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.9:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.9:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-26944
    reference_type:
    reference_id: CVE-2024-26944
  - url: https://usn.ubuntu.com/6816-1/
    reference_type:
    reference_id: USN-6816-1
  - url: https://usn.ubuntu.com/6817-1/
    reference_type:
    reference_id: USN-6817-1
  - url: https://usn.ubuntu.com/6817-2/
    reference_type:
    reference_id: USN-6817-2
  - url: https://usn.ubuntu.com/6817-3/
    reference_type:
    reference_id: USN-6817-3
  - url: https://usn.ubuntu.com/6878-1/
    reference_type:
    reference_id: USN-6878-1
