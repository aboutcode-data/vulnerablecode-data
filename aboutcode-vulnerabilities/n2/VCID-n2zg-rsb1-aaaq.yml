vulnerability_id: VCID-n2zg-rsb1-aaaq
aliases:
  - CVE-2021-46978
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  KVM: nVMX: Always make an attempt to map eVMCS after migration

  When enlightened VMCS is in use and nested state is migrated with
  vmx_get_nested_state()/vmx_set_nested_state() KVM can't map evmcs
  page right away: evmcs gpa is not 'struct kvm_vmx_nested_state_hdr'
  and we can't read it from VP assist page because userspace may decide
  to restore HV_X64_MSR_VP_ASSIST_PAGE after restoring nested state
  (and QEMU, for example, does exactly that). To make sure eVMCS is
  mapped /vmx_set_nested_state() raises KVM_REQ_GET_NESTED_STATE_PAGES
  request.

  Commit f2c7ef3ba955 ("KVM: nSVM: cancel KVM_REQ_GET_NESTED_STATE_PAGES
  on nested vmexit") added KVM_REQ_GET_NESTED_STATE_PAGES clearing to
  nested_vmx_vmexit() to make sure MSR permission bitmap is not switched
  when an immediate exit from L2 to L1 happens right after migration (caused
  by a pending event, for example). Unfortunately, in the exact same
  situation we still need to have eVMCS mapped so
  nested_sync_vmcs12_to_shadow() reflects changes in VMCS12 to eVMCS.

  As a band-aid, restore nested_get_evmcs_page() when clearing
  KVM_REQ_GET_NESTED_STATE_PAGES in nested_vmx_vmexit(). The 'fix' is far
  from being ideal as we can't easily propagate possible failures and even if
  we could, this is most likely already too late to do so. The whole
  'KVM_REQ_GET_NESTED_STATE_PAGES' idea for mapping eVMCS after migration
  seems to be fragile as we diverge too much from the 'native' path when
  vmptr loading happens on vmx_set_nested_state().
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2021-46978.json
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.1025'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16947'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17624'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17338'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17315'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17350'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17830'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17732'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17645'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17041'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17069'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17147'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17142'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17164'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17329'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17226'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16666'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14224'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.11554'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.11528'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.11492'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.11463'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.11404'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14075'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14135'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14229'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14313'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14314'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14282'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14249'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.1424'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.1422'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14248'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14254'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.14242'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.11527'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00047'
    scoring_system: epss
    scoring_elements: '0.11532'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12517'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12716'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.1274'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.127'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12662'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12657'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.0005'
    scoring_system: epss
    scoring_elements: '0.12492'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '0.00212'
    scoring_system: epss
    scoring_elements: '0.29606'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://git.kernel.org/stable/c/200a45649ab7361bc80c70aebf7165b64f9a6c9f
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:T/P:M/B:A/M:M/D:T/2024-11-04T17:39:28Z/
    published_at: None
    url: https://git.kernel.org/stable/c/200a45649ab7361bc80c70aebf7165b64f9a6c9f
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://git.kernel.org/stable/c/bd0e8455b85b651a4c77de9616e307129b15aaa7
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:T/P:M/B:A/M:M/D:T/2024-11-04T17:39:28Z/
    published_at: None
    url: https://git.kernel.org/stable/c/bd0e8455b85b651a4c77de9616e307129b15aaa7
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://git.kernel.org/stable/c/c8bf64e3fb77cc19bad146fbe26651985b117194
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:T/P:M/B:A/M:M/D:T/2024-11-04T17:39:28Z/
    published_at: None
    url: https://git.kernel.org/stable/c/c8bf64e3fb77cc19bad146fbe26651985b117194
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://git.kernel.org/stable/c/f5c7e8425f18fdb9bdb7d13340651d7876890329
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:T/P:M/B:A/M:M/D:T/2024-11-04T17:39:28Z/
    published_at: None
    url: https://git.kernel.org/stable/c/f5c7e8425f18fdb9bdb7d13340651d7876890329
weaknesses:
  - CWE-20
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2021-46978.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2021-46978
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-46978
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/200a45649ab7361bc80c70aebf7165b64f9a6c9f
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/bd0e8455b85b651a4c77de9616e307129b15aaa7
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c8bf64e3fb77cc19bad146fbe26651985b117194
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f5c7e8425f18fdb9bdb7d13340651d7876890329
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2266919
    reference_type:
    reference_id: 2266919
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.13:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.13:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-46978
    reference_type:
    reference_id: CVE-2021-46978
