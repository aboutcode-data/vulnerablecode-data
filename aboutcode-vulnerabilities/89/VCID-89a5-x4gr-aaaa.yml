vulnerability_id: VCID-89a5-x4gr-aaaa
aliases:
  - CVE-2023-52474
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  IB/hfi1: Fix bugs with non-PAGE_SIZE-end multi-iovec user SDMA requests

  hfi1 user SDMA request processing has two bugs that can cause data
  corruption for user SDMA requests that have multiple payload iovecs
  where an iovec other than the tail iovec does not run up to the page
  boundary for the buffer pointed to by that iovec.a

  Here are the specific bugs:
  1. user_sdma_txadd() does not use struct user_sdma_iovec->iov.iov_len.
     Rather, user_sdma_txadd() will add up to PAGE_SIZE bytes from iovec
     to the packet, even if some of those bytes are past
     iovec->iov.iov_len and are thus not intended to be in the packet.
  2. user_sdma_txadd() and user_sdma_send_pkts() fail to advance to the
     next iovec in user_sdma_request->iovs when the current iovec
     is not PAGE_SIZE and does not contain enough data to complete the
     packet. The transmitted packet will contain the wrong data from the
     iovec pages.

  This has not been an issue with SDMA packets from hfi1 Verbs or PSM2
  because they only produce iovecs that end short of PAGE_SIZE as the tail
  iovec of an SDMA request.

  Fixing these bugs exposes other bugs with the SDMA pin cache
  (struct mmu_rb_handler) that get in way of supporting user SDMA requests
  with multiple payload iovecs whose buffers do not end at PAGE_SIZE. So
  this commit fixes those issues as well.

  Here are the mmu_rb_handler bugs that non-PAGE_SIZE-end multi-iovec
  payload user SDMA requests can hit:
  1. Overlapping memory ranges in mmu_rb_handler will result in duplicate
     pinnings.
  2. When extending an existing mmu_rb_handler entry (struct mmu_rb_node),
     the mmu_rb code (1) removes the existing entry under a lock, (2)
     releases that lock, pins the new pages, (3) then reacquires the lock
     to insert the extended mmu_rb_node.

     If someone else comes in and inserts an overlapping entry between (2)
     and (3), insert in (3) will fail.

     The failure path code in this case unpins _all_ pages in either the
     original mmu_rb_node or the new mmu_rb_node that was inserted between
     (2) and (3).
  3. In hfi1_mmu_rb_remove_unless_exact(), mmu_rb_node->refcount is
     incremented outside of mmu_rb_handler->lock. As a result, mmu_rb_node
     could be evicted by another thread that gets mmu_rb_handler->lock and
     checks mmu_rb_node->refcount before mmu_rb_node->refcount is
     incremented.
  4. Related to #2 above, SDMA request submission failure path does not
     check mmu_rb_node->refcount before freeing mmu_rb_node object.

     If there are other SDMA requests in progress whose iovecs have
     pointers to the now-freed mmu_rb_node(s), those pointers to the
     now-freed mmu_rb nodes will be dereferenced when those SDMA requests
     complete.
severities:
  - score: '0.00013'
    scoring_system: epss
    scoring_elements: '0.01309'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00013'
    scoring_system: epss
    scoring_elements: '0.01297'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00013'
    scoring_system: epss
    scoring_elements: '0.01292'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00013'
    scoring_system: epss
    scoring_elements: '0.01296'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00013'
    scoring_system: epss
    scoring_elements: '0.01306'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00013'
    scoring_system: epss
    scoring_elements: '0.01319'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00013'
    scoring_system: epss
    scoring_elements: '0.01312'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00013'
    scoring_system: epss
    scoring_elements: '0.01313'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00013'
    scoring_system: epss
    scoring_elements: '0.01322'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00013'
    scoring_system: epss
    scoring_elements: '0.01308'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05058'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05073'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05128'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05124'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05115'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05119'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05108'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05105'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05100'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05091'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05065'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23568'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23537'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23553'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23579'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23611'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23603'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23561'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23545'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.2352'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23618'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23614'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23609'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23589'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23442'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00092'
    scoring_system: epss
    scoring_elements: '0.23508'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '0.00389'
    scoring_system: epss
    scoring_elements: '0.4309'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
  - score: '3.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '7.8'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2023-52474
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2023-52474
weaknesses: []
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2023-52474.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2023-52474
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-52474
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/00cbce5cbf88459cd1aa1d60d0f1df15477df127
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/7e6010f79b58f45b204cf18aa58f4b73c3f30adc
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/9c4c6512d7330b743c4ffd18bd999a86ca26db0d
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a2bd706ab63509793b5cd5065e685b7ef5cba678
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c76cb8f4bdf26d04cfa5485a93ce297dba5e6a80
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/dce59b5443700fbd0d2433ec6e4d4cf063448844
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2266278
    reference_type:
    reference_id: 2266278
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-52474
    reference_type:
    reference_id: CVE-2023-52474
