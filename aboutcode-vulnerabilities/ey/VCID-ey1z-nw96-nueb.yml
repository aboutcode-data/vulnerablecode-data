vulnerability_id: VCID-ey1z-nw96-nueb
aliases:
  - CVE-2023-52896
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: fix race between quota rescan and disable leading to NULL pointer deref

  If we have one task trying to start the quota rescan worker while another
  one is trying to disable quotas, we can end up hitting a race that results
  in the quota rescan worker doing a NULL pointer dereference. The steps for
  this are the following:

  1) Quotas are enabled;

  2) Task A calls the quota rescan ioctl and enters btrfs_qgroup_rescan().
     It calls qgroup_rescan_init() which returns 0 (success) and then joins a
     transaction and commits it;

  3) Task B calls the quota disable ioctl and enters btrfs_quota_disable().
     It clears the bit BTRFS_FS_QUOTA_ENABLED from fs_info->flags and calls
     btrfs_qgroup_wait_for_completion(), which returns immediately since the
     rescan worker is not yet running.
     Then it starts a transaction and locks fs_info->qgroup_ioctl_lock;

  4) Task A queues the rescan worker, by calling btrfs_queue_work();

  5) The rescan worker starts, and calls rescan_should_stop() at the start
     of its while loop, which results in 0 iterations of the loop, since
     the flag BTRFS_FS_QUOTA_ENABLED was cleared from fs_info->flags by
     task B at step 3);

  6) Task B sets fs_info->quota_root to NULL;

  7) The rescan worker tries to start a transaction and uses
     fs_info->quota_root as the root argument for btrfs_start_transaction().
     This results in a NULL pointer dereference down the call chain of
     btrfs_start_transaction(). The stack trace is something like the one
     reported in Link tag below:

     general protection fault, probably for non-canonical address 0xdffffc0000000041: 0000 [#1] PREEMPT SMP KASAN
     KASAN: null-ptr-deref in range [0x0000000000000208-0x000000000000020f]
     CPU: 1 PID: 34 Comm: kworker/u4:2 Not tainted 6.1.0-syzkaller-13872-gb6bb9676f216 #0
     Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 10/26/2022
     Workqueue: btrfs-qgroup-rescan btrfs_work_helper
     RIP: 0010:start_transaction+0x48/0x10f0 fs/btrfs/transaction.c:564
     Code: 48 89 fb 48 (...)
     RSP: 0018:ffffc90000ab7ab0 EFLAGS: 00010206
     RAX: 0000000000000041 RBX: 0000000000000208 RCX: ffff88801779ba80
     RDX: 0000000000000000 RSI: 0000000000000001 RDI: 0000000000000000
     RBP: dffffc0000000000 R08: 0000000000000001 R09: fffff52000156f5d
     R10: fffff52000156f5d R11: 1ffff92000156f5c R12: 0000000000000000
     R13: 0000000000000001 R14: 0000000000000001 R15: 0000000000000003
     FS:  0000000000000000(0000) GS:ffff8880b9900000(0000) knlGS:0000000000000000
     CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
     CR2: 00007f2bea75b718 CR3: 000000001d0cc000 CR4: 00000000003506e0
     DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
     DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
     Call Trace:
      <TASK>
      btrfs_qgroup_rescan_worker+0x3bb/0x6a0 fs/btrfs/qgroup.c:3402
      btrfs_work_helper+0x312/0x850 fs/btrfs/async-thread.c:280
      process_one_work+0x877/0xdb0 kernel/workqueue.c:2289
      worker_thread+0xb14/0x1330 kernel/workqueue.c:2436
      kthread+0x266/0x300 kernel/kthread.c:376
      ret_from_fork+0x1f/0x30 arch/x86/entry/entry_64.S:308
      </TASK>
     Modules linked in:

  So fix this by having the rescan worker function not attempt to start a
  transaction if it didn't do any rescan work.
severities:
  - score: '4.7'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2023-52896.json
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06691'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06439'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06444'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.0643'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06435'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06477'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06491'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06509'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06503'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06548'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06454'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06429'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06683'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00029'
    scoring_system: epss
    scoring_elements: '0.06629'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05065'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05128'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05124'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05115'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05119'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05108'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05105'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05100'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05091'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05073'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05058'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13859'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13863'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13836'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13817'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13761'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13829'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13813'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13798'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13811'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13831'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13792'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13758'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13745'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13584'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00053'
    scoring_system: epss
    scoring_elements: '0.13619'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '0.00226'
    scoring_system: epss
    scoring_elements: '0.30842'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '4.7'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2023-52896
  - score: '4.7'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2023-52896
weaknesses:
  - CWE-476
  - CWE-362
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2023-52896.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2023-52896
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-52896
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/1004fc90f0d79a4b7d9e3d432729914f472f9ad1
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/3bd43374857103ba3cac751d6d4afa8d83b5d92a
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/64287cd456a22373053998c1fccf14b651e9cbbd
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/89ac597e3e807b91e2ebd6a7c36fec7b97290233
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b7adbf9ada3513d2092362c8eac5cddc5b651f5c
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2306424
    reference_type:
    reference_id: 2306424
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-52896
    reference_type:
    reference_id: CVE-2023-52896
