vulnerability_id: VCID-qkxs-afur-kfgm
aliases:
  - CVE-2025-22077
summary: "In the Linux kernel, the following vulnerability has been resolved:\n\nsmb: client:\
  \ Fix netns refcount imbalance causing leaks and use-after-free\n\nCommit ef7134c7fc48 (\"\
  smb: client: Fix use-after-free of network\nnamespace.\") attempted to fix a netns use-after-free\
  \ issue by manually\nadjusting reference counts via sk->sk_net_refcnt and sock_inuse_add().\n\
  \nHowever, a later commit e9f2517a3e18 (\"smb: client: fix TCP timers deadlock\nafter rmmod\"\
  ) pointed out that the approach of manually setting\nsk->sk_net_refcnt in the first commit\
  \ was technically incorrect, as\nsk->sk_net_refcnt should only be set for user sockets. It\
  \ led to issues\nlike TCP timers not being cleared properly on close. The second commit\n\
  moved to a model of just holding an extra netns reference for\nserver->ssocket using get_net(),\
  \ and dropping it when the server is torn\ndown.\n\nBut there remain some gaps in the get_net()/put_net()\
  \ balancing added by\nthese commits. The incomplete reference handling in these fixes results\n\
  in two issues:\n\n1. Netns refcount leaks[1]\n\nThe problem process is as follows:\n\n```\n\
  mount.cifs                        cifsd\n\ncifs_do_mount\n  cifs_mount\n    cifs_mount_get_session\n\
  \      cifs_get_tcp_session\n        get_net()  /* First get net. */\n        ip_connect\n\
  \          generic_ip_connect /* Try port 445 */\n            get_net()\n            ->connect()\
  \ /* Failed */\n            put_net()\n          generic_ip_connect /* Try port 139 */\n \
  \           get_net() /* Missing matching put_net() for this get_net().*/\n      cifs_get_smb_ses\n\
  \        cifs_negotiate_protocol\n          smb2_negotiate\n            SMB2_negotiate\n \
  \             cifs_send_recv\n                wait_for_response\n                        \
  \         cifs_demultiplex_thread\n                                   cifs_read_from_socket\n\
  \                                     cifs_readv_from_socket\n                           \
  \            cifs_reconnect\n                                         cifs_abort_connection\n\
  \                                           sock_release();\n                            \
  \               server->ssocket = NULL;\n                                           /* Missing\
  \ put_net() here. */\n                                           generic_ip_connect\n    \
  \                                         get_net()\n                                    \
  \         ->connect() /* Failed */\n                                             put_net()\n\
  \                                             sock_release();\n                          \
  \                   server->ssocket = NULL;\n          free_rsp_buf\n    ...\n           \
  \                        clean_demultiplex_info\n                                     /* It's\
  \ only called once here. */\n                                     put_net()\n```\n\nWhen cifs_reconnect()\
  \ is triggered, the server->ssocket is released\nwithout a corresponding put_net() for the\
  \ reference acquired in\ngeneric_ip_connect() before. it ends up calling generic_ip_connect()\n\
  again to retry get_net(). After that, server->ssocket is set to NULL\nin the error path of\
  \ generic_ip_connect(), and the net count cannot be\nreleased in the final clean_demultiplex_info()\
  \ function.\n\n2. Potential use-after-free\n\nThe current refcounting scheme can lead to a\
  \ potential use-after-free issue\nin the following scenario:\n\n```\n cifs_do_mount\n   cifs_mount\n\
  \     cifs_mount_get_session\n       cifs_get_tcp_session\n         get_net()  /* First get\
  \ net */\n           ip_connect\n             generic_ip_connect\n               get_net()\n\
  \               bind_socket\n\t         kernel_bind /* failed */\n               put_net()\n\
  \         /* after out_err_crypto_release label */\n         put_net()\n         /* after\
  \ out_err label */\n         put_net()\n```\n\nIn the exception handling process where binding\
  \ the socket fails, the\nget_net() and put_net() calls are unbalanced, which may cause the\n\
  server->net reference count to drop to zero and be prematurely released.\n\nTo address both\
  \ issues, this patch ties the netns reference counti\n---truncated---"
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2025-22077.json
  - score: '7.1'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2025-22077.json
  - score: '0.00018'
    scoring_system: epss
    scoring_elements: '0.03074'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
  - score: '0.00018'
    scoring_system: epss
    scoring_elements: '0.03092'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
  - score: '0.00018'
    scoring_system: epss
    scoring_elements: '0.03075'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
  - score: '0.00018'
    scoring_system: epss
    scoring_elements: '0.03093'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
  - score: '0.00018'
    scoring_system: epss
    scoring_elements: '0.03082'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
  - score: '0.00023'
    scoring_system: epss
    scoring_elements: '0.04642'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
  - score: '0.00023'
    scoring_system: epss
    scoring_elements: '0.04605'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
  - score: '0.00023'
    scoring_system: epss
    scoring_elements: '0.04637'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
  - score: '0.00023'
    scoring_system: epss
    scoring_elements: '0.0465'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.04923'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.04919'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.04929'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
weaknesses:
  - CWE-416
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2025-22077.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2025-22077
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/476617a4ca0123f0df677d547a82a110c27c8c74
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/4b6f6bf1bde8d6045c389fda8d21c304dfe49384
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/4e7f1644f2ac6d01dc584f6301c3b1d5aac4eaef
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/7d8dfc27d90d41627c0d6ada97ed0ab57b3dae25
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/8dbf060480236877703bff0106fc984576184d11
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/95d2b9f693ff2a1180a23d7d59acc0c4e72f4c41
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/961755d0055e0e96d1849cc0425da966c8a64e53
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c6b6b8dcef4adf8ee4e439bb97e74106096c71b8
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f761eeefd531e6550cd3a5c047835b4892acb00d
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2360283
    reference_type:
    reference_id: 2360283
  - url: https://nvd.nist.gov/vuln/detail/CVE-2025-22077
    reference_type:
    reference_id: CVE-2025-22077
