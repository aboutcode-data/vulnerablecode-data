vulnerability_id: VCID-cern-6tca-aaaq
aliases:
  - CVE-2024-35970
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  af_unix: Clear stale u->oob_skb.

  syzkaller started to report deadlock of unix_gc_lock after commit
  4090fa373f0e ("af_unix: Replace garbage collection algorithm."), but
  it just uncovers the bug that has been there since commit 314001f0bf92
  ("af_unix: Add OOB support").

  The repro basically does the following.

    from socket import *
    from array import array

    c1, c2 = socketpair(AF_UNIX, SOCK_STREAM)
    c1.sendmsg([b'a'], [(SOL_SOCKET, SCM_RIGHTS, array("i", [c2.fileno()]))], MSG_OOB)
    c2.recv(1)  # blocked as no normal data in recv queue

    c2.close()  # done async and unblock recv()
    c1.close()  # done async and trigger GC

  A socket sends its file descriptor to itself as OOB data and tries to
  receive normal data, but finally recv() fails due to async close().

  The problem here is wrong handling of OOB skb in manage_oob().  When
  recvmsg() is called without MSG_OOB, manage_oob() is called to check
  if the peeked skb is OOB skb.  In such a case, manage_oob() pops it
  out of the receive queue but does not clear unix_sock(sk)->oob_skb.
  This is wrong in terms of uAPI.

  Let's say we send "hello" with MSG_OOB, and "world" without MSG_OOB.
  The 'o' is handled as OOB data.  When recv() is called twice without
  MSG_OOB, the OOB data should be lost.

    >>> from socket import *
    >>> c1, c2 = socketpair(AF_UNIX, SOCK_STREAM, 0)
    >>> c1.send(b'hello', MSG_OOB)  # 'o' is OOB data
    5
    >>> c1.send(b'world')
    5
    >>> c2.recv(5)  # OOB data is not received
    b'hell'
    >>> c2.recv(5)  # OOB date is skipped
    b'world'
    >>> c2.recv(5, MSG_OOB)  # This should return an error
    b'o'

  In the same situation, TCP actually returns -EINVAL for the last
  recv().

  Also, if we do not clear unix_sk(sk)->oob_skb, unix_poll() always set
  EPOLLPRI even though the data has passed through by previous recv().

  To avoid these issues, we must clear unix_sk(sk)->oob_skb when dequeuing
  it from recv queue.

  The reason why the old GC did not trigger the deadlock is because the
  old GC relied on the receive queue to detect the loop.

  When it is triggered, the socket with OOB data is marked as GC candidate
  because file refcount == inflight count (1).  However, after traversing
  all inflight sockets, the socket still has a positive inflight count (1),
  thus the socket is excluded from candidates.  Then, the old GC lose the
  chance to garbage-collect the socket.

  With the old GC, the repro continues to create true garbage that will
  never be freed nor detected by kmemleak as it's linked to the global
  inflight list.  That's why we couldn't even notice the issue.
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-35970.json
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16666'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16947'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17624'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17338'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17315'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17350'
    published_at: '2024-12-17 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17830'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17732'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17645'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17329'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17226'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17164'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17041'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17069'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17142'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17147'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48719'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48717'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48767'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48827'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48846'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48844'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48757'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.4876'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48771'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48789'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48788'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48798'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48774'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00255'
    scoring_system: epss
    scoring_elements: '0.48748'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00478'
    scoring_system: epss
    scoring_elements: '0.62339'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00478'
    scoring_system: epss
    scoring_elements: '0.62337'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00478'
    scoring_system: epss
    scoring_elements: '0.62311'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00478'
    scoring_system: epss
    scoring_elements: '0.62345'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00478'
    scoring_system: epss
    scoring_elements: '0.62326'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00478'
    scoring_system: epss
    scoring_elements: '0.62319'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00478'
    scoring_system: epss
    scoring_elements: '0.6232'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00478'
    scoring_system: epss
    scoring_elements: '0.623'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00478'
    scoring_system: epss
    scoring_elements: '0.62316'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00617'
    scoring_system: epss
    scoring_elements: '0.67568'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00617'
    scoring_system: epss
    scoring_elements: '0.67573'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00617'
    scoring_system: epss
    scoring_elements: '0.67587'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00617'
    scoring_system: epss
    scoring_elements: '0.67484'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.00617'
    scoring_system: epss
    scoring_elements: '0.67464'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '0.01794'
    scoring_system: epss
    scoring_elements: '0.71546'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '6.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
    published_at: None
    url: https://git.kernel.org/stable/c/601a89ea24d05089debfa2dc896ea9f5937ac7a6
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-05-20T14:23:05Z/
    published_at: None
    url: https://git.kernel.org/stable/c/601a89ea24d05089debfa2dc896ea9f5937ac7a6
  - score: '6.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
    published_at: None
    url: https://git.kernel.org/stable/c/698a95ade1a00e6494482046902b986dfffd1caf
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-05-20T14:23:05Z/
    published_at: None
    url: https://git.kernel.org/stable/c/698a95ade1a00e6494482046902b986dfffd1caf
  - score: '6.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
    published_at: None
    url: https://git.kernel.org/stable/c/84a352b7eba1142a95441380058985ff19f25ec9
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-05-20T14:23:05Z/
    published_at: None
    url: https://git.kernel.org/stable/c/84a352b7eba1142a95441380058985ff19f25ec9
  - score: '6.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
    published_at: None
    url: https://git.kernel.org/stable/c/b46f4eaa4f0ec38909fb0072eea3aeddb32f954e
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-05-20T14:23:05Z/
    published_at: None
    url: https://git.kernel.org/stable/c/b46f4eaa4f0ec38909fb0072eea3aeddb32f954e
  - score: '6.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
    published_at: None
    url: https://git.kernel.org/stable/c/b4bc99d04c689b5652665394ae8d3e02fb754153
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-05-20T14:23:05Z/
    published_at: None
    url: https://git.kernel.org/stable/c/b4bc99d04c689b5652665394ae8d3e02fb754153
weaknesses:
  - CWE-667
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-35970.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-35970
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/601a89ea24d05089debfa2dc896ea9f5937ac7a6
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/698a95ade1a00e6494482046902b986dfffd1caf
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/84a352b7eba1142a95441380058985ff19f25ec9
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b46f4eaa4f0ec38909fb0072eea3aeddb32f954e
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b4bc99d04c689b5652665394ae8d3e02fb754153
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2281897
    reference_type:
    reference_id: 2281897
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.9:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.9:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.9:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.9:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.9:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.9:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-35970
    reference_type:
    reference_id: CVE-2024-35970
  - url: https://usn.ubuntu.com/6893-1/
    reference_type:
    reference_id: USN-6893-1
  - url: https://usn.ubuntu.com/6893-2/
    reference_type:
    reference_id: USN-6893-2
  - url: https://usn.ubuntu.com/6893-3/
    reference_type:
    reference_id: USN-6893-3
  - url: https://usn.ubuntu.com/6898-1/
    reference_type:
    reference_id: USN-6898-1
  - url: https://usn.ubuntu.com/6898-2/
    reference_type:
    reference_id: USN-6898-2
  - url: https://usn.ubuntu.com/6898-3/
    reference_type:
    reference_id: USN-6898-3
  - url: https://usn.ubuntu.com/6898-4/
    reference_type:
    reference_id: USN-6898-4
  - url: https://usn.ubuntu.com/6917-1/
    reference_type:
    reference_id: USN-6917-1
  - url: https://usn.ubuntu.com/6918-1/
    reference_type:
    reference_id: USN-6918-1
  - url: https://usn.ubuntu.com/6919-1/
    reference_type:
    reference_id: USN-6919-1
  - url: https://usn.ubuntu.com/6927-1/
    reference_type:
    reference_id: USN-6927-1
  - url: https://usn.ubuntu.com/7019-1/
    reference_type:
    reference_id: USN-7019-1
