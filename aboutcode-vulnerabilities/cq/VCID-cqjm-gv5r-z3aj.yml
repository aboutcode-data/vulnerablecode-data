vulnerability_id: VCID-cqjm-gv5r-z3aj
aliases:
  - CVE-2023-54158
summary: "In the Linux kernel, the following vulnerability has been resolved:  btrfs: don't\
  \ free qgroup space unless specified  Boris noticed in his simple quotas testing that he was\
  \ getting a leak with Sweet Tea's change to subvol create that stopped doing a transaction\
  \ commit.  This was just a side effect of that change.  In the delayed inode code we have\
  \ an optimization that will free extra reservations if we think we can pack a dir item into\
  \ an already modified leaf.  Previously this wouldn't be triggered in the subvolume create\
  \ case because we'd commit the transaction, it was still possible but much harder to trigger.\
  \  It could actually be triggered if we did a mkdir && subvol create with qgroups enabled.\
  \  This occurs because in btrfs_insert_delayed_dir_index(), which gets called when we're adding\
  \ the dir item, we do the following:    btrfs_block_rsv_release(fs_info, trans->block_rsv,\
  \ bytes, NULL);  if we're able to skip reserving space.  The problem here is that trans->block_rsv\
  \ points at the temporary block rsv for the subvolume create, which has qgroup reservations\
  \ in the block rsv.  This is a problem because btrfs_block_rsv_release() will do the following:\
  \    if (block_rsv->qgroup_rsv_reserved >= block_rsv->qgroup_rsv_size) { \t  qgroup_to_release\
  \ = block_rsv->qgroup_rsv_reserved - \t\t  block_rsv->qgroup_rsv_size; \t  block_rsv->qgroup_rsv_reserved\
  \ = block_rsv->qgroup_rsv_size;   }  The temporary block rsv just has ->qgroup_rsv_reserved\
  \ set, ->qgroup_rsv_size == 0.  The optimization in btrfs_insert_delayed_dir_index() sets\
  \ ->qgroup_rsv_reserved = 0.  Then later on when we call btrfs_subvolume_release_metadata()\
  \ which has    btrfs_block_rsv_release(fs_info, rsv, (u64)-1, &qgroup_to_release);   btrfs_qgroup_convert_reserved_meta(root,\
  \ qgroup_to_release);  qgroup_to_release is set to 0, and we do not convert the reserved metadata\
  \ space.  The problem here is that the block rsv code has been unconditionally messing with\
  \ ->qgroup_rsv_reserved, because the main place this is used is delalloc, and any time we\
  \ call btrfs_block_rsv_release() we do it with qgroup_to_release set, and thus do the proper\
  \ accounting.  The subvolume code is the only other code that uses the qgroup reservation\
  \ stuff, but it's intermingled with the above optimization, and thus was getting its reservation\
  \ freed out from underneath it and thus leaking the reserved space.  The solution is to simply\
  \ not mess with the qgroup reservations if we don't have qgroup_to_release set.  This works\
  \ with the existing code as anything that messes with the delalloc reservations always have\
  \ qgroup_to_release set.  This fixes the leak that Boris was observing."
severities:
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.0895'
    published_at: '2026-01-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-54158
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.08909'
    published_at: '2026-01-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2023-54158
  - score: '4.7'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
weaknesses: []
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2023-54158.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2023-54158
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-54158
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2425083
    reference_type:
    reference_id: 2425083
