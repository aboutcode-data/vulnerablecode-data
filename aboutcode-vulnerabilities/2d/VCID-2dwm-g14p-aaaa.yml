vulnerability_id: VCID-2dwm-g14p-aaaa
aliases:
  - CVE-2022-48734
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: fix deadlock between quota disable and qgroup rescan worker

  Quota disable ioctl starts a transaction before waiting for the qgroup
  rescan worker completes. However, this wait can be infinite and results
  in deadlock because of circular dependency among the quota disable
  ioctl, the qgroup rescan worker and the other task with transaction such
  as block group relocation task.

  The deadlock happens with the steps following:

  1) Task A calls ioctl to disable quota. It starts a transaction and
     waits for qgroup rescan worker completes.
  2) Task B such as block group relocation task starts a transaction and
     joins to the transaction that task A started. Then task B commits to
     the transaction. In this commit, task B waits for a commit by task A.
  3) Task C as the qgroup rescan worker starts its job and starts a
     transaction. In this transaction start, task C waits for completion
     of the transaction that task A started and task B committed.

  This deadlock was found with fstests test case btrfs/115 and a zoned
  null_blk device. The test case enables and disables quota, and the
  block group reclaim was triggered during the quota disable by chance.
  The deadlock was also observed by running quota enable and disable in
  parallel with 'btrfs balance' command on regular null_blk devices.

  An example report of the deadlock:

    [372.469894] INFO: task kworker/u16:6:103 blocked for more than 122 seconds.
    [372.479944]       Not tainted 5.16.0-rc8 #7
    [372.485067] "echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.
    [372.493898] task:kworker/u16:6   state:D stack:    0 pid:  103 ppid:     2 flags:0x00004000
    [372.503285] Workqueue: btrfs-qgroup-rescan btrfs_work_helper [btrfs]
    [372.510782] Call Trace:
    [372.514092]  <TASK>
    [372.521684]  __schedule+0xb56/0x4850
    [372.530104]  ? io_schedule_timeout+0x190/0x190
    [372.538842]  ? lockdep_hardirqs_on+0x7e/0x100
    [372.547092]  ? _raw_spin_unlock_irqrestore+0x3e/0x60
    [372.555591]  schedule+0xe0/0x270
    [372.561894]  btrfs_commit_transaction+0x18bb/0x2610 [btrfs]
    [372.570506]  ? btrfs_apply_pending_changes+0x50/0x50 [btrfs]
    [372.578875]  ? free_unref_page+0x3f2/0x650
    [372.585484]  ? finish_wait+0x270/0x270
    [372.591594]  ? release_extent_buffer+0x224/0x420 [btrfs]
    [372.599264]  btrfs_qgroup_rescan_worker+0xc13/0x10c0 [btrfs]
    [372.607157]  ? lock_release+0x3a9/0x6d0
    [372.613054]  ? btrfs_qgroup_account_extent+0xda0/0xda0 [btrfs]
    [372.620960]  ? do_raw_spin_lock+0x11e/0x250
    [372.627137]  ? rwlock_bug.part.0+0x90/0x90
    [372.633215]  ? lock_is_held_type+0xe4/0x140
    [372.639404]  btrfs_work_helper+0x1ae/0xa90 [btrfs]
    [372.646268]  process_one_work+0x7e9/0x1320
    [372.652321]  ? lock_release+0x6d0/0x6d0
    [372.658081]  ? pwq_dec_nr_in_flight+0x230/0x230
    [372.664513]  ? rwlock_bug.part.0+0x90/0x90
    [372.670529]  worker_thread+0x59e/0xf90
    [372.676172]  ? process_one_work+0x1320/0x1320
    [372.682440]  kthread+0x3b9/0x490
    [372.687550]  ? _raw_spin_unlock_irq+0x24/0x50
    [372.693811]  ? set_kthread_struct+0x100/0x100
    [372.700052]  ret_from_fork+0x22/0x30
    [372.705517]  </TASK>
    [372.709747] INFO: task btrfs-transacti:2347 blocked for more than 123 seconds.
    [372.729827]       Not tainted 5.16.0-rc8 #7
    [372.745907] "echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.
    [372.767106] task:btrfs-transacti state:D stack:    0 pid: 2347 ppid:     2 flags:0x00004000
    [372.787776] Call Trace:
    [372.801652]  <TASK>
    [372.812961]  __schedule+0xb56/0x4850
    [372.830011]  ? io_schedule_timeout+0x190/0x190
    [372.852547]  ? lockdep_hardirqs_on+0x7e/0x100
    [372.871761]  ? _raw_spin_unlock_irqrestore+0x3e/0x60
    [372.886792]  schedule+0xe0/0x270
    [372.901685]  wait_current_trans+0x22c/0x310 [btrfs]
    [372.919743]  ? btrfs_put_transaction+0x3d0/0x3d0 [btrfs]
    [372.938923]  ? finish_wait+0x270/0x270
    [372.959085]  ? join_transaction+0xc7
  ---truncated---
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2022-48734.json
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05128'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05124'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05115'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05119'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05108'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05105'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05100'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05091'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05073'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05065'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05058'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.13005'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.12775'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.12742'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.12904'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.1291'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.1295'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.12985'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.12984'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.12969'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.13032'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.13021'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.12989'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.12973'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00051'
    scoring_system: epss
    scoring_elements: '0.15671'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00054'
    scoring_system: epss
    scoring_elements: '0.16916'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00054'
    scoring_system: epss
    scoring_elements: '0.16973'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00054'
    scoring_system: epss
    scoring_elements: '0.16968'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00054'
    scoring_system: epss
    scoring_elements: '0.16949'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00054'
    scoring_system: epss
    scoring_elements: '0.16925'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00054'
    scoring_system: epss
    scoring_elements: '0.16946'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00054'
    scoring_system: epss
    scoring_elements: '0.16964'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00054'
    scoring_system: epss
    scoring_elements: '0.16957'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00054'
    scoring_system: epss
    scoring_elements: '0.16792'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00054'
    scoring_system: epss
    scoring_elements: '0.16888'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00054'
    scoring_system: epss
    scoring_elements: '0.16966'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '0.00215'
    scoring_system: epss
    scoring_elements: '0.29903'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
  - score: '4.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2022-48734
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2022-48734
weaknesses:
  - CWE-667
  - CWE-833
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2022-48734.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2022-48734
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-48734
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/26b3901d20bf9da2c6a00cb1fb48932166f80a45
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/31198e58c09e21d4f65c49d2361f76b87aca4c3f
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/32747e01436aac8ef93fe85b5b523b4f3b52f040
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/89d4cca583fc9594ee7d1a0bc986886d6fb587e6
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/e804861bd4e69cc5fe1053eedcb024982dde8e48
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2293325
    reference_type:
    reference_id: 2293325
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-48734
    reference_type:
    reference_id: CVE-2022-48734
