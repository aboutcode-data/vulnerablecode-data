vulnerability_id: VCID-7469-7d9k-aaaj
aliases:
  - GHSA-qvp4-rpmr-xwrr
summary: |
  Possible bypass of token claim validation when OAuth2 Introspection caching is enabled
  ### Impact

  When you make a request to an endpoint that requires the scope `foo` using an access token granted with that `foo` scope, introspection will be valid and that token will be cached. The problem comes when a second requests to an endpoint that requires the scope `bar` is made before the cache has expired. Whether the token is granted or not to the `bar` scope, introspection will be valid.

  ### Patches

  A patch will be released with `v0.38.12-beta.1`.

  ### Workarounds

  Per default, caching is disabled for the `oauth2_introspection` authenticator. When caching is disabled, this vulnerability does not exist.

  ### Trace

  The cache is checked in [`func (a *AuthenticatorOAuth2Introspection) Authenticate(...)`](https://github.com/ory/oathkeeper/blob/6a31df1c3779425e05db1c2a381166b087cb29a4/pipeline/authn/authenticator_oauth2_introspection.go#L152). From [`tokenFromCache()`](https://github.com/ory/oathkeeper/blob/6a31df1c3779425e05db1c2a381166b087cb29a4/pipeline/authn/authenticator_oauth2_introspection.go#L97) it seems that it only validates the token expiration date, but ignores whether the token has or not the proper scopes.

  ### Post-Mortem

  The vulnerability was introduced in PR #424. During review, we failed to require appropriate test coverage by the submitter which is the primary reason that the vulnerability passed the review process.

  To avoid this from happening again we enabled codecov with a strict policy on the Ory Oathkeeper repository: Without an increase in code coverage the PR can not be merged.

  To address this issue and any regressions we have added a test suite ensuring that the cache behaviour is correct in the different scenarios:

  - Scope strategy is `none`, cache is enabled, and `requested_scope` is not empty -> cache will not be used;
  - Scope strategy is `none`, cache is enabled, and `requested_scope` is empty -> cache will be used;
  - Scope strategy is not `none`, cache is enabled, and `requested_scope` is not empty -> cache will be used;

  as well as validating if `iss`, `aud`, `exp`, `token_use`, and scope are validated.

  Additionally, we added [CodeQL scanning](https://github.com/ory/oathkeeper/commit/64ac7562669287d391cd72dfd43c5d71ff9f89a1) to the CI.
severities:
  - score: '7.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    published_at: None
    url: https://github.com/ory/oathkeeper/security/advisories/GHSA-qvp4-rpmr-xwrr
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url: https://github.com/ory/oathkeeper/security/advisories/GHSA-qvp4-rpmr-xwrr
weaknesses:
  - CWE-863
references:
  - url: https://github.com/ory/oathkeeper/security/advisories/GHSA-qvp4-rpmr-xwrr
    reference_type:
    reference_id:
