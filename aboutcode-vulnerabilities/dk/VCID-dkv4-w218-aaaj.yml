vulnerability_id: VCID-dkv4-w218-aaaj
aliases:
  - CVE-2024-38557
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  net/mlx5: Reload only IB representors upon lag disable/enable

  On lag disable, the bond IB device along with all of its
  representors are destroyed, and then the slaves' representors get reloaded.

  In case the slave IB representor load fails, the eswitch error flow
  unloads all representors, including ethernet representors, where the
  netdevs get detached and removed from lag bond. Such flow is inaccurate
  as the lag driver is not responsible for loading/unloading ethernet
  representors. Furthermore, the flow described above begins by holding
  lag lock to prevent bond changes during disable flow. However, when
  reaching the ethernet representors detachment from lag, the lag lock is
  required again, triggering the following deadlock:

  Call trace:
  __switch_to+0xf4/0x148
  __schedule+0x2c8/0x7d0
  schedule+0x50/0xe0
  schedule_preempt_disabled+0x18/0x28
  __mutex_lock.isra.13+0x2b8/0x570
  __mutex_lock_slowpath+0x1c/0x28
  mutex_lock+0x4c/0x68
  mlx5_lag_remove_netdev+0x3c/0x1a0 [mlx5_core]
  mlx5e_uplink_rep_disable+0x70/0xa0 [mlx5_core]
  mlx5e_detach_netdev+0x6c/0xb0 [mlx5_core]
  mlx5e_netdev_change_profile+0x44/0x138 [mlx5_core]
  mlx5e_netdev_attach_nic_profile+0x28/0x38 [mlx5_core]
  mlx5e_vport_rep_unload+0x184/0x1b8 [mlx5_core]
  mlx5_esw_offloads_rep_load+0xd8/0xe0 [mlx5_core]
  mlx5_eswitch_reload_reps+0x74/0xd0 [mlx5_core]
  mlx5_disable_lag+0x130/0x138 [mlx5_core]
  mlx5_lag_disable_change+0x6c/0x70 [mlx5_core] // hold ldev->lock
  mlx5_devlink_eswitch_mode_set+0xc0/0x410 [mlx5_core]
  devlink_nl_cmd_eswitch_set_doit+0xdc/0x180
  genl_family_rcv_msg_doit.isra.17+0xe8/0x138
  genl_rcv_msg+0xe4/0x220
  netlink_rcv_skb+0x44/0x108
  genl_rcv+0x40/0x58
  netlink_unicast+0x198/0x268
  netlink_sendmsg+0x1d4/0x418
  sock_sendmsg+0x54/0x60
  __sys_sendto+0xf4/0x120
  __arm64_sys_sendto+0x30/0x40
  el0_svc_common+0x8c/0x120
  do_el0_svc+0x30/0xa0
  el0_svc+0x20/0x30
  el0_sync_handler+0x90/0xb8
  el0_sync+0x160/0x180

  Thus, upon lag enable/disable, load and unload only the IB representors
  of the slaves preventing the deadlock mentioned above.

  While at it, refactor the mlx5_esw_offloads_rep_load() function to have
  a static helper method for its internal logic, in symmetry with the
  representor unload design.
severities:
  - score: '4.4'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-38557.json
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05128'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05124'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05115'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05119'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05108'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05105'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05100'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05091'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05073'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05065'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05058'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13447'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13286'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13347'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13448'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13524'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13526'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13498'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13462'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13457'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13435'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13441'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13466'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13468'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.13459'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17772'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17765'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17744'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17715'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17686'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17752'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17739'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17726'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.1774'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17596'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17541'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17688'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.1771'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17742'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00067'
    scoring_system: epss
    scoring_elements: '0.17778'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '0.00281'
    scoring_system: epss
    scoring_elements: '0.35332'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
  - score: '4.7'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-38557
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-38557
weaknesses:
  - CWE-667
  - CWE-833
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-38557.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-38557
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/0f06228d4a2dcc1fca5b3ddb0eefa09c05b102c4
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/0f320f28f54b1b269a755be2e3fb3695e0b80b07
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/e93fc8d959e56092e2eca1e5511c2d2f0ad6807a
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f03c714a0fdd1f93101a929d0e727c28a66383fc
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2293442
    reference_type:
    reference_id: 2293442
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-38557
    reference_type:
    reference_id: CVE-2024-38557
  - url: https://usn.ubuntu.com/6949-1/
    reference_type:
    reference_id: USN-6949-1
  - url: https://usn.ubuntu.com/6949-2/
    reference_type:
    reference_id: USN-6949-2
  - url: https://usn.ubuntu.com/6952-1/
    reference_type:
    reference_id: USN-6952-1
  - url: https://usn.ubuntu.com/6952-2/
    reference_type:
    reference_id: USN-6952-2
  - url: https://usn.ubuntu.com/6955-1/
    reference_type:
    reference_id: USN-6955-1
