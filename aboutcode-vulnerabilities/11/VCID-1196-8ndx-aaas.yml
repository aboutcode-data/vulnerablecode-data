vulnerability_id: VCID-1196-8ndx-aaas
aliases:
  - CVE-2024-40899
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  cachefiles: fix slab-use-after-free in cachefiles_ondemand_get_fd()

  We got the following issue in a fuzz test of randomly issuing the restore
  command:

  ==================================================================
  BUG: KASAN: slab-use-after-free in cachefiles_ondemand_daemon_read+0x609/0xab0
  Write of size 4 at addr ffff888109164a80 by task ondemand-04-dae/4962

  CPU: 11 PID: 4962 Comm: ondemand-04-dae Not tainted 6.8.0-rc7-dirty #542
  Call Trace:
   kasan_report+0x94/0xc0
   cachefiles_ondemand_daemon_read+0x609/0xab0
   vfs_read+0x169/0xb50
   ksys_read+0xf5/0x1e0

  Allocated by task 626:
   __kmalloc+0x1df/0x4b0
   cachefiles_ondemand_send_req+0x24d/0x690
   cachefiles_create_tmpfile+0x249/0xb30
   cachefiles_create_file+0x6f/0x140
   cachefiles_look_up_object+0x29c/0xa60
   cachefiles_lookup_cookie+0x37d/0xca0
   fscache_cookie_state_machine+0x43c/0x1230
   [...]

  Freed by task 626:
   kfree+0xf1/0x2c0
   cachefiles_ondemand_send_req+0x568/0x690
   cachefiles_create_tmpfile+0x249/0xb30
   cachefiles_create_file+0x6f/0x140
   cachefiles_look_up_object+0x29c/0xa60
   cachefiles_lookup_cookie+0x37d/0xca0
   fscache_cookie_state_machine+0x43c/0x1230
   [...]
  ==================================================================

  Following is the process that triggers the issue:

       mount  |   daemon_thread1    |    daemon_thread2
  ------------------------------------------------------------
   cachefiles_ondemand_init_object
    cachefiles_ondemand_send_req
     REQ_A = kzalloc(sizeof(*req) + data_len)
     wait_for_completion(&REQ_A->done)

              cachefiles_daemon_read
               cachefiles_ondemand_daemon_read
                REQ_A = cachefiles_ondemand_select_req
                cachefiles_ondemand_get_fd
                copy_to_user(_buffer, msg, n)
              process_open_req(REQ_A)
                                    ------ restore ------
                                    cachefiles_ondemand_restore
                                    xas_for_each(&xas, req, ULONG_MAX)
                                     xas_set_mark(&xas, CACHEFILES_REQ_NEW);

                                    cachefiles_daemon_read
                                     cachefiles_ondemand_daemon_read
                                      REQ_A = cachefiles_ondemand_select_req

               write(devfd, ("copen %u,%llu", msg->msg_id, size));
               cachefiles_ondemand_copen
                xa_erase(&cache->reqs, id)
                complete(&REQ_A->done)
     kfree(REQ_A)
                                      cachefiles_ondemand_get_fd(REQ_A)
                                       fd = get_unused_fd_flags
                                       file = anon_inode_getfile
                                       fd_install(fd, file)
                                       load = (void *)REQ_A->msg.data;
                                       load->fd = fd;
                                       // load UAF !!!

  This issue is caused by issuing a restore command when the daemon is still
  alive, which results in a request being processed multiple times thus
  triggering a UAF. So to avoid this problem, add an additional reference
  count to cachefiles_req, which is held while waiting and reading, and then
  released when the waiting and reading is over.

  Note that since there is only one reference count for waiting, we need to
  avoid the same request being completed multiple times, so we can only
  complete the request if it is successfully removed from the xarray.
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-40899.json
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05128'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05124'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05115'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05119'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05108'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05105'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05100'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05091'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05073'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05065'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05058'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.1276'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12581'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12641'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12737'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12812'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12817'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12787'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12744'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12733'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12713'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.1272'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12739'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00043'
    scoring_system: epss
    scoring_elements: '0.12746'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20923'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20925'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20792'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20913'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20741'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20894'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.0008'
    scoring_system: epss
    scoring_elements: '0.20882'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00089'
    scoring_system: epss
    scoring_elements: '0.22858'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00089'
    scoring_system: epss
    scoring_elements: '0.22915'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00089'
    scoring_system: epss
    scoring_elements: '0.22901'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00089'
    scoring_system: epss
    scoring_elements: '0.22863'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00089'
    scoring_system: epss
    scoring_elements: '0.2285'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00089'
    scoring_system: epss
    scoring_elements: '0.22822'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00089'
    scoring_system: epss
    scoring_elements: '0.22843'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00089'
    scoring_system: epss
    scoring_elements: '0.22878'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '0.00338'
    scoring_system: epss
    scoring_elements: '0.39746'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
  - score: '6.4'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '7.8'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-40899
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-40899
weaknesses:
  - CWE-416
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2024-40899.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2024-40899
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-40899
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/1d902d9a3aa4f2a8bda698294e34be788be012fc
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/99e9c5bd27ddefa0f9db88625bf5e31c1e833d62
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a6de82765e12fb1201ab607f0d3ffe3309b30fc0
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/de3e26f9e5b76fc628077578c001c4a51bf54d06
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2297704
    reference_type:
    reference_id: 2297704
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.10:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.10:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.10:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.10:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.10:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.10:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-40899
    reference_type:
    reference_id: CVE-2024-40899
  - url: https://usn.ubuntu.com/6999-1/
    reference_type:
    reference_id: USN-6999-1
  - url: https://usn.ubuntu.com/6999-2/
    reference_type:
    reference_id: USN-6999-2
  - url: https://usn.ubuntu.com/7004-1/
    reference_type:
    reference_id: USN-7004-1
  - url: https://usn.ubuntu.com/7005-1/
    reference_type:
    reference_id: USN-7005-1
  - url: https://usn.ubuntu.com/7005-2/
    reference_type:
    reference_id: USN-7005-2
  - url: https://usn.ubuntu.com/7008-1/
    reference_type:
    reference_id: USN-7008-1
  - url: https://usn.ubuntu.com/7029-1/
    reference_type:
    reference_id: USN-7029-1
