vulnerability_id: VCID-5f2k-m9z7-juas
aliases:
  - CVE-2022-48901
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: do not start relocation until in progress drops are done

  We hit a bug with a recovering relocation on mount for one of our file
  systems in production.  I reproduced this locally by injecting errors
  into snapshot delete with balance running at the same time.  This
  presented as an error while looking up an extent item

    WARNING: CPU: 5 PID: 1501 at fs/btrfs/extent-tree.c:866 lookup_inline_extent_backref+0x647/0x680
    CPU: 5 PID: 1501 Comm: btrfs-balance Not tainted 5.16.0-rc8+ #8
    RIP: 0010:lookup_inline_extent_backref+0x647/0x680
    RSP: 0018:ffffae0a023ab960 EFLAGS: 00010202
    RAX: 0000000000000001 RBX: 0000000000000000 RCX: 0000000000000000
    RDX: 0000000000000000 RSI: 000000000000000c RDI: 0000000000000000
    RBP: ffff943fd2a39b60 R08: 0000000000000000 R09: 0000000000000001
    R10: 0001434088152de0 R11: 0000000000000000 R12: 0000000001d05000
    R13: ffff943fd2a39b60 R14: ffff943fdb96f2a0 R15: ffff9442fc923000
    FS:  0000000000000000(0000) GS:ffff944e9eb40000(0000) knlGS:0000000000000000
    CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    CR2: 00007f1157b1fca8 CR3: 000000010f092000 CR4: 0000000000350ee0
    Call Trace:
     <TASK>
     insert_inline_extent_backref+0x46/0xd0
     __btrfs_inc_extent_ref.isra.0+0x5f/0x200
     ? btrfs_merge_delayed_refs+0x164/0x190
     __btrfs_run_delayed_refs+0x561/0xfa0
     ? btrfs_search_slot+0x7b4/0xb30
     ? btrfs_update_root+0x1a9/0x2c0
     btrfs_run_delayed_refs+0x73/0x1f0
     ? btrfs_update_root+0x1a9/0x2c0
     btrfs_commit_transaction+0x50/0xa50
     ? btrfs_update_reloc_root+0x122/0x220
     prepare_to_merge+0x29f/0x320
     relocate_block_group+0x2b8/0x550
     btrfs_relocate_block_group+0x1a6/0x350
     btrfs_relocate_chunk+0x27/0xe0
     btrfs_balance+0x777/0xe60
     balance_kthread+0x35/0x50
     ? btrfs_balance+0xe60/0xe60
     kthread+0x16b/0x190
     ? set_kthread_struct+0x40/0x40
     ret_from_fork+0x22/0x30
     </TASK>

  Normally snapshot deletion and relocation are excluded from running at
  the same time by the fs_info->cleaner_mutex.  However if we had a
  pending balance waiting to get the ->cleaner_mutex, and a snapshot
  deletion was running, and then the box crashed, we would come up in a
  state where we have a half deleted snapshot.

  Again, in the normal case the snapshot deletion needs to complete before
  relocation can start, but in this case relocation could very well start
  before the snapshot deletion completes, as we simply add the root to the
  dead roots list and wait for the next time the cleaner runs to clean up
  the snapshot.

  Fix this by setting a bit on the fs_info if we have any DEAD_ROOT's that
  had a pending drop_progress key.  If they do then we know we were in the
  middle of the drop operation and set a flag on the fs_info.  Then
  balance can wait until this flag is cleared to start up again.

  If there are DEAD_ROOT's that don't have a drop_progress set then we're
  safe to start balance right away as we'll be properly protected by the
  cleaner_mutex.
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2022-48901.json
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05582'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.04287'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.0428'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.04279'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.04268'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.0425'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05489'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05507'
    published_at: '2025-04-16 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05592'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05538'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05535'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.0551'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05492'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05454'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05446'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05458'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05461'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05478'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.05607'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.04273'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.04246'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.04213'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.0421'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.04203'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.04215'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.04231'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.04229'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00026'
    scoring_system: epss
    scoring_elements: '0.04256'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05128'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05058'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05124'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05115'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05119'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05108'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05105'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05100'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05091'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05073'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05065'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '0.00109'
    scoring_system: epss
    scoring_elements: '0.1781'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2022-48901
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2022-48901
weaknesses:
  - CWE-99
  - CWE-362
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2022-48901.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2022-48901
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-48901
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/5e70bc827b563caf22e1203428cc3719643de5aa
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/6599d5e8bd758d897fd2ef4dc388ae50278b1f7e
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b4be6aefa73c9a6899ef3ba9c5faaa8a66e333ef
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2307154
    reference_type:
    reference_id: 2307154
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.17:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.17:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.17:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.17:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.17:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.17:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.17:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.17:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.17:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.17:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.17:rc6:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.17:rc6:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-48901
    reference_type:
    reference_id: CVE-2022-48901
