vulnerability_id: VCID-nxvf-t34y-aaar
aliases:
  - CVE-2021-46984
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  kyber: fix out of bounds access when preempted

  __blk_mq_sched_bio_merge() gets the ctx and hctx for the current CPU and
  passes the hctx to ->bio_merge(). kyber_bio_merge() then gets the ctx
  for the current CPU again and uses that to get the corresponding Kyber
  context in the passed hctx. However, the thread may be preempted between
  the two calls to blk_mq_get_ctx(), and the ctx returned the second time
  may no longer correspond to the passed hctx. This "works" accidentally
  most of the time, but it can cause us to read garbage if the second ctx
  came from an hctx with more ctx's than the first one (i.e., if
  ctx->index_hw[hctx->type] > hctx->nr_ctx).

  This manifested as this UBSAN array index out of bounds error reported
  by Jakub:

  UBSAN: array-index-out-of-bounds in ../kernel/locking/qspinlock.c:130:9
  index 13106 is out of range for type 'long unsigned int [128]'
  Call Trace:
   dump_stack+0xa4/0xe5
   ubsan_epilogue+0x5/0x40
   __ubsan_handle_out_of_bounds.cold.13+0x2a/0x34
   queued_spin_lock_slowpath+0x476/0x480
   do_raw_spin_lock+0x1c2/0x1d0
   kyber_bio_merge+0x112/0x180
   blk_mq_submit_bio+0x1f5/0x1100
   submit_bio_noacct+0x7b0/0x870
   submit_bio+0xc2/0x3a0
   btrfs_map_bio+0x4f0/0x9d0
   btrfs_submit_data_bio+0x24e/0x310
   submit_one_bio+0x7f/0xb0
   submit_extent_page+0xc4/0x440
   __extent_writepage_io+0x2b8/0x5e0
   __extent_writepage+0x28d/0x6e0
   extent_write_cache_pages+0x4d7/0x7a0
   extent_writepages+0xa2/0x110
   do_writepages+0x8f/0x180
   __writeback_single_inode+0x99/0x7f0
   writeback_sb_inodes+0x34e/0x790
   __writeback_inodes_wb+0x9e/0x120
   wb_writeback+0x4d2/0x660
   wb_workfn+0x64d/0xa10
   process_one_work+0x53a/0xa80
   worker_thread+0x69/0x5b0
   kthread+0x20b/0x240
   ret_from_fork+0x1f/0x30

  Only Kyber uses the hctx, so fix it by passing the request_queue to
  ->bio_merge() instead. BFQ and mq-deadline just use that, and Kyber can
  map the queues itself to avoid the mismatch.
severities:
  - score: '6.0'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:H/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2021-46984.json
  - score: '0.00028'
    scoring_system: epss
    scoring_elements: '0.04614'
    published_at: '2025-04-07 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07738'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07739'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07758'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07767'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07802'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07877'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.0789'
    published_at: '2025-04-18 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07829'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07733'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07694'
    published_at: '2025-04-15 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.05888'
    published_at: '2025-04-14 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.05926'
    published_at: '2025-04-13 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07676'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07746'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.05942'
    published_at: '2025-04-12 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.05954'
    published_at: '2025-04-11 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.05952'
    published_at: '2025-04-09 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.05963'
    published_at: '2025-04-10 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.0594'
    published_at: '2025-04-08 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.05078'
    published_at: '2025-01-16 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04956'
    published_at: '2024-12-19 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00042'
    scoring_system: epss
    scoring_elements: '0.04987'
    published_at: '2024-12-27 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16666'
    published_at: '2024-11-01 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17830'
    published_at: '2024-12-15 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17732'
    published_at: '2024-12-13 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17645'
    published_at: '2024-12-11 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17329'
    published_at: '2024-12-03 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17226'
    published_at: '2024-11-28 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17164'
    published_at: '2024-11-26 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17142'
    published_at: '2024-11-24 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17147'
    published_at: '2024-11-23 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17069'
    published_at: '2024-11-21 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.17041'
    published_at: '2024-11-20 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00045'
    scoring_system: epss
    scoring_elements: '0.16947'
    published_at: '2024-11-18 00:00:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.0009'
    scoring_system: epss
    scoring_elements: '0.23204'
    published_at: '2025-04-05 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.0009'
    scoring_system: epss
    scoring_elements: '0.23153'
    published_at: '2025-04-06 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.0009'
    scoring_system: epss
    scoring_elements: '0.23211'
    published_at: '2025-04-03 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.0009'
    scoring_system: epss
    scoring_elements: '0.23191'
    published_at: '2025-04-02 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.0009'
    scoring_system: epss
    scoring_elements: '0.23046'
    published_at: '2025-03-30 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.0009'
    scoring_system: epss
    scoring_elements: '0.23115'
    published_at: '2025-03-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.0009'
    scoring_system: epss
    scoring_elements: '0.23215'
    published_at: '2025-04-04 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '0.00382'
    scoring_system: epss
    scoring_elements: '0.42612'
    published_at: '2025-03-29 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
  - score: '7.8'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-46984
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-46984
weaknesses:
  - CWE-129
  - CWE-125
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2021-46984.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2021-46984
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-46984
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/0b6b4b90b74c27bea968c214d820ba4254b903a5
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/2ef3c76540c49167a0bc3d5f80d00fd1fc4586df
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/54dbe2d2c1fcabf650c7a8b747601da355cd7f9f
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a287cd84e047045f5a4d4da793414e848de627c6
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/efed9a3337e341bd0989161b97453b52567bc59d
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2266750
    reference_type:
    reference_id: 2266750
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.13:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.13:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-46984
    reference_type:
    reference_id: CVE-2021-46984
  - url: https://access.redhat.com/errata/RHSA-2024:7000
    reference_type:
    reference_id: RHSA-2024:7000
  - url: https://access.redhat.com/errata/RHSA-2024:7001
    reference_type:
    reference_id: RHSA-2024:7001
