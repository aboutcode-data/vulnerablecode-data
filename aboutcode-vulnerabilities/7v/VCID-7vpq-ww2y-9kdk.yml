vulnerability_id: VCID-7vpq-ww2y-9kdk
aliases:
  - CVE-2025-22058
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  udp: Fix memory accounting leak.

  Matt Dowling reported a weird UDP memory usage issue.

  Under normal operation, the UDP memory usage reported in /proc/net/sockstat
  remains close to zero.  However, it occasionally spiked to 524,288 pages
  and never dropped.  Moreover, the value doubled when the application was
  terminated.  Finally, it caused intermittent packet drops.

  We can reproduce the issue with the script below [0]:

    1. /proc/net/sockstat reports 0 pages

      # cat /proc/net/sockstat | grep UDP:
      UDP: inuse 1 mem 0

    2. Run the script till the report reaches 524,288

      # python3 test.py & sleep 5
      # cat /proc/net/sockstat | grep UDP:
      UDP: inuse 3 mem 524288  <-- (INT_MAX + 1) >> PAGE_SHIFT

    3. Kill the socket and confirm the number never drops

      # pkill python3 && sleep 5
      # cat /proc/net/sockstat | grep UDP:
      UDP: inuse 1 mem 524288

    4. (necessary since v6.0) Trigger proto_memory_pcpu_drain()

      # python3 test.py & sleep 1 && pkill python3

    5. The number doubles

      # cat /proc/net/sockstat | grep UDP:
      UDP: inuse 1 mem 1048577

  The application set INT_MAX to SO_RCVBUF, which triggered an integer
  overflow in udp_rmem_release().

  When a socket is close()d, udp_destruct_common() purges its receive
  queue and sums up skb->truesize in the queue.  This total is calculated
  and stored in a local unsigned integer variable.

  The total size is then passed to udp_rmem_release() to adjust memory
  accounting.  However, because the function takes a signed integer
  argument, the total size can wrap around, causing an overflow.

  Then, the released amount is calculated as follows:

    1) Add size to sk->sk_forward_alloc.
    2) Round down sk->sk_forward_alloc to the nearest lower multiple of
        PAGE_SIZE and assign it to amount.
    3) Subtract amount from sk->sk_forward_alloc.
    4) Pass amount >> PAGE_SHIFT to __sk_mem_reduce_allocated().

  When the issue occurred, the total in udp_destruct_common() was 2147484480
  (INT_MAX + 833), which was cast to -2147482816 in udp_rmem_release().

  At 1) sk->sk_forward_alloc is changed from 3264 to -2147479552, and
  2) sets -2147479552 to amount.  3) reverts the wraparound, so we don't
  see a warning in inet_sock_destruct().  However, udp_memory_allocated
  ends up doubling at 4).

  Since commit 3cd3399dd7a8 ("net: implement per-cpu reserves for
  memory_allocated"), memory usage no longer doubles immediately after
  a socket is close()d because __sk_mem_reduce_allocated() caches the
  amount in udp_memory_per_cpu_fw_alloc.  However, the next time a UDP
  socket receives a packet, the subtraction takes effect, causing UDP
  memory usage to double.

  This issue makes further memory allocation fail once the socket's
  sk->sk_rmem_alloc exceeds net.ipv4.udp_rmem_min, resulting in packet
  drops.

  To prevent this issue, let's use unsigned int for the calculation and
  call sk_forward_alloc_add() only once for the small delta.

  Note that first_packet_length() also potentially has the same problem.

  [0]:
  from socket import *

  SO_RCVBUFFORCE = 33
  INT_MAX = (2 ** 31) - 1

  s = socket(AF_INET, SOCK_DGRAM)
  s.bind(('', 0))
  s.setsockopt(SOL_SOCKET, SO_RCVBUFFORCE, INT_MAX)

  c = socket(AF_INET, SOCK_DGRAM)
  c.connect(s.getsockname())

  data = b'a' * 100

  while True:
      c.send(data)
severities:
  - score: '5.5'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2025-22058.json
  - score: '7.1'
    scoring_system: cvssv3
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:H
    published_at: None
    url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2025-22058.json
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.05076'
    published_at: '2025-04-17 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22058
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.05064'
    published_at: '2025-04-19 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22058
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.05038'
    published_at: '2025-04-20 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22058
  - score: '0.00024'
    scoring_system: epss
    scoring_elements: '0.05028'
    published_at: '2025-04-21 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22058
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.0768'
    published_at: '2025-04-27 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22058
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07616'
    published_at: '2025-04-28 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22058
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07701'
    published_at: '2025-04-22 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22058
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07683'
    published_at: '2025-04-23 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22058
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07679'
    published_at: '2025-04-24 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22058
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07674'
    published_at: '2025-04-25 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22058
  - score: '0.00032'
    scoring_system: epss
    scoring_elements: '0.07685'
    published_at: '2025-04-26 12:55:00+00:00'
    url: https://api.first.org/data/v1/epss?cve=CVE-2025-22058
  - score: '5.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:L
    published_at: None
    url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
weaknesses:
  - CWE-190
references:
  - url: https://access.redhat.com/hydra/rest/securitydata/cve/CVE-2025-22058.json
    reference_type:
    reference_id:
  - url: https://api.first.org/data/v1/epss?cve=CVE-2025-22058
    reference_type:
    reference_id:
  - url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2025-22058
    reference_type:
    reference_id:
  - url: https://ftp.suse.com/pub/projects/security/yaml/suse-cvss-scores.yaml
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/3836029448e76c1e6f77cc5fe0adc09b018b5fa8
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/9122fec396950cc866137af7154b1d0d989be52e
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a116b271bf3cb72c8155b6b7f39083c1b80dcd00
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/aeef6456692c6f11ae53d278df64f1316a2a405a
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c4bac6c398118fba79e32b1cd01db22dbfe29fbf
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/df207de9d9e7a4d92f8567e2c539d9c8c12fd99d
    reference_type:
    reference_id:
  - url: https://bugzilla.redhat.com/show_bug.cgi?id=2360276
    reference_type:
    reference_id: 2360276
  - url: https://nvd.nist.gov/vuln/detail/CVE-2025-22058
    reference_type:
    reference_id: CVE-2025-22058
